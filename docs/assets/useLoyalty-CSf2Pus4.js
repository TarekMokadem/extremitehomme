import{c as h,a as g,r as m,s as l}from"./index-CmA_YBSG.js";const E=h("map-pin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);const $=h("user-plus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),p=12,y=m(null),r=m([]),f=m(!1),v=()=>{r.value=Array.from({length:p},(a,t)=>({position:t+1,isStamped:!1,date:null,transactionId:null,markedForRemoval:!1}))},_=async a=>{y.value=a,f.value=!0;try{const{data:t,error:n}=await l.from("loyalty_transactions").select("*").eq("client_id",a).eq("type","earned").order("created_at",{ascending:!1}).limit(p);if(n)throw n;const e=t||[];r.value=Array.from({length:p},(s,i)=>{const c=e[i];return{position:i+1,isStamped:!!c,date:c?.created_at||null,transactionId:c?.id||null,markedForRemoval:!1}})}catch(t){console.error("Erreur chargement points:",t),r.value.length===0&&v()}finally{f.value=!1}},k=a=>{const t=r.value.find(n=>n.position===a);t&&(t.date?t.markedForRemoval=!t.markedForRemoval:(t.isStamped=!t.isStamped,t.isStamped||(t.date=null)))},w=g(()=>r.value.filter(a=>a.isStamped).length),q=g(()=>w.value===p),C=async(a,t)=>{const n=r.value.filter(e=>e.isStamped&&!e.date);if(n.length===0)return{success:!1,count:0};try{const e=n.map(u=>({client_id:a,vendor_id:t,sale_id:null,points:1,type:"earned",notes:`Point ${u.position}/${p} (manuel)`})),{data:s,error:i}=await l.from("loyalty_transactions").insert(e).select("id, created_at");if(i)throw i;if(s&&s.length>0){let u=0;r.value=r.value.map(o=>{if(o.isStamped&&!o.date&&s[u]){const d=s[u];return u+=1,{...o,date:d.created_at,transactionId:d.id,markedForRemoval:!1}}return o})}const{data:c}=await l.from("clients").select("loyalty_points").eq("id",a).single();return c&&await l.from("clients").update({loyalty_points:c.loyalty_points+n.length}).eq("id",a),console.log(`✅ ${n.length} point(s) fidélité ajouté(s) manuellement`),{success:!0,count:n.length}}catch(e){return console.error("Erreur ajout manuel points:",e),{success:!1,count:0}}},x=async a=>{const t=r.value.filter(n=>n.markedForRemoval&&n.transactionId);if(t.length===0)return{success:!1,count:0};try{for(const e of t)e.transactionId&&await l.from("loyalty_transactions").delete().eq("id",e.transactionId);const{data:n}=await l.from("clients").select("loyalty_points").eq("id",a).single();if(n){const e=Math.max(0,n.loyalty_points-t.length);await l.from("clients").update({loyalty_points:e}).eq("id",a)}return r.value=r.value.map(e=>e.markedForRemoval?{position:e.position,isStamped:!1,date:null,transactionId:null,markedForRemoval:!1}:e),console.log(`✅ ${t.length} point(s) fidélité retiré(s)`),{success:!0,count:t.length}}catch(n){return console.error("Erreur retrait manuel points:",n),{success:!1,count:0}}},R=async(a,t,n)=>{const e=r.value.filter(s=>s.isStamped&&!s.date);if(e.length!==0)try{const s=e.map(o=>({client_id:a,vendor_id:t,sale_id:n,points:1,type:"earned",notes:`Point ${o.position}/${p}`})),{data:i,error:c}=await l.from("loyalty_transactions").insert(s).select("created_at");if(c)throw c;if(i&&i.length>0){let o=0;r.value=r.value.map(d=>{if(d.isStamped&&!d.date&&i[o]){const S=i[o].created_at;return o+=1,{...d,date:S}}return d})}const{data:u}=await l.from("clients").select("loyalty_points").eq("id",a).single();if(u){const{error:o}=await l.from("clients").update({loyalty_points:u.loyalty_points+e.length}).eq("id",a);o&&console.warn("Erreur mise à jour points client:",o)}console.log(`✅ ${e.length} point(s) de fidélité attribué(s)`)}catch(s){console.error("Erreur sauvegarde points:",s)}},F=()=>{y.value=null,v()},M=async a=>{try{const{error:t}=await l.from("clients").update({loyalty_points:0}).eq("id",a);if(t)throw t;await _(a)}catch(t){throw console.error("Erreur réinitialisation points:",t),t}};function j(){return{stamps:r,selectedClientId:y,isLoading:f,checkedCount:w,isCardComplete:q,stampsCount:p,initializeCard:v,loadClientStamps:_,toggleStamp:k,addPointsManually:C,removePointsManually:x,saveStamps:R,clearStamps:F,resetPointsToZero:M}}export{E as M,$ as U,j as u};
