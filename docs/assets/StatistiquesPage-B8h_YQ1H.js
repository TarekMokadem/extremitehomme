import{l as G,d as lt,a as x,m as O,o as it,c as n,e as t,f as h,y as V,g,F as $,h as B,E as ct,A as N,z as j,C as P,t as r,Q as ut,U as gt,x as F,s as y,R as z,j as mt,k as o}from"./index-DpJ3Ann9.js";import{R as J}from"./refresh-cw-DaqxTwSR.js";import{T as U}from"./trending-up-AjU_m5BB.js";import{S as xt}from"./shopping-bag-DOM1ey1u.js";import{A as yt}from"./award-CKVZET5F.js";import{C as ht}from"./clock-U4KDUolF.js";const _t=G("external-link",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);const W=G("trending-down",[["path",{d:"M16 17h6v-6",key:"t6n2it"}],["path",{d:"m22 17-8.5-8.5-5 5L2 7",key:"x473p"}]]),pt={class:"flex-1 p-4 lg:p-6 overflow-auto bg-gray-50 dark:bg-gray-900"},ft={class:"max-w-7xl mx-auto space-y-6"},bt={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"},kt=["disabled"],vt={key:0,class:"flex items-center justify-center py-20"},wt={class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"},St={class:"bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-sm border border-gray-200 dark:border-gray-700"},Tt={class:"flex items-center justify-between mb-3"},Dt={class:"w-10 h-10 rounded-xl bg-emerald-100 dark:bg-emerald-900/40 flex items-center justify-center"},$t={class:"text-2xl font-bold text-gray-900 dark:text-white"},jt={class:"bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-sm border border-gray-200 dark:border-gray-700"},Ct={class:"flex items-center justify-between mb-3"},qt={class:"w-10 h-10 rounded-xl bg-blue-100 dark:bg-blue-900/40 flex items-center justify-center"},It={class:"text-2xl font-bold text-gray-900 dark:text-white"},At={class:"bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-sm border border-gray-200 dark:border-gray-700"},Mt={class:"flex items-center justify-between mb-3"},Ot={class:"w-10 h-10 rounded-xl bg-purple-100 dark:bg-purple-900/40 flex items-center justify-center"},Vt={class:"text-2xl font-bold text-gray-900 dark:text-white"},Ft={class:"bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-sm border border-gray-200 dark:border-gray-700"},Lt={class:"flex items-center justify-between mb-3"},Rt={class:"w-10 h-10 rounded-xl bg-amber-100 dark:bg-amber-900/40 flex items-center justify-center"},Bt={class:"text-2xl font-bold text-gray-900 dark:text-white"},zt={class:"grid grid-cols-1 lg:grid-cols-2 gap-6"},Et={class:"bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-sm border border-gray-200 dark:border-gray-700"},Nt={class:"space-y-3"},Pt={class:"w-16 text-xs text-gray-500 dark:text-gray-400 shrink-0"},Jt={class:"flex-1 h-8 bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden relative"},Ut={key:0,class:"absolute right-2 top-1/2 -translate-y-1/2 text-xs font-semibold text-gray-700 dark:text-gray-200"},Wt={class:"w-12 text-xs text-gray-400 dark:text-gray-500 text-right shrink-0"},Gt={class:"bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-sm border border-gray-200 dark:border-gray-700"},Ht={class:"text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wider mb-4 flex items-center gap-2"},Qt={key:0,class:"text-center py-8 text-gray-500 dark:text-gray-400"},Kt={key:1,class:"space-y-3"},Xt={class:"flex-1 min-w-0"},Yt={class:"text-sm font-medium text-gray-900 dark:text-white truncate"},Zt={class:"h-2 bg-gray-100 dark:bg-gray-700 rounded-full mt-1 overflow-hidden"},te={class:"text-right shrink-0"},ee={class:"text-sm font-bold text-gray-900 dark:text-white"},ae={class:"text-xs text-gray-500 dark:text-gray-400"},se={class:"bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-sm border border-gray-200 dark:border-gray-700"},re={key:0,class:"text-center py-8 text-gray-500 dark:text-gray-400"},oe={key:1,class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"},ne=["onClick"],de={class:"flex-1 min-w-0"},le={class:"font-semibold text-gray-900 dark:text-white truncate flex items-center gap-1"},ie={class:"text-sm text-gray-500 dark:text-gray-400"},ce={class:"text-right shrink-0"},ue={class:"text-lg font-bold text-gray-900 dark:text-white"},ge={class:"bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden"},me={class:"p-5 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between"},xe={class:"text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wider flex items-center gap-2"},ye={class:"text-sm text-gray-500 dark:text-gray-400"},he={key:0,class:"p-8 text-center text-gray-500 dark:text-gray-400"},_e={key:1,class:"divide-y divide-gray-100 dark:divide-gray-700 max-h-96 overflow-y-auto"},pe={class:"w-14 text-center shrink-0"},fe={class:"text-sm font-semibold text-gray-900 dark:text-white"},be={class:"flex-1 min-w-0"},ke={class:"text-sm font-medium text-gray-900 dark:text-white truncate"},ve={class:"text-xs text-gray-500 dark:text-gray-400"},we={class:"text-lg font-bold text-gray-900 dark:text-white shrink-0"},Ie=lt({__name:"StatistiquesPage",setup(Se){const H=mt(),k=x(!0),v=x({total:0,count:0,avgTicket:0}),L=x({total:0,count:0,avgTicket:0}),Q=x({total:0,count:0,avgTicket:0}),C=x(0),q=x(0),R=x([]),w=x([]),I=x([]),S=x([]),A=O(()=>C.value===0?0:(v.value.total-C.value)/C.value*100),M=O(()=>q.value===0?0:(L.value.total-q.value)/q.value*100),K=O(()=>Math.max(...R.value.map(a=>a.total),1)),X=O(()=>Math.max(...w.value.map(a=>a.count),1)),E=async()=>{k.value=!0;try{const a=new Date,s=a.toISOString().split("T")[0],e=new Date(a.getTime()-1440*60*1e3).toISOString().split("T")[0],d=new Date(a.getTime()-10080*60*1e3).toISOString().split("T")[0],u=new Date(a.getTime()-336*60*60*1e3).toISOString().split("T")[0],T=new Date(a.getTime()-720*60*60*1e3).toISOString().split("T")[0],{data:l}=await y.from("sales").select("total").gte("created_at",`${s}T00:00:00`).eq("status","completed"),m=l||[];v.value={total:m.reduce((i,c)=>i+c.total,0),count:m.length,avgTicket:m.length>0?m.reduce((i,c)=>i+c.total,0)/m.length:0};const{data:b}=await y.from("sales").select("total").gte("created_at",`${e}T00:00:00`).lt("created_at",`${s}T00:00:00`).eq("status","completed");C.value=(b||[]).reduce((i,c)=>i+c.total,0);const{data:_}=await y.from("sales").select("total").gte("created_at",`${d}T00:00:00`).eq("status","completed"),p=_||[];L.value={total:p.reduce((i,c)=>i+c.total,0),count:p.length,avgTicket:p.length>0?p.reduce((i,c)=>i+c.total,0)/p.length:0};const{data:nt}=await y.from("sales").select("total").gte("created_at",`${u}T00:00:00`).lt("created_at",`${d}T00:00:00`).eq("status","completed");q.value=(nt||[]).reduce((i,c)=>i+c.total,0);const{data:dt}=await y.from("sales").select("total").gte("created_at",`${T}T00:00:00`).eq("status","completed"),D=dt||[];Q.value={total:D.reduce((i,c)=>i+c.total,0),count:D.length,avgTicket:D.length>0?D.reduce((i,c)=>i+c.total,0)/D.length:0},await Y(),await Z(),await tt(),await at()}catch(a){console.error("Erreur chargement stats:",a)}finally{k.value=!1}},Y=async()=>{const a=[],s=new Date;for(let e=6;e>=0;e--){const d=new Date(s.getTime()-e*24*60*60*1e3),u=d.toISOString().split("T")[0],T=new Date(d.getTime()+1440*60*1e3).toISOString().split("T")[0],{data:l}=await y.from("sales").select("total").gte("created_at",`${u}T00:00:00`).lt("created_at",`${T}T00:00:00`).eq("status","completed"),m=l||[];a.push({date:u,total:m.reduce((b,_)=>b+_.total,0),count:m.length})}R.value=a},Z=async()=>{const{data:a}=await y.from("sale_items").select("product_name, quantity, subtotal_ttc");if(!a){w.value=[];return}const s=new Map;for(const e of a){const d=s.get(e.product_name);d?(d.count+=e.quantity,d.revenue+=e.subtotal_ttc):s.set(e.product_name,{name:e.product_name,count:e.quantity,revenue:e.subtotal_ttc})}w.value=Array.from(s.values()).sort((e,d)=>d.count-e.count).slice(0,5)},tt=async()=>{const{data:a}=await y.from("vendors").select("id, first_name, last_name, initials, color").eq("is_active",!0);if(!a){I.value=[];return}const s=new Date,e=new Date(s.getTime()-720*60*60*1e3).toISOString().split("T")[0],{data:d}=await y.from("sales").select(`
      id,
      items:sale_items(subtotal_ttc, vendor_id)
    `).gte("created_at",`${e}T00:00:00`).eq("status","completed"),u=new Map;for(const l of d||[]){const m=l.items||[];for(const b of m){const _=b.vendor_id;if(!_)continue;u.has(_)||u.set(_,{total:0,saleIds:new Set});const p=u.get(_);p.total+=b.subtotal_ttc??0,p.saleIds.add(l.id)}}const T=a.map(l=>({id:l.id,name:`${l.first_name} ${l.last_name}`,initials:l.initials??"",color:l.color??"#6B7280",total:u.get(l.id)?.total??0,count:u.get(l.id)?.saleIds.size??0}));I.value=T.sort((l,m)=>m.total-l.total)},et=a=>{const s=a.items||[],e=new Set;for(const d of s){const u=d.vendor;u&&e.add(`${u.first_name} ${u.last_name}`.trim())}return e.size>0?[...e].join(", "):a.vendor?`${a.vendor.first_name} ${a.vendor.last_name}`.trim():"—"},at=async()=>{const a=new Date().toISOString().split("T")[0],{data:s}=await y.from("sales").select(`
      id,
      ticket_number,
      total,
      created_at,
      client:clients(first_name, last_name),
      vendor:vendors(first_name, last_name),
      items:sale_items(id, vendor:vendors(first_name, last_name))
    `).gte("created_at",`${a}T00:00:00`).eq("status","completed").order("created_at",{ascending:!1});if(!s){S.value=[];return}S.value=s.map(e=>({id:e.id,ticket_number:e.ticket_number,total:e.total,created_at:e.created_at,client_name:e.client?`${e.client.first_name} ${e.client.last_name}`:null,vendor_name:et(e),items_count:e.items?.length||0}))},f=a=>a.toFixed(2),st=a=>new Date(a).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric"}),rt=a=>new Date(a).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),ot=a=>new Date(a).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"});return it(E),(a,s)=>(o(),n("main",pt,[t("div",ft,[t("div",bt,[s[1]||(s[1]=t("div",null,[t("h1",{class:"text-xl lg:text-2xl font-bold text-gray-900 dark:text-white"},"Statistiques"),t("p",{class:"text-sm text-gray-500 dark:text-gray-400 mt-1"},"Vue d'ensemble de l'activité")],-1)),t("button",{onClick:E,disabled:k.value,class:"inline-flex items-center gap-2 px-4 py-2 bg-gray-900 dark:bg-emerald-600 dark:hover:bg-emerald-500 text-white rounded-xl hover:bg-gray-800 transition-colors disabled:opacity-50"},[h(g(J),{class:V(["w-4 h-4",k.value&&"animate-spin"])},null,8,["class"]),s[0]||(s[0]=t("span",null,"Actualiser",-1))],8,kt)]),k.value?(o(),n("div",vt,[h(g(J),{class:"w-8 h-8 text-gray-400 animate-spin"})])):(o(),n($,{key:1},[t("div",wt,[t("div",St,[t("div",Tt,[t("div",Dt,[h(g(ct),{class:"w-5 h-5 text-emerald-600 dark:text-emerald-400"})]),A.value!==0?(o(),n("div",{key:0,class:V(["inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",A.value>0?"bg-emerald-100 text-emerald-700":"bg-red-100 text-red-700"])},[(o(),N(P(A.value>0?g(U):g(W)),{class:"w-3 h-3"})),j(" "+r(Math.abs(A.value).toFixed(0))+"% ",1)],2)):B("",!0)]),t("p",$t,r(f(v.value.total))+"€",1),s[2]||(s[2]=t("p",{class:"text-sm text-gray-500 dark:text-gray-400 mt-1"},"CA aujourd'hui",-1))]),t("div",jt,[t("div",Ct,[t("div",qt,[h(g(ut),{class:"w-5 h-5 text-blue-600 dark:text-blue-400"})]),M.value!==0?(o(),n("div",{key:0,class:V(["inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",M.value>0?"bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300":"bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300"])},[(o(),N(P(M.value>0?g(U):g(W)),{class:"w-3 h-3"})),j(" "+r(Math.abs(M.value).toFixed(0))+"% ",1)],2)):B("",!0)]),t("p",It,r(f(L.value.total))+"€",1),s[3]||(s[3]=t("p",{class:"text-sm text-gray-500 dark:text-gray-400 mt-1"},"CA cette semaine",-1))]),t("div",At,[t("div",Mt,[t("div",Ot,[h(g(xt),{class:"w-5 h-5 text-purple-600 dark:text-purple-400"})])]),t("p",Vt,r(v.value.count),1),s[4]||(s[4]=t("p",{class:"text-sm text-gray-500 dark:text-gray-400 mt-1"},"Ventes aujourd'hui",-1))]),t("div",Ft,[t("div",Lt,[t("div",Rt,[h(g(gt),{class:"w-5 h-5 text-amber-600 dark:text-amber-400"})])]),t("p",Bt,r(f(v.value.avgTicket))+"€",1),s[5]||(s[5]=t("p",{class:"text-sm text-gray-500 dark:text-gray-400 mt-1"},"Panier moyen",-1))])]),t("div",zt,[t("div",Et,[s[6]||(s[6]=t("h3",{class:"text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wider mb-4"}," Chiffre d'affaires (7 derniers jours) ",-1)),t("div",Nt,[(o(!0),n($,null,F(R.value,e=>(o(),n("div",{key:e.date,class:"flex items-center gap-3"},[t("span",Pt,r(st(e.date)),1),t("div",Jt,[t("div",{class:"h-full bg-gradient-to-r from-emerald-500 to-emerald-400 dark:from-emerald-600 dark:to-emerald-500 rounded-lg transition-all duration-500",style:z({width:`${e.total/K.value*100}%`})},null,4),e.total>0?(o(),n("span",Ut,r(f(e.total))+"€ ",1)):B("",!0)]),t("span",Wt,r(e.count)+" v.",1)]))),128))])]),t("div",Gt,[t("h3",Ht,[h(g(yt),{class:"w-4 h-4 text-amber-500 dark:text-amber-400"}),s[7]||(s[7]=j(" Top 5 Services ",-1))]),w.value.length===0?(o(),n("div",Qt," Aucune donnée ")):(o(),n("div",Kt,[(o(!0),n($,null,F(w.value,(e,d)=>(o(),n("div",{key:e.name,class:"flex items-center gap-3"},[t("span",{class:V(["w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold",d===0?"bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300":"bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400"])},r(d+1),3),t("div",Xt,[t("p",Yt,r(e.name),1),t("div",Zt,[t("div",{class:"h-full bg-gradient-to-r from-purple-500 to-purple-400 dark:from-purple-600 dark:to-purple-500 rounded-full",style:z({width:`${e.count/X.value*100}%`})},null,4)])]),t("div",te,[t("p",ee,r(e.count),1),t("p",ae,r(f(e.revenue))+"€",1)])]))),128))]))])]),t("div",se,[s[8]||(s[8]=t("h3",{class:"text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wider mb-4"}," Performance vendeurs (30 derniers jours) ",-1)),I.value.length===0?(o(),n("div",re," Aucune donnée ")):(o(),n("div",oe,[(o(!0),n($,null,F(I.value,e=>(o(),n("button",{key:e.id,onClick:d=>g(H).push({name:"stats-employe",query:{vendorId:e.id}}),class:"flex items-center gap-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors text-left group cursor-pointer"},[t("div",{style:z({backgroundColor:e.color}),class:"w-12 h-12 rounded-full flex items-center justify-center text-white font-bold shrink-0"},r(e.initials),5),t("div",de,[t("p",le,[j(r(e.name)+" ",1),h(g(_t),{class:"w-3.5 h-3.5 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity shrink-0"})]),t("p",ie,r(e.count)+" ventes",1)]),t("div",ce,[t("p",ue,r(f(e.total))+"€",1)])],8,ne))),128))]))]),t("div",ge,[t("div",me,[t("h3",xe,[h(g(ht),{class:"w-4 h-4 dark:text-gray-400"}),j(" Journal des ventes — "+r(ot(new Date().toISOString())),1)]),t("span",ye,r(S.value.length)+" ventes",1)]),S.value.length===0?(o(),n("div",he," Aucune vente aujourd'hui ")):(o(),n("div",_e,[(o(!0),n($,null,F(S.value,e=>(o(),n("div",{key:e.id,class:"px-5 py-3 flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"},[t("div",pe,[t("p",fe,r(rt(e.created_at)),1)]),t("div",be,[t("p",ke,r(e.client_name||"Client anonyme"),1),t("p",ve,r(e.ticket_number)+" · "+r(e.items_count)+" article(s) · "+r(e.vendor_name),1)]),t("p",we,r(f(e.total))+"€",1)]))),128))]))])],64))])]))}});export{Ie as default};
