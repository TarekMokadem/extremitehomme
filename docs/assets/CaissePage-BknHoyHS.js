import{c as $e,a as B,r as T,s as A,i as Re,d as xe,u as ot,b as De,w as we,e as c,f as e,t as y,g as r,F as ae,h as re,n as O,j as w,E as mt,k as H,l as le,m as ue,o as pt,p as Ae,q as n,v as Ie,T as Me,x as gt,P as We,y as ye,z as ve,A as lt,B as yt,C as vt,H as xt,L as ht}from"./index-CmA_YBSG.js";import{u as Je,U as et,M as bt}from"./useLoyalty-CSf2Pus4.js";import{u as ft,P as kt,I as tt,S as _t,f as at,a as ze}from"./formatInputs-DuyiF5-v.js";import{P as wt}from"./printer-Cpz3rRt9.js";import{M as $t}from"./mail-COhNS3v6.js";import{B as Ct,S as St,G as nt,H as Tt,W as Pt}from"./wrench-D1k6-mMT.js";import{C as rt}from"./credit-card-D1mVmzVu.js";import{M as it,C as Et}from"./minus-DzgkH0RU.js";import{P as Ye}from"./plus-q9enHHfU.js";import{T as dt}from"./trash-2-BBgEXiMF.js";import{C as It}from"./clock-CmKNHITB.js";import{_ as Mt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{X as Nt}from"./x--m-Ig4-I.js";import{S as jt}from"./shopping-bag-D2AE6vFK.js";import{S as Fe}from"./search-C2jF4lHe.js";import{S as qt}from"./shopping-cart-TQbJuF1Z.js";const Rt=$e("barcode",[["path",{d:"M3 5v14",key:"1nt18q"}],["path",{d:"M8 5v14",key:"1ybrkv"}],["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"M17 5v14",key:"ycjyhj"}],["path",{d:"M21 5v14",key:"nzette"}]]);const Ze=$e("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);const ct=$e("rotate-ccw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);const At=$e("user-pen",[["path",{d:"M11.5 15H7a4 4 0 0 0-4 4v2",key:"15lzij"}],["path",{d:"M21.378 16.626a1 1 0 0 0-3.004-3.004l-4.01 4.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z",key:"1817ys"}],["circle",{cx:"10",cy:"7",r:"4",key:"e45bow"}]]);const Ft=$e("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);const Dt=$e("zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);async function ut($){const l=new TextEncoder().encode($),x=await crypto.subtle.digest("SHA-256",l);return Array.from(new Uint8Array(x)).map(I=>I.toString(16).padStart(2,"0")).join("")}async function Vt($,l,x,F){const I=[$,l,x.toFixed(2),F??""].join("|");return ut(I)}async function st($,l,x,F,I){const k=[$,l,x,F??"",I??""].join("|");return ut(k)}const te=T([]),Te=T("euro"),de=T(0),_e=T(null),oe=T([]),Be=T([]),He=T(!1),ge=T(null),Lt=.2;function Ve(){const $=(t,a,o)=>{if(t.type!=="product")return 1/0;const R=te.value.filter(X=>X.product.id===t.id&&X.lineId!==a&&(X.stockCategory??"sale")===(o??"sale")).reduce((X,be)=>X+be.quantity,0),se=o==="technical"?t.stock_technical??0:t.stock??0;return Math.max(0,se-R)},l=(t,a=1,o,R="sale")=>{const se=$(t,void 0,R),X=t.type==="product"?Math.min(a,se):a;if(X<=0)return;const fe={lineId:`line-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,product:t,quantity:X,vendor_id:o?.id,vendor:o,stockCategory:R,price_ht:t.price_ht,tva_rate:t.tva_rate||Lt,subtotal_ht:0,tva:0,subtotal_ttc:0};x(fe),te.value.push(fe)},x=t=>{const a=t.fixedPriceTTC??t.product.price_ttc;t.subtotal_ttc=a*t.quantity;const o=1+t.tva_rate;t.subtotal_ht=t.subtotal_ttc/o,t.tva=t.subtotal_ttc-t.subtotal_ht,t.price_ht=t.subtotal_ht/t.quantity},F=t=>te.value.find(a=>a.lineId===t),I=(t,a)=>{const o=F(t);o&&(a==null||a<0?delete o.fixedPriceTTC:o.fixedPriceTTC=a,x(o))},k=(t,a)=>{const o=F(t);if(o)if(a<=0)L(t);else{const R=o.product.type==="product"?$(o.product,t)+o.quantity:a;o.quantity=Math.min(a,R),x(o)}},L=t=>{te.value=te.value.filter(a=>a.lineId!==t)},K=()=>{te.value=[],de.value=0,_e.value=null,oe.value=[]},S=B(()=>te.value.reduce((t,a)=>t+a.subtotal_ht,0)),s=B(()=>te.value.reduce((t,a)=>t+a.tva,0)),g=B(()=>S.value+s.value),_=B(()=>{if(de.value<=0)return 0;if(Te.value==="euro")return Math.min(de.value,g.value);{const t=Math.min(de.value,100);return g.value*t/100}}),C=B(()=>_e.value!=null&&_e.value>=0?_e.value:Math.max(0,g.value-_.value)),j=B(()=>te.value.reduce((t,a)=>t+a.quantity,0)),q=B(()=>te.value.length===0),W=(t,a)=>{Te.value=t,de.value=Math.max(0,a)},Z=()=>{Te.value="euro",de.value=0},h=t=>{_e.value=t},v=(t,a)=>{const o=oe.value.find(R=>R.method===t);o?o.amount+=a:oe.value.push({method:t,amount:a})},p=(t,a)=>{const o=oe.value.find(R=>R.method===t);o?o.amount=a:oe.value.push({method:t,amount:a})},M=t=>{oe.value=oe.value.filter(a=>a.method!==t)},f=()=>{oe.value=[]},P=B(()=>oe.value.reduce((t,a)=>t+a.amount,0)),z=B(()=>Math.max(0,C.value-P.value)),J=B(()=>Math.max(0,P.value-C.value)),Y=B(()=>P.value>=C.value&&C.value>0),ie=()=>{const t=new Date,a=t.toISOString().split("T")[0].replace(/-/g,""),o=t.getTime().toString().slice(-4);return`T-${a}-${o}`};return{cartItems:te,discountType:Te,discountValue:de,selectedPaymentMethods:oe,recentSales:Be,isProcessing:He,error:ge,subtotalHT:S,totalTVA:s,subtotalTTC:g,discountAmount:_,total:C,itemCount:j,isEmpty:q,totalPaid:P,remainingToPay:z,change:J,isPaymentComplete:Y,addToCart:l,updateQuantity:k,removeFromCart:L,getMaxQuantityForItem:t=>t.product.type!=="product"?1/0:$(t.product,t.lineId,t.stockCategory)+t.quantity,setItemFixedPrice:I,clearCart:K,setDiscount:W,clearDiscount:Z,setFixedTotal:h,fixedTotal:_e,addPayment:v,setPayment:p,removePayment:M,clearPayments:f,validateSale:async(t,a)=>{if(q.value)return ge.value="Le panier est vide",null;if(!a)return ge.value="Veuillez sélectionner ou créer un client avant de valider",null;if(!Y.value)return ge.value="Le paiement n'est pas complet",null;if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t))return ge.value="Aucun vendeur sélectionné. Veuillez sélectionner un vendeur.",console.error("vendorId invalide:",t),null;He.value=!0,ge.value=null,console.log("Validation vente - vendorId:",t,"clientId:",a);try{if(Re()){const m=new Map;for(const Q of te.value)if(Q.product.type==="product"){const D=Q.stockCategory??"sale",ne=`${Q.product.id}|${D}`,pe=m.get(ne);pe?pe.qty+=Q.quantity:m.set(ne,{qty:Q.quantity,name:Q.product.name,stockCat:D})}for(const[Q,{qty:D,name:ne,stockCat:pe}]of m){const Ce=Q.split("|")[0],je=pe==="technical"?"stock_technical":"stock",{data:Se,error:qe}=await A.from("products").select(`${je}`).eq("id",Ce).single();if(qe||!Se)throw new Error(`Produit ${ne} introuvable`);const Xe=Se[je]??0;if(Xe<D)throw new Error(`Stock insuffisant pour "${ne}" (${pe==="technical"?"technique":"vente"}) : ${Xe} en stock, ${D} demandé`)}}let R;if(Re()){const{data:m}=await A.rpc("generate_ticket_number");R=m||ie()}const se=new Date().toISOString();let X=null;if(Re()){const{data:m}=await A.from("sales").select("hash").eq("status","completed").order("created_at",{ascending:!1}).limit(1).maybeSingle();X=m?.hash??null}const be=await Vt(R,se,C.value,X),fe={ticket_number:R,vendor_id:t,client_id:a||null,subtotal_ht:S.value,total_tva:s.value,subtotal_ttc:g.value,discount_type:Te.value,discount_value:de.value,discount_amount:_.value,total:C.value,status:"completed",hash:be,previous_hash:X,created_at:se},Le=te.value.map(m=>({product_id:m.product.id,variant_id:m.variant?.id||null,vendor_id:m.vendor_id||t,product_name:m.product.name,price_ht:m.price_ht,tva_rate:m.tva_rate,quantity:m.quantity,subtotal_ht:m.subtotal_ht,tva:m.tva,subtotal_ttc:m.subtotal_ttc})),U=oe.value.map(m=>({method:m.method,amount:m.amount}));Re();const{data:i,error:b}=await A.from("sales").insert(fe).select().single();if(b)throw b;const ee=Le.map(m=>({...m,sale_id:i.id})),{error:N}=await A.from("sale_items").insert(ee);if(N)throw N;const me=U.map(m=>({...m,sale_id:i.id})),{error:ke}=await A.from("payments").insert(me);if(ke)throw ke;for(const m of te.value)if(m.product.type==="product"){const Q=m.stockCategory??"sale",D=Q==="technical"?"stock_technical":"stock",{data:ne,error:pe}=await A.from("products").select(`${D}`).eq("id",m.product.id).single();if(pe||!ne)throw new Error(`Produit ${m.product.name} introuvable`);const Ce=ne[D]??0;if(Ce<m.quantity)throw new Error(`Stock insuffisant pour "${m.product.name}" (${Q==="technical"?"technique":"vente"}) : ${Ce} en stock, ${m.quantity} demandé`);const je=Ce-m.quantity,{error:Se}=await A.from("products").update({[D]:je,updated_at:new Date().toISOString()}).eq("id",m.product.id);if(Se)throw Se;const{error:qe}=await A.from("stock_movements").insert({product_id:m.product.id,variant_id:m.variant?.id||null,type:"out",quantity:-m.quantity,reason:Q==="technical"?"Utilisation technique":"Vente",reference_id:i.id,vendor_id:t,stock_type:Q});if(qe)throw qe}try{const{data:m}=await A.from("settings").select("value").eq("key","grand_total").maybeSingle(),D=(typeof m?.value=="number"?m.value:0)+C.value;await A.from("settings").upsert({key:"grand_total",value:D,updated_at:new Date().toISOString()},{onConflict:"key"})}catch(m){console.warn("NF525: erreur mise à jour GT —",m)}try{const{data:m}=await A.from("audit_logs").select("hash").order("created_at",{ascending:!1}).limit(1).maybeSingle(),Q=new Date().toISOString(),D=await st(Q,"sale_created","sales",i.id,m?.hash??null);await A.from("audit_logs").insert({timestamp:Q,event_type:"sale_created",table_name:"sales",record_id:i.id,old_data:null,new_data:{ticket_number:R,total:C.value},vendor_id:t,hash:D,previous_hash:m?.hash??null})}catch(m){console.warn("NF525: erreur audit log —",m)}if(a){const{data:m}=await A.from("clients").select("visit_count, total_spent, loyalty_points").eq("id",a).single();m&&await A.from("clients").update({visit_count:m.visit_count+1,total_spent:m.total_spent+C.value,last_visit_at:new Date().toISOString()}).eq("id",a)}return Be.value.unshift(i),K(),i}catch(R){return console.error("Erreur validation vente:",R),ge.value=R.message||"Erreur lors de la validation",null}finally{He.value=!1}},loadRecentSales:async(t=10)=>{try{const{data:a,error:o}=await A.from("sales").select(`
          *,
          vendor:vendors(*),
          client:clients(*),
          items:sale_items(*),
          payments(*)
        `).order("created_at",{ascending:!1}).limit(t);if(o)throw o;return Be.value=a||[],a}catch(a){return console.error("Erreur chargement ventes:",a),[]}},getSaleById:async t=>{try{const{data:a,error:o}=await A.from("sales").select(`
          *,
          vendor:vendors(*),
          client:clients(*),
          items:sale_items(*, product:products(*)),
          payments(*)
        `).eq("id",t).single();return o?null:a}catch{return null}},cancelSale:async(t,a)=>{try{const{error:o}=await A.from("sales").update({status:"cancelled",notes:a}).eq("id",t);if(o)throw o;try{const{data:R}=await A.from("audit_logs").select("hash").order("created_at",{ascending:!1}).limit(1).maybeSingle(),se=new Date().toISOString(),X=await st(se,"sale_cancelled","sales",t,R?.hash??null);await A.from("audit_logs").insert({timestamp:se,event_type:"sale_cancelled",table_name:"sales",record_id:t,old_data:{status:"completed"},new_data:{status:"cancelled",reason:a},vendor_id:null,hash:X,previous_hash:R?.hash??null})}catch(R){console.warn("NF525: erreur audit annulation —",R)}return!0}catch(o){return console.error("Erreur annulation vente:",o),!1}}}}const zt=[{id:"1",first_name:"Jean",last_name:"Dupont",phone:"06 12 34 56 78",phone2:null,email:"jean.dupont@email.com",address:"123 Rue de la Paix",city:"Paris",postal_code:"75001",birth_date:"1985-03-15",notes:"Client fidèle",company:null,loyalty_points:150,total_spent:450,visit_count:15,last_visit_at:"2026-01-15",created_at:"",updated_at:""},{id:"2",first_name:"Marie",last_name:"Martin",phone:"06 98 76 54 32",phone2:"01 23 45 67 89",email:"marie.martin@email.com",address:"456 Avenue des Champs",city:"Lyon",postal_code:"69001",birth_date:"1990-07-22",notes:null,company:null,loyalty_points:75,total_spent:225,visit_count:8,last_visit_at:"2026-01-20",created_at:"",updated_at:""},{id:"3",first_name:"Pierre",last_name:"Bernard",phone:"07 11 22 33 44",phone2:null,email:null,address:null,city:null,postal_code:null,birth_date:null,notes:"Préfère les rendez-vous le samedi",company:null,loyalty_points:30,total_spent:90,visit_count:3,last_visit_at:"2026-01-10",created_at:"",updated_at:""}],Ue=T([]),Oe=T(null),Ke=T(!1),Ge=T(!1),Pe=T(null);function Ne(){return{clients:Ue,selectedClient:Oe,invoiceInCompanyName:Ke,isLoading:Ge,error:Pe,loadClients:async()=>{Ge.value=!0,Pe.value=null;try{const{data:s,error:g}=await A.from("clients").select("*").order("last_name");if(g)throw g;Ue.value=s||[]}catch(s){console.error("Erreur chargement clients:",s),Pe.value=s.message,Ue.value=zt}finally{Ge.value=!1}},searchClients:async s=>{if(!s||s.length<2)return[];try{const{data:g,error:_}=await A.from("clients").select("*").or(`first_name.ilike.%${s}%,last_name.ilike.%${s}%,phone.ilike.%${s}%`).limit(10);if(_)throw _;return g||[]}catch(g){return console.error("Erreur recherche clients:",g),[]}},getClientById:async s=>{try{const{data:g,error:_}=await A.from("clients").select("*").eq("id",s).single();return _?null:g}catch{return null}},createClient:async s=>{console.log("createClient appelé avec:",s);try{console.log("Insertion dans Supabase...");const{data:g,error:_}=await A.from("clients").insert({first_name:s.first_name,last_name:s.last_name,phone:s.phone,phone2:s.phone2||null,email:s.email||null,address:s.address||null,city:s.city||null,postal_code:s.postal_code||null,birth_date:s.birth_date||null,notes:s.notes||null,company:s.company??null}).select().single();if(_)throw console.error("Erreur Supabase:",_),_;return console.log("Client créé avec succès:",g),g}catch(g){return console.error("Erreur création client:",g),Pe.value=g.message,null}},updateClient:async(s,g)=>{console.log("updateClient appelé avec:",s,g);try{const{data:_,error:C}=await A.from("clients").update(g).eq("id",s).select().single();if(C)throw C;return console.log("Client mis à jour:",_),_}catch(_){return console.error("Erreur mise à jour client:",_),Pe.value=_.message,null}},selectClient:s=>{Oe.value=s},setInvoiceInCompanyName:s=>{Ke.value=s},clearSelection:()=>{Oe.value=null,Ke.value=!1},updateClientAfterSale:async(s,g)=>{try{const{data:_}=await A.from("clients").select("visit_count, total_spent").eq("id",s).single();_&&await A.from("clients").update({visit_count:_.visit_count+1,total_spent:_.total_spent+g,last_visit_at:new Date().toISOString()}).eq("id",s)}catch(_){console.error("Erreur mise à jour client après vente:",_)}}}}function Qe($){return $.toFixed(2).replace(".",",")}function Bt($){const{header:l,dateTime:x,items:F,total:I,discount:k,footer:L}=$,K=F.map(s=>`
    <div class="receipt-line">
      <span class="receipt-item">${ce(s.vendorName?`${s.vendorName} `:"")}${ce(s.label)}</span>
      <span class="receipt-price">${Qe(s.amount)}</span>
    </div>`).join(""),S=k!=null&&k>0?`
    <div class="receipt-line receipt-total">
      <span class="receipt-item">Gratuit / Réduction</span>
      <span class="receipt-price">-${Qe(k)}</span>
    </div>`:"";return`
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ticket</title>
  <style>
    @page { size: 80mm 297mm; margin: 0; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
      line-height: 1.3;
      width: 80mm;
      max-width: 80mm;
      padding: 4mm;
      color: #000;
      background: #fff;
    }
    .receipt-header { text-align: center; margin-bottom: 6px; }
    .receipt-header .name { font-weight: bold; font-size: 14px; }
    .receipt-header .address, .receipt-header .phone { font-size: 11px; }
    .receipt-date { margin-bottom: 6px; font-size: 11px; }
    .receipt-line {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 2px;
      font-size: 11px;
    }
    .receipt-item { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .receipt-price { flex-shrink: 0; text-align: right; }
    .receipt-total { font-weight: bold; margin-top: 4px; padding-top: 4px; border-top: 1px dashed #000; }
    .receipt-footer { text-align: center; margin-top: 8px; font-size: 11px; }
  </style>
</head>
<body>
  <div class="receipt-header">
    <div class="name">${ce(l.name)}</div>
    ${l.address?`<div class="address">${ce(l.address)}</div>`:""}
    ${l.city?`<div class="address">${ce(l.city)}</div>`:""}
    ${l.phone?`<div class="phone">${ce(l.phone)}</div>`:""}
  </div>
  <div class="receipt-date">${ce(x)}</div>
  ${K}
  ${S}
  <div class="receipt-line receipt-total">
    <span class="receipt-item">TOTAL</span>
    <span class="receipt-price">${Qe(I)} €</span>
  </div>
  ${L?`<div class="receipt-footer">${ce(L)}</div>`:'<div class="receipt-footer">Merci de votre visite</div>'}
</body>
</html>`}function ce($){const l=document.createElement("div");return l.textContent=$,l.innerHTML}function Ht($){const l=Bt($),x=window.open("","_blank","width=400,height=600");if(!x){alert("Autorisez les pop-ups pour imprimer le ticket.");return}x.document.write(l),x.document.close(),x.focus(),setTimeout(()=>{x.print(),x.close()},250)}const Ut={class:"card h-full flex flex-col overflow-hidden"},Ot={class:"px-3 py-2 md:px-4 md:py-2.5 border-b border-gray-200 bg-gray-50 dark:bg-gray-800 dark:border-gray-700"},Kt={class:"flex items-center justify-between"},Gt={class:"text-[11px] md:text-xs font-semibold text-gray-900 dark:text-gray-100"},Qt={class:"flex-1 overflow-y-auto p-3 md:p-4 space-y-1.5 md:space-y-2 min-h-0"},Wt={class:"flex items-start justify-between gap-2 md:gap-3 mb-2 md:mb-3"},Zt={class:"flex-1 min-w-0"},Jt={class:"font-medium text-gray-900 dark:text-gray-100 line-clamp-2 text-xs md:text-sm leading-snug"},Yt={class:"flex items-center gap-1.5 mt-0.5"},Xt={key:0,class:"inline-flex px-1.5 py-0.5 rounded text-[9px] font-semibold bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300"},ea={key:1,class:"text-[10px] text-gray-500 dark:text-gray-400"},ta={class:"font-semibold text-gray-600 dark:text-gray-300"},aa={class:"font-bold text-gray-900 dark:text-gray-100 whitespace-nowrap text-sm md:text-base tabular-nums"},ra={class:"flex items-center gap-2 mb-2"},sa=["value","onInput"],oa={class:"flex items-center justify-between"},la={class:"flex items-center gap-2"},na=["onClick"],ia={class:"w-7 md:w-9 text-center text-xs md:text-sm font-semibold tabular-nums text-gray-900 dark:text-gray-100"},da=["onClick","disabled"],ca=["onClick"],ua={key:1,class:"h-full flex items-center justify-center py-8"},ma={class:"px-3 py-2 md:px-4 md:py-2.5 border-t border-gray-100 dark:border-gray-700"},pa={class:"flex flex-col gap-1.5 md:gap-2"},ga={class:"flex items-center justify-between gap-2"},ya={class:"inline-flex items-center bg-gray-100 dark:bg-gray-700 rounded-full p-0.5 shadow-inner border border-gray-200 dark:border-gray-600"},va={class:"flex items-center gap-2"},xa=["value","max"],ha={class:"text-xs md:text-sm font-medium text-gray-500 dark:text-gray-400 min-w-[24px] md:min-w-[32px] text-center"},ba={class:"px-3 py-2 md:px-4 md:py-2.5 border-t border-gray-100 dark:border-gray-700"},fa={class:"flex flex-col gap-1.5"},ka={class:"flex items-center gap-2"},_a=["value"],wa={class:"px-3 py-2 md:px-4 md:py-2.5 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800"},$a={class:"grid grid-cols-4 md:grid-cols-4 gap-1 md:gap-1.5"},Ca=["onClick"],Sa={class:"font-medium truncate"},Ta={class:"p-3 md:p-4 border-t-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"},Pa={class:"space-y-1 md:space-y-1.5 mb-2 md:mb-3"},Ea={class:"flex justify-between text-xs md:text-sm"},Ia={class:"text-gray-700 dark:text-gray-300 tabular-nums"},Ma={class:"flex justify-between text-xs md:text-sm"},Na={class:"text-gray-700 dark:text-gray-300 tabular-nums"},ja={class:"flex justify-between text-xs md:text-sm font-medium"},qa={class:"text-gray-900 dark:text-gray-100 tabular-nums"},Ra={key:0,class:"flex justify-between text-xs md:text-sm"},Aa={class:"text-gray-600 dark:text-gray-400"},Fa={class:"text-[10px] md:text-xs"},Da={class:"text-red-600 dark:text-red-400 font-medium tabular-nums"},Va={class:"flex justify-between text-xl md:text-2xl font-bold pt-2 md:pt-3 border-t border-gray-200 dark:border-gray-600"},La={class:"text-gray-900 dark:text-gray-100 tabular-nums"},za={class:"grid grid-cols-4 gap-1.5 md:gap-2"},Ba=["disabled"],Ha=["disabled"],Ua=["disabled"],Oa={key:0,class:"animate-spin"},Ka=xe({__name:"TicketPanel",setup($){const{cartItems:l,subtotalHT:x,totalTVA:F,subtotalTTC:I,total:k,discountAmount:L,fixedTotal:K,setFixedTotal:S,updateQuantity:s,removeFromCart:g,setItemFixedPrice:_,clearCart:C,setDiscount:j,setPayment:q,clearPayments:W,validateSale:Z,isProcessing:h,getMaxQuantityForItem:v,error:p}=Ve(),{vendor:M}=ot(),{selectedClient:f}=Ne(),{loadProducts:P}=De(),{saveStamps:z,loadClientStamps:J}=Je(),{salonInfo:Y,ticketHeader:ie,ticketFooter:E}=ft(),u=T("euro"),d=T(0),G=T("card"),he=[{id:"cash",label:"Espèces",icon:Ct,color:"bg-green-600 border-green-600 text-white"},{id:"card",label:"CB",icon:rt,color:"bg-blue-600 border-blue-600 text-white"},{id:"contactless",label:"Sans contact",icon:St,color:"bg-violet-600 border-violet-600 text-white"},{id:"amex",label:"American Express",icon:rt,color:"bg-red-600 border-red-600 text-white"},{id:"check",label:"Chèque",icon:pt,color:"bg-gray-600 border-gray-600 text-white"},{id:"gift_card",label:"Chèque Cadeau",icon:nt,color:"bg-yellow-500 border-yellow-500 text-black"},{id:"free",label:"Gratuit",icon:Tt,color:"bg-orange-500 border-orange-500 text-white"}],t=U=>U.toFixed(2),a=U=>{u.value=U,U==="percent"&&(d.value=Math.min(d.value,100)),j(u.value,d.value)},o=U=>{const i=U.target,b=Number(i.value);u.value==="percent"?d.value=Math.min(b,100):d.value=Math.min(b,I.value),j(u.value,d.value)},R=U=>{G.value=U,W(),q(U,k.value)};we([k,G],()=>{k.value>0&&G.value&&q(G.value,k.value)},{immediate:!0});const se=async()=>{if(l.value.length===0)return;if(!f.value){alert("Veuillez sélectionner ou créer un client avant de valider la vente.");return}q(G.value,k.value);const U=await Z(M.value?.id||"demo",f.value?.id);U?(f.value&&M.value&&(await z(f.value.id,M.value.id,U.id),await J(f.value.id)),await P(),alert(`✅ Vente validée !
Ticket: ${U.ticket_number}
Total: ${t(U.total)}€`)):p.value&&alert(`❌ Erreur : ${p.value}`)},X=B(()=>new Date().toLocaleDateString("fr-FR")),be=B(()=>u.value==="percent"?100:I.value);B(()=>I.value);const fe=()=>{if(l.value.length===0)return;const i=new Date().toLocaleDateString("fr-FR"),b=Y.value.name||"Extrémités Homme",ee=`Facture ${i} - ${b}`,N=[];N.push(b),N.push("─".repeat(30)),N.push(`Date : ${i}`),N.push(""),N.push("Articles :");for(const D of l.value){const ne=D.vendor?` (${D.vendor.initials||`${D.vendor.first_name?.[0]??""}${D.vendor.last_name?.[0]??""}`})`:"";N.push(`  ${D.product.name}${ne}`),N.push(`    ${D.quantity} x ${t(D.subtotal_ttc/D.quantity)}€ = ${t(D.subtotal_ttc)}€`)}N.push(""),N.push(`Sous-total HT : ${t(x.value)}€`),N.push(`TVA (20%) : ${t(F.value)}€`),N.push(`Sous-total TTC : ${t(I.value)}€`),L.value>0&&N.push(`Réduction : -${t(L.value)}€`),N.push("─".repeat(30)),N.push(`TOTAL : ${t(k.value)}€`),N.push("");const me=he.find(D=>D.id===G.value);N.push(`Règlement : ${me?.label||G.value}`),f.value&&(N.push(""),N.push(`Client : ${f.value.first_name} ${f.value.last_name}`)),N.push(""),N.push("Merci de votre visite !");const ke=N.join(`
`),m=f.value?.email||"",Q=`mailto:${encodeURIComponent(m)}?subject=${encodeURIComponent(ee)}&body=${encodeURIComponent(ke)}`;window.location.href=Q},Le=()=>{if(l.value.length===0)return;const U=new Date,i=U.toISOString().slice(0,10),b=U.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),ee=l.value.map(N=>{const me=N.vendor,ke=me?`${me.first_name??""} ${me.last_name??""}`.trim():void 0;return{label:N.product.name,vendorName:ke||void 0,amount:N.subtotal_ttc}});Ht({header:{name:ie.value.line1||Y.value.name,address:Y.value.address,phone:Y.value.phone},dateTime:`${i} ${b}`,items:ee,subtotal:I.value,discount:L.value>0?L.value:void 0,total:k.value,footer:E.value.line1||"Merci de votre visite"})};return(U,i)=>(n(),c("div",Ut,[e("div",Ot,[e("div",Kt,[e("div",null,[i[5]||(i[5]=e("p",{class:"text-[9px] md:text-[10px] text-gray-500 uppercase tracking-wider font-semibold dark:text-gray-400"},"Date",-1)),e("p",Gt,y(X.value),1)]),i[6]||(i[6]=e("div",{class:"text-right"},[e("p",{class:"text-[9px] md:text-[10px] text-gray-500 uppercase tracking-wider font-semibold dark:text-gray-400"},"Ticket"),e("p",{class:"text-[11px] md:text-xs font-semibold text-gray-900 dark:text-gray-100"},"#001")],-1))])]),e("div",Qt,[r(l).length>0?(n(!0),c(ae,{key:0},re(r(l),b=>(n(),c("div",{key:b.lineId,class:"cart-item"},[e("div",Wt,[e("div",Zt,[e("p",Jt,y(b.product.name),1),e("div",Yt,[b.stockCategory==="technical"?(n(),c("span",Xt,"TECH")):H("",!0),b.vendor?(n(),c("p",ea,[i[7]||(i[7]=le(" par ",-1)),e("span",ta,y(b.vendor.initials||`${b.vendor.first_name?.[0]}${b.vendor.last_name?.[0]}`),1)])):H("",!0)])]),e("p",aa,y(t(b.subtotal_ttc))+"€ ",1)]),e("div",ra,[i[8]||(i[8]=e("label",{class:"text-[10px] text-gray-500 dark:text-gray-400 shrink-0"},"Prix unit. (€)",-1)),e("input",{type:"number",value:b.fixedPriceTTC??"",onInput:ee=>{const N=ee.target.value;r(_)(b.lineId,N===""?null:Math.max(0,Number(N)))},min:"0",step:"0.01",placeholder:"Prix libre",class:"flex-1 min-w-0 px-2 py-1.5 text-[11px] bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 tabular-nums"},null,40,sa)]),e("div",oa,[e("div",la,[e("button",{onClick:ee=>r(s)(b.lineId,b.quantity-1),class:"w-8 h-8 md:w-9 md:h-9 rounded-lg bg-white border border-gray-300 flex items-center justify-center hover:bg-gray-100 hover:border-gray-400 dark:bg-gray-600 dark:border-gray-500 dark:hover:bg-gray-500 dark:text-gray-100 transition-colors","aria-label":"Diminuer la quantité"},[w(r(it),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})],8,na),e("span",ia,y(b.quantity),1),e("button",{onClick:ee=>r(s)(b.lineId,b.quantity+1),disabled:b.quantity>=r(v)(b),class:"w-8 h-8 md:w-9 md:h-9 rounded-lg bg-white border border-gray-300 flex items-center justify-center hover:bg-gray-100 hover:border-gray-400 dark:bg-gray-600 dark:border-gray-500 dark:hover:bg-gray-500 dark:text-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Augmenter la quantité"},[w(r(Ye),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})],8,da)]),e("button",{onClick:ee=>r(g)(b.lineId),class:"p-1.5 md:p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:text-red-400 dark:hover:bg-red-900/30 rounded-lg transition-colors","aria-label":"Supprimer l'article"},[w(r(dt),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})],8,ca)])]))),128)):(n(),c("div",ua,[...i[9]||(i[9]=[e("p",{class:"text-gray-400 dark:text-gray-500 text-xs md:text-sm"},"Aucun article",-1)])]))]),e("div",ma,[e("div",pa,[e("div",ga,[i[14]||(i[14]=e("label",{class:"text-[11px] md:text-xs text-gray-600 dark:text-gray-400 font-medium"},"Réduction",-1)),e("div",ya,[e("button",{onClick:i[0]||(i[0]=b=>a("euro")),class:O(["inline-flex items-center gap-0.5 md:gap-1 px-2 md:px-3 py-1 md:py-1.5 text-[10px] md:text-xs font-semibold rounded-full transition-all duration-150",u.value==="euro"?"bg-white text-gray-900 shadow-sm dark:bg-gray-600 dark:text-gray-100":"text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"])},[w(r(mt),{class:"w-3 h-3 md:w-3.5 md:h-3.5"}),i[10]||(i[10]=e("span",{class:"hidden sm:inline"},"Montant",-1)),i[11]||(i[11]=e("span",{class:"sm:hidden"},"€",-1))],2),e("button",{onClick:i[1]||(i[1]=b=>a("percent")),class:O(["inline-flex items-center gap-0.5 md:gap-1 px-2 md:px-3 py-1 md:py-1.5 text-[10px] md:text-xs font-semibold rounded-full transition-all duration-150",u.value==="percent"?"bg-white text-gray-900 shadow-sm dark:bg-gray-600 dark:text-gray-100":"text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"])},[w(r(kt),{class:"w-3 h-3 md:w-3.5 md:h-3.5"}),i[12]||(i[12]=e("span",{class:"hidden sm:inline"},"Pourcentage",-1)),i[13]||(i[13]=e("span",{class:"sm:hidden"},"%",-1))],2)])]),e("div",va,[e("input",{type:"number",value:d.value,onInput:o,min:"0",max:be.value,step:"0.01",class:"flex-1 px-3 md:px-4 py-2 md:py-2.5 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 border border-gray-300 rounded-lg text-xs md:text-sm text-right focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all tabular-nums"},null,40,xa),e("span",ha,y(u.value==="percent"?"%":"€"),1)])])]),e("div",ba,[e("div",fa,[i[15]||(i[15]=e("label",{class:"text-[11px] md:text-xs text-gray-600 dark:text-gray-400 font-medium"},"Fixer le prix total (€)",-1)),e("div",ka,[e("input",{type:"number",value:r(K)??"",onInput:i[2]||(i[2]=b=>{const ee=b.target.value;r(S)(ee===""?null:Math.max(0,Number(ee)))}),min:"0",step:"0.01",placeholder:"Prix libre",class:"flex-1 px-3 md:px-4 py-2 md:py-2.5 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-500 border border-gray-300 rounded-lg text-xs md:text-sm text-right focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 tabular-nums"},null,40,_a),r(K)!=null?(n(),c("button",{key:0,type:"button",onClick:i[3]||(i[3]=b=>r(S)(null)),class:"px-2 py-2 text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:text-red-400 dark:hover:bg-red-900/30 rounded-lg text-xs font-medium",title:"Annuler le prix fixé"}," Réinit ")):H("",!0)])])]),e("div",wa,[i[16]||(i[16]=e("p",{class:"text-[9px] md:text-[10px] text-gray-600 dark:text-gray-400 uppercase tracking-wider font-semibold mb-1.5 md:mb-2"},"Règlement",-1)),e("div",$a,[(n(),c(ae,null,re(he,b=>e("button",{key:b.id,onClick:ee=>R(b.id),class:O(["payment-btn text-[10px] md:text-xs",G.value===b.id&&b.color])},[(n(),ue(Ae(b.icon),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})),e("span",Sa,y(b.label),1)],10,Ca)),64))])]),e("div",Ta,[e("div",Pa,[e("div",Ea,[i[17]||(i[17]=e("span",{class:"text-gray-500 dark:text-gray-400"},"Sous-total HT",-1)),e("span",Ia,y(t(r(x)))+"€",1)]),e("div",Ma,[i[18]||(i[18]=e("span",{class:"text-gray-500 dark:text-gray-400"},"TVA (20%)",-1)),e("span",Na,y(t(r(F)))+"€",1)]),e("div",ja,[i[19]||(i[19]=e("span",{class:"text-gray-600 dark:text-gray-400"},"Sous-total TTC",-1)),e("span",qa,y(t(r(I)))+"€",1)]),d.value>0?(n(),c("div",Ra,[e("span",Aa,[i[20]||(i[20]=le(" Réduction ",-1)),e("span",Fa,"("+y(u.value==="percent"?`${d.value}%`:`${t(d.value)}€`)+")",1)]),e("span",Da,"-"+y(t(r(L)))+"€",1)])):H("",!0),e("div",Va,[i[21]||(i[21]=e("span",{class:"text-gray-900 dark:text-gray-100"},"Total",-1)),e("span",La,y(t(r(k)))+"€",1)])]),e("div",za,[e("button",{type:"button",onClick:Le,disabled:r(l).length===0,class:"btn-icon-sm p-2 md:p-3 disabled:opacity-50 disabled:cursor-not-allowed",title:"Imprimer le ticket","aria-label":"Imprimer le ticket"},[w(r(wt),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})],8,Ba),e("button",{type:"button",onClick:fe,disabled:r(l).length===0,class:"btn-icon-sm p-2 md:p-3 disabled:opacity-50 disabled:cursor-not-allowed",title:"Email","aria-label":"Envoyer par email"},[w(r($t),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})],8,Ha),e("button",{onClick:i[4]||(i[4]=(...b)=>r(C)&&r(C)(...b)),class:"btn-icon-sm p-2 md:p-3 text-orange-600 hover:bg-orange-50 hover:border-orange-200 dark:text-orange-400 dark:hover:bg-orange-900/30 dark:hover:border-orange-700",title:"Annuler","aria-label":"Annuler la transaction"},[w(r(ct),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})]),e("button",{onClick:se,disabled:r(l).length===0||r(h),class:O(["btn-icon-sm p-2 md:p-3",r(l).length>0&&!r(h)?"bg-emerald-600 text-white hover:bg-emerald-700 border-emerald-600 dark:bg-emerald-600 dark:border-emerald-600":"bg-gray-100 text-gray-400 cursor-not-allowed border-gray-200 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-500"]),title:"Valider","aria-label":"Valider la transaction"},[r(h)?(n(),c("span",Oa,"⏳")):(n(),ue(r(Ze),{key:1,class:"w-4 h-4 md:w-5 md:h-5"}))],10,Ua)])])]))}}),Ga=["aria-label"],Qa={class:"service-header"},Wa={class:"service-header-left"},Za={class:"service-code"},Ja=["aria-label"],Ya={class:"service-price"},Xa={class:"service-body"},er={class:"service-name"},tr={key:0,class:"service-duration"},ar={class:"hidden sm:inline"},rr={class:"sm:hidden"},sr=xe({__name:"ServiceCard",props:{service:{}},setup($){const l=$,{addToCart:x,cartItems:F}=Ve(),{getCategoryBorderColor:I}=De(),k=B(()=>{const S=F.value.find(s=>s.product.id===l.service.id);return S?S.quantity:0}),L=B(()=>I(l.service)),K=()=>{x(l.service)};return(S,s)=>(n(),c("button",{onClick:K,"aria-label":`Ajouter ${$.service.name} au panier`,class:O(["service-card",L.value,k.value>0&&"active"])},[e("div",Qa,[e("div",Wa,[e("span",Za,y($.service.code),1),k.value>0?(n(),c("span",{key:0,class:"quantity-badge","aria-label":`Quantité: ${k.value}`},y(k.value),9,Ja)):H("",!0)]),e("span",Ya,y($.service.price_ttc?.toFixed(2)||$.service.price_ht?.toFixed(2))+"€ ",1)]),e("div",Xa,[e("h3",er,y($.service.name),1),$.service.duration?(n(),c("span",tr,[w(r(It),{class:"w-3 h-3 md:w-3.5 md:h-3.5"}),e("span",ar,y($.service.duration)+"min",1),e("span",rr,y($.service.duration)+"'",1)])):H("",!0)])],10,Ga))}}),or=Mt(sr,[["__scopeId","data-v-588d3745"]]),lr={class:"card p-4"},nr={class:"flex items-center justify-between mb-3"},ir={class:"flex items-center gap-2"},dr={class:"w-8 h-8 rounded-full bg-yellow-100 dark:bg-yellow-900/40 flex items-center justify-center"},cr={class:"text-xs text-gray-500 dark:text-gray-400"},ur={class:"flex items-center gap-2"},mr=["disabled"],pr=["disabled"],gr={key:3,class:"inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-100 text-green-700 dark:bg-emerald-900/40 dark:text-emerald-300 rounded-full text-xs font-semibold"},yr={class:"grid grid-cols-6 sm:grid-cols-12 gap-2 w-full"},vr=["onClick"],xr={key:0,class:"absolute bottom-0.5 left-0 right-0 text-xs text-yellow-700 dark:text-amber-300 font-semibold leading-tight"},hr=xe({__name:"LoyaltyCard",setup($){const{stamps:l,checkedCount:x,isCardComplete:F,stampsCount:I,toggleStamp:k,addPointsManually:L,removePointsManually:K,resetPointsToZero:S,loadClientStamps:s}=Je(),{selectedClient:g}=Ne(),{vendor:_}=ot(),C=T(!1),j=B(()=>l.value.filter(p=>p.isStamped&&!p.date).length),q=B(()=>l.value.filter(p=>p.markedForRemoval).length),W=async()=>{if(!(!g.value||!_.value||j.value===0)){C.value=!0;try{const p=await L(g.value.id,_.value.id);p?.success?(await s(g.value.id),alert(`${p.count} point(s) fidélité ajouté(s)`)):alert("Erreur lors de l'ajout des points")}catch{alert("Erreur lors de l'ajout des points")}finally{C.value=!1}}},Z=async()=>{if(!(!g.value||q.value===0)&&confirm(`Retirer ${q.value} point(s) fidélité ?`)){C.value=!0;try{const p=await K(g.value.id);p?.success?(await s(g.value.id),alert(`${p.count} point(s) fidélité retiré(s)`)):alert("Erreur lors du retrait des points")}catch{alert("Erreur lors du retrait des points")}finally{C.value=!1}}},h=async()=>{if(!(!g.value||!confirm("Réinitialiser les points fidélité à 0 ?")))try{await S(g.value.id),await s(g.value.id)}catch{alert("Erreur lors de la réinitialisation")}},v=p=>{if(!p)return"";const M=new Date(p),f=String(M.getDate()).padStart(2,"0"),P=String(M.getMonth()+1).padStart(2,"0"),z=M.getFullYear();return`${f}/${P}/${z}`};return(p,M)=>(n(),c("div",lr,[e("div",nr,[e("div",ir,[e("div",dr,[w(r(nt),{class:"w-4 h-4 text-yellow-600 dark:text-yellow-400"})]),M[0]||(M[0]=e("span",{class:"text-sm font-semibold text-gray-900 dark:text-gray-100"},"Carte fidélité",-1)),e("span",cr,y(r(x))+"/"+y(r(I)),1)]),e("div",ur,[r(g)&&j.value>0?(n(),c("button",{key:0,type:"button",onClick:W,disabled:C.value,class:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-yellow-700 bg-yellow-100 hover:bg-yellow-200 dark:text-amber-300 dark:bg-amber-900/50 dark:hover:bg-amber-900/70 rounded-lg transition-colors disabled:opacity-50",title:"Enregistrer les points cochés (sans vente)"},[w(r(Ye),{class:"w-3.5 h-3.5"}),le(" "+y(C.value?"Enregistrement...":`+${j.value} point(s)`),1)],8,mr)):H("",!0),r(g)&&q.value>0?(n(),c("button",{key:1,type:"button",onClick:Z,disabled:C.value,class:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-red-700 bg-red-100 hover:bg-red-200 dark:text-red-300 dark:bg-red-900/50 dark:hover:bg-red-900/70 rounded-lg transition-colors disabled:opacity-50",title:"Retirer les points sélectionnés"},[w(r(it),{class:"w-3.5 h-3.5"}),le(" "+y(C.value?"Retrait...":`-${q.value} point(s)`),1)],8,pr)):H("",!0),r(g)?(n(),c("button",{key:2,type:"button",onClick:h,class:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:text-red-400 dark:hover:bg-red-900/30 rounded-lg transition-colors",title:"Réinitialiser les points à 0"},[w(r(ct),{class:"w-3.5 h-3.5"}),M[1]||(M[1]=le(" Réinit. points ",-1))])):H("",!0),r(F)?(n(),c("span",gr,[w(r(Ze),{class:"w-3.5 h-3.5"}),M[2]||(M[2]=le(" Complète ",-1))])):H("",!0)])]),e("div",yr,[(n(!0),c(ae,null,re(r(l),f=>(n(),c("button",{key:f.position,onClick:P=>r(k)(f.position),class:O(["relative aspect-square w-full max-w-none rounded-xl border-2 transition-all duration-200 flex flex-col items-center justify-center overflow-hidden",f.markedForRemoval?"border-red-500 bg-red-50 dark:border-red-500 dark:bg-red-900/30 ring-2 ring-red-400":f.isStamped?"border-yellow-500 bg-yellow-50 hover:bg-yellow-100 dark:border-amber-500 dark:bg-amber-900/30 dark:hover:bg-amber-900/50":"border-gray-300 bg-white hover:bg-gray-50 hover:border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:hover:bg-gray-600 dark:hover:border-gray-500"])},[e("span",{class:O(["text-base font-bold",f.markedForRemoval?"text-red-600 dark:text-red-400 line-through":f.isStamped?"text-yellow-600 dark:text-amber-400":"text-gray-400 dark:text-gray-500"])},y(f.position),3),w(Me,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"scale-0 opacity-0","enter-to-class":"scale-100 opacity-100"},{default:Ie(()=>[f.isStamped?(n(),c("div",{key:0,class:O(["absolute inset-0 flex items-center justify-center",f.markedForRemoval?"bg-red-500/20 dark:bg-red-500/30":"bg-yellow-500/20 dark:bg-amber-500/30"])},[w(r(Ze),{class:O(["w-6 h-6 drop-shadow",f.markedForRemoval?"text-red-600 dark:text-red-400":"text-yellow-600 dark:text-amber-400"])},null,8,["class"])],2)):H("",!0)]),_:2},1024),f.isStamped&&f.date?(n(),c("span",xr,y(v(f.date)),1)):H("",!0)],10,vr))),128))])]))}});function br($){const l=$.trim();return l.length<6||l.length>20?!1:/^\d+$/.test(l)}const fr={class:"bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl max-h-[85vh] flex flex-col border border-gray-200 dark:border-gray-700 overflow-hidden",role:"dialog","aria-modal":"true","aria-labelledby":"product-picker-title"},kr={class:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 shrink-0"},_r={id:"product-picker-title",class:"text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2"},wr={class:"px-4 py-3 border-b border-gray-100 dark:border-gray-700 shrink-0"},$r={class:"flex rounded-xl border border-gray-200 dark:border-gray-600 overflow-hidden mb-3"},Cr={class:"relative"},Sr={class:"flex-1 overflow-y-auto p-4"},Tr={key:0},Pr={class:"text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3 sticky top-0 bg-white dark:bg-gray-800 py-1"},Er={class:"space-y-4"},Ir={class:"p-3 flex items-center justify-between"},Mr={class:"min-w-0 flex-1"},Nr={class:"font-medium text-gray-900 dark:text-white truncate"},jr={class:"text-xs text-gray-500 dark:text-gray-400 mt-0.5"},qr={class:"px-3 pb-3 flex flex-wrap gap-2"},Rr=["onClick","disabled"],Ar={class:"text-xs opacity-90"},Fr=["onClick","disabled"],Dr={class:"text-xs opacity-90"},Vr={key:1,class:"flex flex-col items-center justify-center py-16 text-gray-500 dark:text-gray-400"},Lr=xe({__name:"ProductPickerDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup($,{emit:l}){const x=$,F=l,{physicalProducts:I,loadProducts:k,findByBarcode:L}=De(),{addToCart:K}=Ve(),S=T(""),s=T("sale"),g=B({get:()=>x.modelValue,set:h=>F("update:modelValue",h)});we(g,h=>{if(h){k(),S.value="",s.value="sale";const v=p=>{p.key==="Escape"&&Z()};return window.addEventListener("keydown",v),()=>window.removeEventListener("keydown",v)}});const _=B(()=>{const h=S.value.trim().toLowerCase();let v=I.value;return h&&(v=v.filter(p=>p.name.toLowerCase().includes(h)||p.brand?.toLowerCase().includes(h)||p.model?.toLowerCase().includes(h)||p.code?.toLowerCase().includes(h)||p.barcode?.toLowerCase().includes(h))),v}),C=h=>s.value==="technical"?h.stock_technical??0:h.stock,j=B(()=>{const h=new Map;for(const p of _.value){const M=p.brand?.trim()||"Sans marque";h.has(M)||h.set(M,[]),h.get(M).push(p)}const v=[];for(const[p,M]of h){const f=new Map;for(const z of M){const J=`${z.name}|${z.model??""}`;f.has(J)||f.set(J,[]),f.get(J).push(z)}const P=[];for(const[,z]of f){const J=z[0].model?`${z[0].name} ${z[0].model}`:z[0].name;P.push({displayName:J,variants:z.map(Y=>({product:Y,size:Y.size??null,stockSale:Y.stock??0,stockTech:Y.stock_technical??0}))})}P.sort((z,J)=>z.displayName.localeCompare(J.displayName)),v.push({brand:p,models:P})}return v.sort((p,M)=>p.brand.localeCompare(M.brand)),v}),q=h=>{C(h)<=0||K(h,1,void 0,s.value)},W=async h=>{if(h.key!=="Enter")return;const v=S.value.trim();if(!v||!br(v))return;h.preventDefault();const p=await L(v);p&&(q(p),S.value="")},Z=()=>{g.value=!1};return(h,v)=>(n(),ue(gt,{to:"body"},[w(Me,{"enter-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition-opacity duration-150","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:Ie(()=>[g.value?(n(),c("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:lt(Z,["self"])},[e("div",fr,[e("div",kr,[e("h2",_r,[w(r(We),{class:"w-5 h-5 text-gray-500 dark:text-gray-400"}),v[3]||(v[3]=le(" Ajouter un produit ",-1))]),e("button",{onClick:Z,class:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 dark:hover:text-gray-400 dark:hover:bg-gray-700 rounded-lg transition-colors","aria-label":"Fermer"},[w(r(Nt),{class:"w-5 h-5"})])]),e("div",wr,[e("div",$r,[e("button",{onClick:v[0]||(v[0]=p=>s.value="sale"),class:O(["flex-1 px-4 py-2.5 text-sm font-medium transition-colors flex items-center justify-center gap-2",s.value==="sale"?"bg-emerald-600 text-white":"bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600"])},[w(r(jt),{class:"w-4 h-4"}),v[4]||(v[4]=le(" Produit de vente ",-1))],2),e("button",{onClick:v[1]||(v[1]=p=>s.value="technical"),class:O(["flex-1 px-4 py-2.5 text-sm font-medium transition-colors flex items-center justify-center gap-2",s.value==="technical"?"bg-blue-600 text-white":"bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600"])},[w(r(Pt),{class:"w-4 h-4"}),v[5]||(v[5]=le(" Utilisation technique ",-1))],2)]),e("div",Cr,[w(r(Fe),{class:"absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 dark:text-gray-500 pointer-events-none"}),ye(e("input",{"onUpdate:modelValue":v[2]||(v[2]=p=>S.value=p),type:"text",placeholder:"Rechercher ou scanner le code-barres...",class:"w-full pl-11 pr-4 py-2.5 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-emerald-500 focus:border-transparent",autofocus:"",onKeydown:W},null,544),[[ve,S.value]])])]),e("div",Sr,[j.value.length>0?(n(),c("div",Tr,[(n(!0),c(ae,null,re(j.value,({brand:p,models:M})=>(n(),c("div",{key:p,class:"mb-6 last:mb-0"},[e("h3",Pr,y(p),1),e("div",Er,[(n(!0),c(ae,null,re(M,f=>(n(),c("div",{key:`${p}-${f.variants[0].product.id}`,class:"rounded-xl border border-gray-200 dark:border-gray-600 overflow-hidden bg-gray-50/50 dark:bg-gray-900/30"},[e("div",Ir,[e("div",Mr,[e("p",Nr,y(f.displayName),1),e("p",jr,y(f.variants[0].product.price_ttc?.toFixed(2))+"€ ",1)])]),e("div",qr,[(n(!0),c(ae,null,re(f.variants,P=>(n(),c(ae,{key:P.product.id},[P.size?(n(),c("button",{key:0,onClick:z=>q(P.product),disabled:(s.value==="sale"?P.stockSale:P.stockTech)<=0,class:O(["inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors",(s.value==="sale"?P.stockSale:P.stockTech)>0?s.value==="sale"?"bg-emerald-600 text-white hover:bg-emerald-700 dark:bg-emerald-500 dark:hover:bg-emerald-600":"bg-blue-600 text-white hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600":"bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 cursor-not-allowed"])},[e("span",null,y(P.size),1),e("span",Ar,"("+y(s.value==="sale"?P.stockSale:P.stockTech)+")",1)],10,Rr)):(n(),c("button",{key:1,onClick:z=>q(P.product),disabled:(s.value==="sale"?P.stockSale:P.stockTech)<=0,class:O(["inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors",(s.value==="sale"?P.stockSale:P.stockTech)>0?s.value==="sale"?"bg-emerald-600 text-white hover:bg-emerald-700 dark:bg-emerald-500 dark:hover:bg-emerald-600":"bg-blue-600 text-white hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600":"bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 cursor-not-allowed"])},[w(r(Ye),{class:"w-4 h-4"}),v[6]||(v[6]=e("span",null,"Ajouter",-1)),e("span",Dr,"("+y(s.value==="sale"?P.stockSale:P.stockTech)+")",1)],10,Fr))],64))),128))])]))),128))])]))),128))])):(n(),c("div",Vr,[w(r(We),{class:"w-12 h-12 mb-4 opacity-40"}),v[7]||(v[7]=e("p",{class:"text-sm font-medium"},"Aucun produit trouvé",-1)),v[8]||(v[8]=e("p",{class:"text-xs mt-1"},"Modifiez votre recherche",-1))]))])])])):H("",!0)]),_:1})]))}}),zr={class:"card flex flex-col bg-white dark:bg-gray-800 h-full"},Br={class:"p-4 md:p-6 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 space-y-3"},Hr={class:"flex gap-2"},Ur={class:"relative"},Or={class:"flex items-center gap-3"},Kr={class:"relative flex-1"},Gr={key:0,class:"text-xs text-red-500 dark:text-red-400 mt-1.5"},Qr={class:"space-y-1"},Wr={class:"flex gap-2"},Zr={class:"relative flex-1"},Jr=["onKeydown"],Yr={key:0,class:"flex items-center gap-1.5 text-xs font-medium text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 px-3 py-1.5 rounded-lg"},Xr={key:0,class:"text-xs text-red-600 dark:text-red-400"},es={class:"relative"},ts={class:"relative"},as=["value"],rs={key:0,class:"absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-700 rounded-xl shadow-xl border border-gray-200 dark:border-gray-600 py-2 z-50 max-h-60 md:max-h-80 overflow-y-auto"},ss=["onClick"],os={class:"flex-1 min-w-0"},ls={class:"flex items-center gap-1.5"},ns={class:"text-sm font-medium text-gray-900 dark:text-gray-100 truncate"},is={key:0,class:"inline-flex px-1.5 py-0.5 rounded text-[9px] font-semibold bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300 shrink-0"},ds={class:"flex items-center gap-2 mt-0.5"},cs={class:"text-xs text-gray-500 dark:text-gray-400"},us={class:"flex items-center gap-2 md:gap-3 ml-2 md:ml-3"},ms={class:"text-sm font-bold text-gray-900 dark:text-gray-100 tabular-nums"},ps={key:0,class:"text-xs text-gray-400 dark:text-gray-500 hidden sm:inline"},gs={class:"flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 dark:bg-gray-800 space-y-4"},ys={key:0,class:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-2.5 md:gap-3.5"},vs={key:1,class:"h-full flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 py-12"},xs=xe({__name:"ServiceGrid",setup($){const{products:l,searchProducts:x,findByBarcode:F}=De(),{addToCart:I}=Ve(),{selectedClient:k}=Ne(),{loadClientStamps:L,clearStamps:K}=Je(),S=T([]);(async()=>{const{data:t}=await A.from("vendors").select("*").eq("is_active",!0);S.value=t||[]})(),we(k,t=>{t?L(t.id):K()});const g=T(!1),_=T(""),C=T(!1),j=T([]),q=T(""),W=T(""),Z=T(""),h=T(""),v=T(null),p=T(""),M=B(()=>{const t=_.value.toLowerCase().trim(),a=l.value.filter(o=>o.type==="service"&&o.is_active!==!1).slice().sort((o,R)=>String(o.code??"").localeCompare(String(R.code??""),void 0,{numeric:!0}));return t?a.filter(o=>o.name.toLowerCase().includes(t)||o.code?.toLowerCase().includes(t)):a});we(M,t=>{console.log("Services affichés:",t.length)},{immediate:!0});const f=async t=>{const a=t.target;if(_.value=a.value,a.value.trim().length>=2){const o=await x(a.value);j.value=o||[],C.value=j.value.length>0}else j.value=[],C.value=!1},P=()=>{_.value.trim().length>=2&&j.value.length>0&&(C.value=!0)},z=()=>{setTimeout(()=>{C.value=!1},200)},J=t=>{I(t,1,void 0,"sale"),_.value="",j.value=[],C.value=!1},Y=t=>{if(t.key==="Enter"&&j.value.length>0){t.preventDefault();const a=j.value[0];I(a,1,void 0,"sale"),_.value="",j.value=[],C.value=!1}},ie=async()=>{const t=Z.value.trim();if(!t)return;h.value="",p.value="";const a=await F(t);a?(a.type==="product"&&(a.stock??0)<=0?(h.value="Stock de vente vide pour ce produit",setTimeout(()=>{h.value=""},3e3)):(I(a,1),p.value=`${a.name} ajouté au panier`,setTimeout(()=>{p.value=""},2500)),Z.value=""):(h.value="Produit non trouvé ou sans code-barres",setTimeout(()=>{h.value=""},3e3)),await vt(),v.value?.focus()};we(_,t=>{t.trim().length<2&&(j.value=[],C.value=!1)});const E=t=>{const a=t.trim().toUpperCase();if(a.length<2)return null;const o=a.match(/^([A-Z]+)(\d+.*)$/);return o?{vendorInitials:o[1],productCode:o[2]}:null},u=t=>S.value.find(a=>a.initials?.toUpperCase()===t.toUpperCase()),d=t=>l.value.find(a=>a.code?.toUpperCase()===t.toUpperCase()),G=t=>{t.key==="Enter"&&(t.preventDefault(),he())},he=()=>{W.value="";const t=E(q.value);if(!t){W.value="Format invalide (ex: VL1)";return}const a=u(t.vendorInitials);if(!a){W.value=`Vendeur "${t.vendorInitials}" non trouvé`;return}const o=d(t.productCode);if(!o){W.value=`Service "${t.productCode}" non trouvé`;return}I(o,1,a),q.value="",W.value=""};return(t,a)=>(n(),c("div",zr,[e("div",Br,[e("div",Hr,[e("button",{onClick:a[0]||(a[0]=o=>g.value=!0),class:"inline-flex items-center gap-2 px-4 py-2.5 bg-gray-900 dark:bg-emerald-600 dark:hover:bg-emerald-500 text-white rounded-xl font-medium hover:bg-gray-800 transition-colors text-sm"},[w(r(We),{class:"w-4 h-4"}),a[4]||(a[4]=le(" Produits ",-1))])]),e("div",Ur,[e("div",Or,[e("div",Kr,[w(r(Dt),{class:"absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-amber-500 dark:text-amber-400 pointer-events-none z-10"}),ye(e("input",{"onUpdate:modelValue":a[1]||(a[1]=o=>q.value=o),onKeydown:G,type:"text",placeholder:"Raccourci (ex: VL1)",class:"w-full pl-11 pr-4 py-2.5 bg-amber-50 dark:bg-gray-700 dark:border-amber-600/50 dark:text-gray-100 border border-amber-300 rounded-xl text-sm font-mono font-semibold uppercase focus:outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-500/20 dark:focus:border-amber-400 dark:focus:ring-amber-400/30 hover:border-amber-400 transition-all placeholder:normal-case placeholder:font-normal dark:placeholder-gray-400",autocomplete:"off"},null,544),[[ve,q.value]])]),e("button",{onClick:he,class:"px-4 py-2.5 bg-amber-500 dark:bg-amber-600 text-white rounded-xl font-medium hover:bg-amber-600 dark:hover:bg-amber-500 transition-colors text-sm"}," OK ")]),W.value?(n(),c("p",Gr,y(W.value),1)):H("",!0)]),e("div",Qr,[a[5]||(a[5]=e("label",{class:"block text-[10px] md:text-xs text-gray-500 dark:text-gray-400 font-semibold uppercase tracking-wider"},"Scan code-barres",-1)),e("div",Wr,[e("div",Zr,[w(r(Rt),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 dark:text-gray-500 pointer-events-none"}),ye(e("input",{ref_key:"barcodeInputRef",ref:v,"onUpdate:modelValue":a[2]||(a[2]=o=>Z.value=o),type:"text",placeholder:"Scannez le code-barres du produit...",class:"w-full pl-10 pr-4 py-2.5 md:py-3 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30",autocomplete:"off",onKeydown:yt(lt(ie,["prevent"]),["enter"])},null,40,Jr),[[ve,Z.value]])]),e("button",{type:"button",onClick:ie,class:"px-4 py-2.5 bg-gray-900 dark:bg-emerald-600 dark:hover:bg-emerald-500 text-white rounded-xl text-sm font-medium hover:bg-gray-800"}," Ajouter ")]),w(Me,{"enter-active-class":"transition ease-out duration-200","enter-from-class":"opacity-0 -translate-y-1","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-150","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 -translate-y-1"},{default:Ie(()=>[p.value?(n(),c("p",Yr,[w(r(Et),{class:"w-3.5 h-3.5 shrink-0"}),le(" "+y(p.value),1)])):H("",!0)]),_:1}),h.value?(n(),c("p",Xr,y(h.value),1)):H("",!0)]),e("div",es,[e("div",ts,[w(r(Fe),{class:"absolute left-4 md:left-5 top-1/2 -translate-y-1/2 w-4 h-4 md:w-5 md:h-5 text-gray-400 dark:text-gray-500 pointer-events-none z-10"}),e("input",{value:_.value,onInput:f,onFocus:P,onBlur:z,onKeydown:Y,type:"text",placeholder:"Rechercher un produit...",class:"w-full pl-11 md:pl-14 pr-4 md:pr-5 py-3 md:py-3.5 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all",autocomplete:"off"},null,40,as)]),w(Me,{"enter-active-class":"transition ease-out duration-100","enter-from-class":"opacity-0 translate-y-1","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-75","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-1"},{default:Ie(()=>[C.value&&j.value.length>0?(n(),c("div",rs,[(n(!0),c(ae,null,re(j.value,o=>(n(),c("button",{key:o.id,onClick:R=>J(o),class:"w-full px-4 md:px-5 py-2.5 md:py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors flex items-center justify-between"},[e("div",os,[e("div",ls,[e("p",ns,y(o.name),1),o.type==="product"?(n(),c("span",is,"PRODUIT")):H("",!0)]),e("div",ds,[e("p",cs,y(o.code),1),o.type==="product"?(n(),c("span",{key:0,class:O(["text-[10px] tabular-nums",(o.stock??0)>0?"text-emerald-600 dark:text-emerald-400":"text-red-500 dark:text-red-400"])}," Stock : "+y(o.stock??0),3)):H("",!0)])]),e("div",us,[e("span",ms,y(o.price_ttc?.toFixed(2))+"€",1),o.duration?(n(),c("span",ps,y(o.duration)+"min",1)):H("",!0)])],8,ss))),128))])):H("",!0)]),_:1})])]),e("div",gs,[M.value.length>0?(n(),c("div",ys,[(n(!0),c(ae,null,re(M.value,o=>(n(),ue(or,{key:o.id,service:o},null,8,["service"]))),128))])):(n(),c("div",vs,[w(r(Fe),{class:"w-10 h-10 md:w-14 md:h-14 mb-4 opacity-40"}),a[6]||(a[6]=e("p",{class:"text-sm md:text-base font-medium text-gray-500 dark:text-gray-400"},"Aucun service trouvé",-1)),a[7]||(a[7]=e("p",{class:"text-xs md:text-sm text-gray-400 dark:text-gray-500 mt-1.5"},"Modifiez votre recherche",-1))])),r(k)?(n(),ue(hr,{key:2})):H("",!0)]),w(Lr,{modelValue:g.value,"onUpdate:modelValue":a[3]||(a[3]=o=>g.value=o)},null,8,["modelValue"])]))}}),V=T({id:"",firstName:"",lastName:"",phone:"",phone2:"",email:"",address:"",city:"",postalCode:"",birthDate:"",notes:"",company:""}),Ee=T(!1);function hs(){const{createClient:$,updateClient:l,selectClient:x}=Ne(),F=B(()=>!!(V.value.firstName.trim()||V.value.lastName.trim()||V.value.phone.trim())),I=()=>{V.value={id:"",firstName:"",lastName:"",phone:"",phone2:"",email:"",address:"",city:"",postalCode:"",birthDate:"",notes:"",company:""},Ee.value=!1,x(null)};return{currentClient:V,isEditMode:Ee,hasClientInfo:F,clearClient:I,loadClient:S=>{V.value={...S},Ee.value=!0},newClient:()=>{I()},saveClient:async()=>{if(!F.value)return{success:!1,isNew:!1,message:"Veuillez remplir au moins un champ (nom, prénom ou téléphone)"};if(!V.value.phone.trim())return{success:!1,isNew:!1,message:"Le numéro de téléphone est obligatoire"};try{const S={first_name:V.value.firstName,last_name:V.value.lastName,phone:V.value.phone,phone2:V.value.phone2||null,email:V.value.email||null,address:V.value.address||null,city:V.value.city||null,postal_code:V.value.postalCode||null,birth_date:V.value.birthDate||null,notes:V.value.notes||null,company:V.value.company?.trim()||null};if(Ee.value&&V.value.id){console.log("Mise à jour du client:",S);const s=await l(V.value.id,S);return s?(x(s),{success:!0,isNew:!1,message:`Client ${V.value.firstName} ${V.value.lastName} mis à jour`}):{success:!1,isNew:!1,message:"Erreur lors de la mise à jour"}}else{console.log("Création du client:",S);const s=await $(S);return s?(V.value.id=s.id,Ee.value=!0,x(s),{success:!0,isNew:!0,message:`Client ${V.value.firstName} ${V.value.lastName} créé`}):{success:!1,isNew:!1,message:"Erreur lors de la création"}}}catch(S){return console.error("Erreur lors de l'enregistrement du client:",S),{success:!1,isNew:!1,message:"Erreur lors de l'enregistrement"}}}}}const bs={class:"card h-full flex flex-col overflow-hidden"},fs={class:"p-4 md:p-6 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"},ks={class:"flex items-center justify-between mb-3 md:mb-4"},_s={class:"relative"},ws={key:0,class:"absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-700 rounded-xl shadow-xl border border-gray-200 dark:border-gray-600 py-2 z-50"},$s=["onClick"],Cs={class:"text-xs md:text-sm font-medium text-gray-900 dark:text-gray-100"},Ss={class:"text-[10px] md:text-xs text-gray-500 dark:text-gray-400 mt-0.5"},Ts={class:"flex-1 overflow-y-auto p-4 md:p-6 min-h-0 space-y-4 md:space-y-5 bg-gray-50 dark:bg-gray-800"},Ps={class:"grid grid-cols-2 gap-3 md:gap-4"},Es={class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider"},Is=["value","type","placeholder","maxlength","inputmode","autocomplete","onInput"],Ms={class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider"},Ns=["value","type","placeholder","onInput"],js={key:0,class:"col-span-2 flex items-center gap-3 p-3 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl"},qs=["checked"],Rs={class:"col-span-2 space-y-1.5 md:space-y-2"},As={class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider flex items-center gap-1.5 md:gap-2"},Fs={class:"grid grid-cols-2 gap-3 md:gap-4"},Ds={class:"space-y-1.5 md:space-y-2"},Vs={class:"space-y-1.5 md:space-y-2"},Ls=["value","maxlength"],zs={class:"space-y-1.5 md:space-y-2"},Bs={class:"p-4 md:p-6 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"},Hs={class:"grid grid-cols-3 gap-2 md:gap-3"},Us=["disabled"],Os=["disabled"],Ks=["disabled"],Gs={class:"hidden sm:inline"},Qs=xe({__name:"ClientPanel",setup($){const{currentClient:l,isEditMode:x,clearClient:F,loadClient:I,hasClientInfo:k,saveClient:L}=hs(),{searchClients:K,selectClient:S,clearSelection:s,selectedClient:g,invoiceInCompanyName:_,setInvoiceInCompanyName:C}=Ne(),j=T(""),q=T([]),W=T(!1);let Z=null;we(j,E=>{if(Z&&clearTimeout(Z),E.trim().length<2){q.value=[];return}Z=window.setTimeout(async()=>{W.value=!0;try{const u=await K(E);q.value=u}catch(u){console.error("Erreur recherche clients:",u),q.value=[]}finally{W.value=!1}},300)});const h=B(()=>j.value.trim().length>=2&&q.value.length>0),v=async()=>{const E=await L();E.success,alert(E.message)},p=()=>{F(),j.value="",s()},M=()=>{alert("Historique client à implémenter")},f=E=>{S(E),C(!1);const u={id:E.id,firstName:E.first_name,lastName:E.last_name,phone:ze(E.phone||""),phone2:ze(E.phone2||""),email:E.email||"",address:E.address||"",city:E.city||"",postalCode:at(E.postal_code||""),birthDate:E.birth_date||"",notes:E.notes||"",company:E.company||""};I(u),j.value=`${u.firstName} ${u.lastName}`,q.value=[]},P=E=>{const u=q.value[0];E.key==="Enter"&&u&&(E.preventDefault(),f(u))},z=[{key:"lastName",label:"Nom",type:"text",placeholder:"Dupont",span:1,format:null},{key:"firstName",label:"Prénom",type:"text",placeholder:"Jean",span:1,format:null},{key:"phone",label:"Tél. 1",type:"tel",placeholder:"06 12 34 56 78",span:1,format:"phone"},{key:"phone2",label:"Tél. 2",type:"tel",placeholder:"01 23 45 67 89",span:1,format:"phone"},{key:"email",label:"Email",type:"email",placeholder:"jean@email.com",span:2,format:null},{key:"birthDate",label:"Anniversaire",type:"date",placeholder:"",span:2,format:null},{key:"company",label:"Entreprise",type:"text",placeholder:"Nom de l'entreprise (optionnel)",span:2,format:null}];function J(E,u,d){const G=d==="phone"?ze(u):u;l.value[E]=G}function Y(E,u){l.value[E]=u}function ie(E){l.value.postalCode=at(E)}return(E,u)=>(n(),c("div",bs,[e("div",fs,[e("div",ks,[u[6]||(u[6]=e("h2",{class:"text-xs md:text-sm font-semibold text-gray-900 dark:text-gray-100 uppercase tracking-wider"},"Client",-1)),r(k)?(n(),c("div",{key:0,class:O(["inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] md:text-xs font-semibold transition-colors",r(x)?"bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300":"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300"])},[(n(),ue(Ae(r(x)?r(At):r(et)),{class:"w-3 h-3"})),e("span",null,y(r(x)?"Modification":"Nouveau"),1)],2)):H("",!0)]),e("div",_s,[w(r(Fe),{class:"absolute left-4 md:left-5 top-1/2 -translate-y-1/2 w-4 h-4 md:w-5 md:h-5 text-gray-400 dark:text-gray-500 pointer-events-none z-10"}),ye(e("input",{"onUpdate:modelValue":u[0]||(u[0]=d=>j.value=d),onKeydown:P,type:"text",placeholder:"Rechercher un client...",class:"w-full pl-11 md:pl-14 pr-4 md:pr-5 py-3 md:py-3.5 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all",autocomplete:"off"},null,544),[[ve,j.value]]),w(Me,{"enter-active-class":"transition ease-out duration-100","enter-from-class":"opacity-0 translate-y-1","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-75","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-1"},{default:Ie(()=>[h.value?(n(),c("div",ws,[(n(!0),c(ae,null,re(q.value,d=>(n(),c("button",{key:d.id,onClick:G=>f(d),class:"w-full px-4 md:px-5 py-2.5 md:py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors"},[e("p",Cs,y(d.first_name)+" "+y(d.last_name),1),e("p",Ss,y(d.phone),1)],8,$s))),128))])):H("",!0)]),_:1})])]),e("div",Ts,[e("div",Ps,[(n(!0),c(ae,null,re(z.filter(d=>d.span!==2),d=>(n(),c("div",{key:d.key,class:"space-y-1.5 md:space-y-2"},[e("label",Es,y(d.label),1),e("input",{value:r(l)[d.key],type:d.type,placeholder:d.placeholder,maxlength:d.format==="phone"?r(tt).phone:void 0,inputmode:d.format==="phone"?"numeric":void 0,autocomplete:d.format==="phone"?"tel":void 0,class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all",onInput:G=>J(d.key,G.target.value,d.format)},null,40,Is)]))),128)),(n(!0),c(ae,null,re(z.filter(d=>d.span===2),d=>(n(),c("div",{key:d.key,class:"col-span-2 space-y-1.5 md:space-y-2"},[e("label",Ms,y(d.label),1),e("input",{value:r(l)[d.key],type:d.type,placeholder:d.placeholder,class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all",onInput:G=>d.format?J(d.key,G.target.value,d.format):Y(d.key,G.target.value)},null,40,Ns)]))),128))]),r(g)?(n(),c("div",js,[e("input",{id:"cb-invoice-company",type:"checkbox",checked:r(_),onChange:u[1]||(u[1]=d=>r(C)(d.target.checked)),class:"w-4 h-4 rounded border-gray-300 dark:border-gray-500 text-gray-900 dark:bg-gray-600 focus:ring-gray-900 dark:focus:ring-emerald-500"},null,40,qs),u[7]||(u[7]=e("label",{for:"cb-invoice-company",class:"text-xs md:text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer"}," Facture au nom de l'entreprise ",-1))])):H("",!0),e("div",Rs,[e("label",As,[w(r(bt),{class:"w-3 h-3 md:w-3.5 md:h-3.5"}),u[8]||(u[8]=e("span",null,"Adresse",-1))]),ye(e("input",{"onUpdate:modelValue":u[2]||(u[2]=d=>r(l).address=d),type:"text",placeholder:"123 Rue de la Paix",class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all"},null,512),[[ve,r(l).address]])]),e("div",Fs,[e("div",Ds,[u[9]||(u[9]=e("label",{class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider"}," Ville ",-1)),ye(e("input",{"onUpdate:modelValue":u[3]||(u[3]=d=>r(l).city=d),type:"text",placeholder:"Paris",class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all"},null,512),[[ve,r(l).city]])]),e("div",Vs,[u[10]||(u[10]=e("label",{class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider"}," CP ",-1)),e("input",{value:r(l).postalCode,type:"text",inputmode:"numeric",maxlength:r(tt).postalCode,placeholder:"75001",class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all",onInput:u[4]||(u[4]=d=>ie(d.target.value))},null,40,Ls)])]),e("div",zs,[u[11]||(u[11]=e("label",{class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider"}," Notes ",-1)),ye(e("textarea",{"onUpdate:modelValue":u[5]||(u[5]=d=>r(l).notes=d),placeholder:"Commentaires, préférences...",rows:"2",class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all resize-none"},null,512),[[ve,r(l).notes]])])]),e("div",Bs,[e("div",Hs,[e("button",{onClick:M,disabled:!r(x),class:"btn-secondary text-[10px] md:text-xs px-2 md:px-4 py-2.5 md:py-3"},[w(r(xt),{class:"w-3.5 h-3.5 md:w-4 md:h-4"}),u[12]||(u[12]=e("span",{class:"hidden sm:inline"},"Historique",-1))],8,Us),e("button",{onClick:p,disabled:!r(k),class:O(["inline-flex items-center justify-center gap-1 md:gap-2 px-2 md:px-4 py-2.5 md:py-3 text-[10px] md:text-xs font-medium rounded-xl transition-all duration-200",r(k)?"bg-white border border-gray-300 text-red-600 hover:bg-red-50 hover:border-red-200 dark:bg-gray-700 dark:border-gray-600 dark:text-red-400 dark:hover:bg-red-900/30 dark:hover:border-red-800":"bg-gray-100 text-gray-400 cursor-not-allowed border border-gray-200 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-500"])},[w(r(dt),{class:"w-3.5 h-3.5 md:w-4 md:h-4"}),u[13]||(u[13]=e("span",{class:"hidden sm:inline"},"Effacer",-1))],10,Os),e("button",{onClick:v,disabled:!r(k),class:O(["btn-primary text-[10px] md:text-xs px-2 md:px-4 py-2.5 md:py-3",r(x)?"bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-500":"bg-emerald-600 hover:bg-emerald-700 dark:bg-emerald-600 dark:hover:bg-emerald-500"])},[(n(),ue(Ae(r(x)?r(_t):r(et)),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})),e("span",Gs,y(r(x)?"Modifier":"Créer"),1)],10,Ks)])])]))}}),Ws={class:"flex-1 flex flex-col lg:flex-row gap-3 p-3 lg:gap-4 lg:p-4 pb-20 lg:pb-4 min-h-0 overflow-hidden"},Zs={class:"lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg z-50"},Js={class:"flex"},Ys=["onClick"],Xs={class:"text-xs font-medium"},xo=xe({__name:"CaissePage",setup($){const l=T("services"),x=[{id:"services",label:"Services",icon:ht},{id:"ticket",label:"Ticket",icon:qt},{id:"client",label:"Client",icon:Ft}];return(F,I)=>(n(),c(ae,null,[e("main",Ws,[e("aside",{class:O(["lg:w-72 xl:w-80 lg:flex-shrink-0 min-h-0 max-h-full",l.value==="ticket"?"block":"hidden lg:block"])},[w(Ka)],2),e("section",{class:O(["flex-1 min-w-0 min-h-0 max-h-full",l.value==="services"?"block":"hidden lg:block"])},[w(xs)],2),e("aside",{class:O(["lg:w-72 xl:w-80 lg:flex-shrink-0 min-h-0 max-h-full",l.value==="client"?"block":"hidden lg:block"])},[w(Qs)],2)]),e("nav",Zs,[e("div",Js,[(n(),c(ae,null,re(x,k=>e("button",{key:k.id,onClick:L=>l.value=k.id,class:O(["flex-1 flex flex-col items-center justify-center py-3 transition-colors",l.value===k.id?"text-gray-900 bg-gray-100 dark:text-gray-100 dark:bg-gray-700":"text-gray-500 hover:text-gray-700 hover:bg-gray-50 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:bg-gray-700/70"])},[(n(),ue(Ae(k.icon),{class:"w-5 h-5 mb-1"})),e("span",Xs,y(k.label),1)],10,Ys)),64))])])],64))}});export{xo as default};
