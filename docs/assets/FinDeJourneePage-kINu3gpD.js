import{r as g,a as $,s as F,d as Y,w as Z,C as tt,e as l,f as t,t as s,g as o,y as H,z as et,I as at,j as B,l as J,n as K,F as E,k as U,h as j,m as q,G as rt,J as st,q as i}from"./index-Bl-DGyDc.js";import{R as Q}from"./refresh-cw-DCDDjdqj.js";import{P as ot,_ as nt}from"./_plugin-vue_export-helper-BAIuDI4c.js";import{C as dt}from"./chevron-up-DV54CdZu.js";import{C as it,a as lt}from"./circle-arrow-up-D6o3inEo.js";const W={cash:"Espèces",card:"CB",contactless:"Sans contact",amex:"American Express",check:"Chèque",gift_card:"Chèque Cadeau",free:"Gratuit",technical:"Utilisation technique"};function ct(){const z=g(new Date().toISOString().split("T")[0]),x=g(!1),m=g(null),b=g([]),h=g([]),N=g([]),C=g([]),M=g(0),S=g(0),A=async()=>{x.value=!0,m.value=null;try{const d=z.value,_=`${d}T00:00:00`,v=`${d}T23:59:59.999`,{data:w,error:f}=await F.from("sales").select(`
          id,
          ticket_number,
          created_at,
          total,
          discount_amount,
          vendor:vendors(first_name, last_name),
          client:clients(first_name, last_name),
          items:sale_items(
            id,
            product_name,
            quantity,
            subtotal_ttc,
            product_id
          ),
          payments(method, amount)
        `).gte("created_at",_).lte("created_at",v).eq("status","completed");if(f)throw f;const{data:e}=await F.from("cash_registers").select("*").eq("date",d).maybeSingle();M.value=e?.opening_amount??0,S.value=e?.closing_amount??e?.opening_amount??0;let a=[];if(e?.id){const{data:r}=await F.from("cash_movements").select("type, amount, label, created_at").eq("cash_register_id",e.id).order("created_at",{ascending:!0});a=r||[]}const u=new Map;(w||[]).forEach(r=>{(r.payments||[]).forEach(c=>{const y=c.method,p=u.get(y)||{ca:0,nb:0};p.ca+=c.amount,p.nb+=1,u.set(y,p)})}),b.value=Array.from(u.entries()).map(([r,n])=>({method:r,label:W[r]||r,ca:n.ca,nb:n.nb})),N.value=a.map(r=>({type:r.type,label:r.label||(r.type==="in"?"Entrée":"Sortie"),amount:r.amount,createdAt:r.created_at}));const V=new Map,O=new Set;(w||[]).forEach(r=>{(r.items||[]).forEach(n=>{n.product_id&&O.add(n.product_id)})});const G=Array.from(O);let I={};if(G.length>0){const{data:r}=await F.from("products").select("id, type, size, category:categories(name)").in("id",G);(r||[]).forEach(n=>{const c=n.category?.name||(n.type==="service"?"PRESTATION":"Produit");I[n.id]={name:c,type:n.type,size:n.size}})}(w||[]).forEach(r=>{const n=r.total??0,c=r.discount_amount??0;(r.items||[]).forEach(y=>{const p=y.subtotal_ttc??0,P=(I[y.product_id]||{name:"PRESTATION",type:"service"}).name,R=V.get(P)||{ca:0,nb:0,reduction:0};R.ca+=p,R.nb+=y.quantity??1,R.reduction+=n>0?c*p/n:0,V.set(P,R)})}),h.value=Array.from(V.entries()).map(([r,n])=>({category:r,ca:n.ca,nb:n.nb,reduction:n.reduction,reductionPct:n.ca>0?n.reduction/n.ca*100:0}));const L=[];(w||[]).forEach(r=>{const n=r.vendor?`${r.vendor.first_name||""} ${r.vendor.last_name||""}`.trim():"—",c=r.client?`${r.client.first_name||""} ${r.client.last_name||""}`.trim():null,y=r.payments?.[0]?.method?W[r.payments[0].method]||r.payments[0].method:"—";(r.items||[]).forEach(p=>{const P=I[p.product_id]?.size??null;L.push({ticketNumber:r.ticket_number||r.id,saleTime:new Date(r.created_at).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),productName:p.product_name||"—",size:P??null,amount:p.subtotal_ttc??0,vendorName:n,paymentMethod:y,clientName:c})})}),L.sort((r,n)=>{const c=r.saleTime,y=n.saleTime;return c.localeCompare(y)}),C.value=L}catch(d){console.error("Erreur chargement fin de journée:",d),m.value=d.message}finally{x.value=!1}},D=$(()=>b.value.reduce((d,_)=>d+_.ca,0)),T=$(()=>b.value.reduce((d,_)=>d+_.nb,0)),k=$(()=>T.value>0?D.value/T.value:0);return{selectedDate:z,isLoading:x,error:m,paymentModeRows:b,categoryRows:h,cashMovements:N,journalRows:C,fondDeCaisse:M,caisseTotal:S,totalCA:D,totalVentes:T,panierMoyen:k,loadData:A}}const yt={class:"flex-1 p-4 lg:p-6 overflow-auto bg-gray-50 dark:bg-gray-900 print:bg-white print:p-4"},pt={class:"max-w-5xl mx-auto space-y-6 print:max-w-none"},gt={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 print:flex-row"},xt={class:"text-xl lg:text-2xl font-bold text-gray-900 dark:text-white print:text-black"},ut={class:"flex items-center gap-3 print:hidden"},mt=["disabled"],bt={key:0,class:"flex justify-center py-12"},ht={class:"grid grid-cols-1 lg:grid-cols-2 gap-6 print:grid-cols-2"},_t={class:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden print:rounded-none print:border print:shadow-none"},ft={class:"w-full text-sm"},kt={class:"divide-y divide-gray-100 dark:divide-gray-700"},vt={class:"px-4 py-2"},wt={class:"px-4 py-2 text-right tabular-nums"},Ct={class:"px-4 py-2 text-right tabular-nums"},Dt={key:0,class:"font-bold bg-gray-50 dark:bg-gray-700/50"},Tt={class:"px-4 py-2 text-right tabular-nums"},Et={class:"px-4 py-2 text-right tabular-nums"},Nt={class:"border-t-2 border-gray-200 dark:border-gray-600"},Mt={class:"px-4 py-2 text-right tabular-nums",colspan:"2"},St={class:"px-4 py-1 pl-8 text-sm"},At={class:"inline-flex items-center gap-1"},Pt={class:"border-t border-gray-200 dark:border-gray-600"},Rt={class:"px-4 py-2 text-right tabular-nums font-semibold",colspan:"2"},Ft={class:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden print:rounded-none print:border print:shadow-none"},jt={class:"w-full text-sm"},qt={class:"divide-y divide-gray-100 dark:divide-gray-700"},zt={class:"px-4 py-2"},Vt={class:"px-4 py-2 text-right tabular-nums"},It={class:"px-4 py-2 text-right tabular-nums"},Lt={class:"px-4 py-2 text-right tabular-nums text-gray-600 dark:text-gray-400"},$t={key:0,class:"font-bold bg-gray-50 dark:bg-gray-700/50 border-t-2"},Bt={class:"px-4 py-2 text-right tabular-nums"},Jt={class:"px-4 py-2 text-right tabular-nums"},Ut={class:"grid grid-cols-3 gap-4 print:grid-cols-3"},Ot={class:"bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 print:rounded-none"},Gt={class:"text-xl font-bold text-gray-900 dark:text-white print:text-black"},Ht={class:"bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 print:rounded-none"},Kt={class:"text-xl font-bold text-gray-900 dark:text-white print:text-black"},Qt={class:"bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 print:rounded-none"},Wt={class:"text-xl font-bold text-gray-900 dark:text-white print:text-black"},Xt={class:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden print:rounded-none print:border print:shadow-none"},Yt={class:"text-gray-500 dark:text-gray-400 print:hidden"},Zt={class:"journal-content overflow-x-auto"},te={class:"w-full text-sm min-w-[700px]"},ee={class:"divide-y divide-gray-100 dark:divide-gray-700"},ae={class:"px-3 py-2 font-mono text-xs"},re={class:"px-3 py-2 tabular-nums"},se={class:"px-3 py-2"},oe={class:"px-3 py-2"},ne={class:"px-3 py-2 text-right tabular-nums"},de={class:"px-3 py-2"},ie={class:"px-3 py-2"},le={class:"px-3 py-2"},ce={key:0,class:"p-6 text-center text-gray-500 dark:text-gray-400"},ye=Y({__name:"FinDeJourneePage",setup(z){const{selectedDate:x,isLoading:m,paymentModeRows:b,categoryRows:h,cashMovements:N,journalRows:C,fondDeCaisse:M,caisseTotal:S,totalCA:A,totalVentes:D,panierMoyen:T,loadData:k}=ct();Z(x,()=>k()),tt(()=>k());const d=f=>f.toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2}),_=f=>new Date(f).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}),v=g(!0),w=()=>{window.print()};return(f,e)=>(i(),l("main",yt,[t("div",pt,[t("div",gt,[t("h1",xt," Fin de journée "+s(_(o(x))),1),t("div",ut,[e[5]||(e[5]=t("label",{class:"text-sm text-gray-600 dark:text-gray-400"},"date :",-1)),H(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>at(x)?x.value=a:null),type:"date",class:"px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg text-sm"},null,512),[[et,o(x)]]),t("button",{onClick:e[1]||(e[1]=(...a)=>o(k)&&o(k)(...a)),disabled:o(m),class:"inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 disabled:opacity-50"},[B(o(Q),{class:K(["w-4 h-4",o(m)&&"animate-spin"])},null,8,["class"]),e[3]||(e[3]=J(" Calculer ",-1))],8,mt),t("button",{onClick:w,class:"inline-flex items-center gap-2 px-4 py-2 bg-gray-900 dark:bg-emerald-600 text-white rounded-xl hover:bg-gray-800"},[B(o(ot),{class:"w-4 h-4"}),e[4]||(e[4]=J(" Imprimer ",-1))])])]),o(m)?(i(),l("div",bt,[B(o(Q),{class:"w-8 h-8 text-gray-400 animate-spin"})])):(i(),l(E,{key:1},[t("div",ht,[t("div",_t,[e[10]||(e[10]=t("div",{class:"px-4 py-3 bg-gray-100 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600"},[t("h2",{class:"text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wider"},"Mode règlement")],-1)),t("table",ft,[e[9]||(e[9]=t("thead",null,[t("tr",{class:"border-b border-gray-200 dark:border-gray-600"},[t("th",{class:"px-4 py-2 text-left font-semibold text-gray-700 dark:text-gray-300"},"Mode règlement"),t("th",{class:"px-4 py-2 text-right font-semibold text-gray-700 dark:text-gray-300"},"CA"),t("th",{class:"px-4 py-2 text-right font-semibold text-gray-700 dark:text-gray-300"},"Nb")])],-1)),t("tbody",kt,[(i(!0),l(E,null,j(o(b),a=>(i(),l("tr",{key:a.method,class:"text-gray-900 dark:text-gray-100"},[t("td",vt,s(a.label),1),t("td",wt,s(d(a.ca))+" €",1),t("td",Ct,s(a.nb),1)]))),128)),o(b).length>0?(i(),l("tr",Dt,[e[6]||(e[6]=t("td",{class:"px-4 py-2"},"Total",-1)),t("td",Tt,s(d(o(A)))+" €",1),t("td",Et,s(o(D)),1)])):U("",!0),t("tr",Nt,[e[7]||(e[7]=t("td",{class:"px-4 py-2 font-medium"},"Fond de caisse",-1)),t("td",Mt,s(d(o(M)))+" €",1)]),(i(!0),l(E,null,j(o(N),a=>(i(),l("tr",{key:a.createdAt+a.label,class:"text-gray-600 dark:text-gray-400"},[t("td",St,[t("span",At,[a.type==="in"?(i(),q(o(it),{key:0,class:"w-3.5 h-3.5 text-emerald-500"})):(i(),q(o(lt),{key:1,class:"w-3.5 h-3.5 text-red-500"})),J(" "+s(a.type==="in"?"Entrée":"Sortie")+" — "+s(a.label),1)])]),t("td",{class:K(["px-4 py-1 text-right tabular-nums",a.type==="in"?"text-emerald-600":"text-red-600"]),colspan:"2"},s(a.type==="in"?"+":"-")+s(d(a.amount))+" € ",3)]))),128)),t("tr",Pt,[e[8]||(e[8]=t("td",{class:"px-4 py-2 font-medium"},"Caisse",-1)),t("td",Rt,s(d(o(S)))+" €",1)])])])]),t("div",Ft,[e[14]||(e[14]=t("div",{class:"px-4 py-3 bg-gray-100 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600"},[t("h2",{class:"text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wider"},"Catégorie")],-1)),t("table",jt,[e[13]||(e[13]=t("thead",null,[t("tr",{class:"border-b border-gray-200 dark:border-gray-600"},[t("th",{class:"px-4 py-2 text-left font-semibold text-gray-700 dark:text-gray-300"},"Catégorie"),t("th",{class:"px-4 py-2 text-right font-semibold text-gray-700 dark:text-gray-300"},"CA"),t("th",{class:"px-4 py-2 text-right font-semibold text-gray-700 dark:text-gray-300"},"Nb"),t("th",{class:"px-4 py-2 text-right font-semibold text-gray-700 dark:text-gray-300"},"Réduction")])],-1)),t("tbody",qt,[(i(!0),l(E,null,j(o(h),a=>(i(),l("tr",{key:a.category,class:"text-gray-900 dark:text-gray-100"},[t("td",zt,s(a.category),1),t("td",Vt,s(d(a.ca))+" €",1),t("td",It,s(a.nb),1),t("td",Lt,s(d(a.reduction))+" € ("+s(a.reductionPct.toFixed(2))+"%) ",1)]))),128)),o(h).length>0?(i(),l("tr",$t,[e[11]||(e[11]=t("td",{class:"px-4 py-2"},"Total",-1)),t("td",Bt,s(d(o(h).reduce((a,u)=>a+u.ca,0)))+" €",1),e[12]||(e[12]=t("td",{class:"px-4 py-2 text-right tabular-nums"},"—",-1)),t("td",Jt,s(d(o(h).reduce((a,u)=>a+u.reduction,0)))+" €",1)])):U("",!0)])])])]),t("div",Ut,[t("div",Ot,[e[15]||(e[15]=t("p",{class:"text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider"},"Total",-1)),t("p",Gt,s(d(o(A)))+" €",1)]),t("div",Ht,[e[16]||(e[16]=t("p",{class:"text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider"},"Ventes",-1)),t("p",Kt,s(o(D)),1)]),t("div",Qt,[e[17]||(e[17]=t("p",{class:"text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider"},"Panier moyen",-1)),t("p",Wt,s(d(o(T)))+" €",1)])]),t("div",Xt,[t("button",{type:"button",onClick:e[2]||(e[2]=a=>v.value=!v.value),class:"w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 flex items-center justify-between gap-2 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors print:pointer-events-none"},[e[18]||(e[18]=t("h2",{class:"text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wider"},"Journal des ventes",-1)),t("span",Yt,[v.value?(i(),q(o(dt),{key:0,class:"w-5 h-5"})):(i(),q(o(rt),{key:1,class:"w-5 h-5"}))])]),H(t("div",Zt,[t("table",te,[e[19]||(e[19]=t("thead",null,[t("tr",{class:"border-b border-gray-200 dark:border-gray-600"},[t("th",{class:"px-3 py-2 text-left font-semibold text-gray-700 dark:text-gray-300"},"N° transaction"),t("th",{class:"px-3 py-2 text-left font-semibold text-gray-700 dark:text-gray-300"},"Heure"),t("th",{class:"px-3 py-2 text-left font-semibold text-gray-700 dark:text-gray-300"},"Service/Produit"),t("th",{class:"px-3 py-2 text-left font-semibold text-gray-700 dark:text-gray-300"},"Taille"),t("th",{class:"px-3 py-2 text-right font-semibold text-gray-700 dark:text-gray-300"},"Montant"),t("th",{class:"px-3 py-2 text-left font-semibold text-gray-700 dark:text-gray-300"},"Vendeur"),t("th",{class:"px-3 py-2 text-left font-semibold text-gray-700 dark:text-gray-300"},"Paiement"),t("th",{class:"px-3 py-2 text-left font-semibold text-gray-700 dark:text-gray-300"},"Client")])],-1)),t("tbody",ee,[(i(!0),l(E,null,j(o(C),(a,u)=>(i(),l("tr",{key:u,class:"text-gray-900 dark:text-gray-100"},[t("td",ae,s(a.ticketNumber),1),t("td",re,s(a.saleTime),1),t("td",se,s(a.productName),1),t("td",oe,s(a.size||"—"),1),t("td",ne,s(d(a.amount))+" €",1),t("td",de,s(a.vendorName),1),t("td",ie,s(a.paymentMethod),1),t("td",le,s(a.clientName||"—"),1)]))),128))])]),o(C).length===0?(i(),l("p",ce,"Aucune vente ce jour")):U("",!0)],512),[[st,v.value]])])],64))])]))}}),be=nt(ye,[["__scopeId","data-v-0d44eb46"]]);export{be as default};
