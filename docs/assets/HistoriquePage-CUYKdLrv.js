import{c as H,d as J,r as c,a as P,y as K,q as W,b as i,e as t,h as l,n as E,f as d,t as o,v as Y,x as tt,F as x,g,w as V,T as B,s as L,l as C,k as p,j as S,m as T,C as et,z as st,o as n}from"./index-DodYGpJ8.js";import{R}from"./refresh-cw-C5BCTzhv.js";import{S as at}from"./search-By6t2NqO.js";import{S as ot}from"./square-pen-DW1r5ojL.js";import{X as nt}from"./x-21iBCkkO.js";import{B as z,C as I,S as rt,G as it}from"./smartphone-WB621kRV.js";import{F as lt}from"./file-text-C3Ju1Lll.js";import{E as dt}from"./euro-_aVnEfKE.js";const ct=H("chevron-up",[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]]);const N=H("receipt",[["path",{d:"M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z",key:"q3az6g"}],["path",{d:"M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8",key:"1h4pet"}],["path",{d:"M12 17.5v-11",key:"1jc1ny"}]]),ut={class:"flex-1 p-4 lg:p-6 overflow-auto"},mt={class:"max-w-6xl mx-auto space-y-6"},xt={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"},gt=["disabled"],pt={class:"grid grid-cols-3 gap-4"},yt={class:"bg-white rounded-xl p-4 shadow-sm border border-gray-200"},ft={class:"text-2xl font-bold text-gray-900 mt-1"},vt={class:"bg-white rounded-xl p-4 shadow-sm border border-gray-200"},ht={class:"text-2xl font-bold text-gray-900 mt-1"},bt={class:"bg-white rounded-xl p-4 shadow-sm border border-gray-200"},_t={class:"text-2xl font-bold text-gray-900 mt-1"},wt={class:"flex flex-col sm:flex-row gap-4"},kt={class:"relative flex-1"},Ct={class:"flex gap-2"},St=["onClick"],Tt={class:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"},Ft={key:0,class:"p-8 text-center"},qt={key:1,class:"p-8 text-center"},Dt={key:2,class:"divide-y divide-gray-100"},Et=["onClick"],Lt={class:"hidden sm:block w-24 flex-shrink-0"},jt={class:"text-sm font-medium text-gray-900"},At={class:"text-xs text-gray-500"},Mt={class:"flex-shrink-0"},Pt={class:"inline-flex items-center gap-1.5 px-2.5 py-1 bg-gray-100 text-gray-700 rounded-lg text-xs font-mono font-medium"},Vt={class:"flex-1 min-w-0"},Bt={class:"text-sm font-medium text-gray-900 truncate"},Rt={key:0,class:"text-xs text-gray-500 truncate"},zt={class:"hidden md:flex items-center gap-2"},It={class:"text-right flex-shrink-0"},Nt={class:"text-lg font-bold text-gray-900"},Ht={class:"text-xs text-gray-500 sm:hidden"},$t={key:0,class:"px-4 pb-4 overflow-hidden"},Ot={class:"bg-gray-50 rounded-xl p-4 space-y-4"},Gt={class:"space-y-2"},Ut={class:"text-gray-700"},Qt={class:"font-medium text-gray-900"},Xt={class:"border-t border-gray-200 pt-3 space-y-1"},Zt={class:"flex justify-between text-sm"},Jt={class:"text-gray-700"},Kt={class:"flex justify-between text-sm"},Wt={class:"text-gray-700"},Yt={key:0,class:"flex justify-between text-sm"},te={class:"text-red-600"},ee={class:"flex justify-between text-base font-bold pt-2 border-t border-gray-200"},se={class:"text-gray-900"},ae={class:"border-t border-gray-200 pt-3 flex items-center justify-between gap-4 flex-wrap"},oe={class:"flex items-center gap-2 flex-wrap"},ne=["onClick"],re={key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"},ie={class:"bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden"},le={class:"p-4 border-b border-gray-200 flex items-center justify-between"},de={class:"p-4 space-y-4"},ce={class:"text-sm text-gray-600"},ue={class:"font-mono font-semibold"},me={class:"font-bold"},xe={class:"grid grid-cols-2 sm:grid-cols-3 gap-2"},ge=["onClick"],pe={class:"text-xs font-medium"},ye={class:"p-4 border-t border-gray-200 flex gap-3"},fe=["disabled"],Fe=J({__name:"HistoriquePage",setup(ve){const v=c([]),y=c(!0),h=c(""),u=c("today"),b=c(null),m=c(null),f=c("card"),_=c(!1),$=[{id:"cash",label:"Espèces",icon:z},{id:"card",label:"CB",icon:I},{id:"contactless",label:"Sans contact",icon:rt},{id:"check",label:"Chèque",icon:lt},{id:"gift_card",label:"Cadeau",icon:it}],O=[{id:"today",label:"Aujourd'hui"},{id:"week",label:"Cette semaine"},{id:"month",label:"Ce mois"},{id:"all",label:"Tout"}],F=async()=>{y.value=!0;try{const a=new Date;let e=null;u.value==="today"?e=a.toISOString().split("T")[0]:u.value==="week"?e=new Date(a.getTime()-6048e5).toISOString().split("T")[0]:u.value==="month"&&(e=new Date(a.getTime()-2592e6).toISOString().split("T")[0]);let s=L.from("sales").select(`
        *,
        vendor:vendors(first_name, last_name),
        client:clients(first_name, last_name),
        items:sale_items(id, product_name, quantity, price_ht, subtotal_ttc),
        payments(method, amount)
      `).order("created_at",{ascending:!1}).limit(100);e&&(s=s.gte("created_at",e));const{data:r,error:k}=await s;if(k)throw k;v.value=r||[]}catch(a){console.error("Erreur chargement historique:",a),v.value=[]}finally{y.value=!1}},w=P(()=>{if(!h.value.trim())return v.value;const a=h.value.toLowerCase();return v.value.filter(e=>e.ticket_number.toLowerCase().includes(a)||e.client?.first_name?.toLowerCase().includes(a)||e.client?.last_name?.toLowerCase().includes(a)||e.vendor?.first_name?.toLowerCase().includes(a)||e.vendor?.last_name?.toLowerCase().includes(a))}),q=P(()=>{const a=w.value.reduce((r,k)=>r+k.total,0),e=w.value.length,s=e>0?a/e:0;return{total:a,count:e,avgTicket:s}}),G=a=>{b.value=b.value===a?null:a},j=a=>new Date(a).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}),U=a=>new Date(a).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),A=a=>{switch(a){case"cash":return z;case"card":case"contactless":return I;default:return dt}},M=a=>({cash:"Espèces",card:"Carte",contactless:"Sans contact",check:"Chèque",gift_card:"Carte cadeau"})[a]||a,Q=a=>{m.value=a;const e=a.payments?.[0];f.value=e?.method??"card"},D=()=>{m.value=null},X=async()=>{const a=m.value;if(a){_.value=!0;try{await L.from("payments").delete().eq("sale_id",a.id);const{error:e}=await L.from("payments").insert({sale_id:a.id,method:f.value,amount:a.total});if(e)throw e;a.payments=[{method:f.value,amount:a.total}],D()}catch(e){console.error("Erreur modification paiement:",e),alert("Impossible de modifier le paiement.")}finally{_.value=!1}}};return K(F),W(u,F),(a,e)=>(n(),i("main",ut,[t("div",mt,[t("div",xt,[e[2]||(e[2]=t("div",null,[t("h1",{class:"text-xl lg:text-2xl font-bold text-gray-900"},"Historique des ventes"),t("p",{class:"text-sm text-gray-500 mt-1"},"Consultez toutes les transactions")],-1)),t("button",{onClick:F,disabled:y.value,class:"inline-flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-xl hover:bg-gray-800 transition-colors disabled:opacity-50"},[l(d(R),{class:E(["w-4 h-4",y.value&&"animate-spin"])},null,8,["class"]),e[1]||(e[1]=t("span",null,"Actualiser",-1))],8,gt)]),t("div",pt,[t("div",yt,[e[3]||(e[3]=t("p",{class:"text-xs text-gray-500 uppercase tracking-wider font-semibold"},"Total",-1)),t("p",ft,o(q.value.total.toFixed(2))+"€",1)]),t("div",vt,[e[4]||(e[4]=t("p",{class:"text-xs text-gray-500 uppercase tracking-wider font-semibold"},"Ventes",-1)),t("p",ht,o(q.value.count),1)]),t("div",bt,[e[5]||(e[5]=t("p",{class:"text-xs text-gray-500 uppercase tracking-wider font-semibold"},"Panier moyen",-1)),t("p",_t,o(q.value.avgTicket.toFixed(2))+"€",1)])]),t("div",wt,[t("div",kt,[l(d(at),{class:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),Y(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>h.value=s),type:"text",placeholder:"Rechercher par ticket, client, vendeur...",class:"w-full pl-12 pr-4 py-3 bg-white border border-gray-300 rounded-xl text-sm focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"},null,512),[[tt,h.value]])]),t("div",Ct,[(n(),i(x,null,g(O,s=>t("button",{key:s.id,onClick:r=>u.value=s.id,class:E(["px-4 py-2 text-sm font-medium rounded-xl transition-colors",u.value===s.id?"bg-gray-900 text-white":"bg-white text-gray-700 border border-gray-300 hover:bg-gray-50"])},o(s.label),11,St)),64))])]),t("div",Tt,[y.value?(n(),i("div",Ft,[l(d(R),{class:"w-8 h-8 text-gray-400 animate-spin mx-auto"}),e[6]||(e[6]=t("p",{class:"text-sm text-gray-500 mt-2"},"Chargement...",-1))])):w.value.length===0?(n(),i("div",qt,[l(d(N),{class:"w-12 h-12 text-gray-300 mx-auto"}),e[7]||(e[7]=t("p",{class:"text-gray-500 mt-2"},"Aucune vente trouvée",-1))])):(n(),i("div",Dt,[(n(!0),i(x,null,g(w.value,s=>(n(),i("div",{key:s.id,class:"hover:bg-gray-50 transition-colors"},[t("button",{onClick:r=>G(s.id),class:"w-full px-4 py-4 flex items-center gap-4 text-left"},[t("div",Lt,[t("p",jt,o(j(s.created_at)),1),t("p",At,o(U(s.created_at)),1)]),t("div",Mt,[t("span",Pt,[l(d(N),{class:"w-3.5 h-3.5"}),p(" "+o(s.ticket_number),1)])]),t("div",Vt,[t("p",Bt,o(s.client?.first_name)+" "+o(s.client?.last_name),1),s.vendor?(n(),i("p",Rt," Vendeur: "+o(s.vendor.first_name)+" "+o(s.vendor.last_name),1)):S("",!0)]),t("div",zt,[(n(!0),i(x,null,g(s.payments,r=>(n(),i("span",{key:r.method,class:"inline-flex items-center gap-1 px-2 py-1 bg-gray-50 rounded text-xs text-gray-600"},[(n(),C(T(A(r.method)),{class:"w-3.5 h-3.5"})),p(" "+o(M(r.method)),1)]))),128))]),t("div",It,[t("p",Nt,o(s.total.toFixed(2))+"€",1),t("p",Ht,o(j(s.created_at)),1)]),(n(),C(T(b.value===s.id?d(ct):d(et)),{class:"w-5 h-5 text-gray-400 flex-shrink-0"}))],8,Et),l(B,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 max-h-0","enter-to-class":"opacity-100 max-h-96","leave-active-class":"transition-all duration-150 ease-in","leave-from-class":"opacity-100 max-h-96","leave-to-class":"opacity-0 max-h-0"},{default:V(()=>[b.value===s.id?(n(),i("div",$t,[t("div",Ot,[t("div",null,[e[8]||(e[8]=t("p",{class:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2"},"Articles",-1)),t("div",Gt,[(n(!0),i(x,null,g(s.items,r=>(n(),i("div",{key:r.id,class:"flex items-center justify-between text-sm"},[t("span",Ut,o(r.quantity)+"x "+o(r.product_name),1),t("span",Qt,o(r.subtotal_ttc.toFixed(2))+"€",1)]))),128))])]),t("div",Xt,[t("div",Zt,[e[9]||(e[9]=t("span",{class:"text-gray-500"},"Sous-total HT",-1)),t("span",Jt,o(s.subtotal_ht.toFixed(2))+"€",1)]),t("div",Kt,[e[10]||(e[10]=t("span",{class:"text-gray-500"},"TVA",-1)),t("span",Wt,o(s.total_tva.toFixed(2))+"€",1)]),s.discount_amount>0?(n(),i("div",Yt,[e[11]||(e[11]=t("span",{class:"text-gray-500"},"Remise",-1)),t("span",te,"-"+o(s.discount_amount.toFixed(2))+"€",1)])):S("",!0),t("div",ee,[e[12]||(e[12]=t("span",{class:"text-gray-900"},"Total",-1)),t("span",se,o(s.total.toFixed(2))+"€",1)])]),t("div",ae,[t("div",oe,[e[13]||(e[13]=t("span",{class:"text-xs font-semibold text-gray-500 uppercase tracking-wider"},"Paiement",-1)),(n(!0),i(x,null,g(s.payments,r=>(n(),i("span",{key:r.method,class:"inline-flex items-center gap-1 px-2 py-1 bg-white rounded-lg text-sm text-gray-700 border border-gray-200"},[(n(),C(T(A(r.method)),{class:"w-4 h-4"})),p(" "+o(M(r.method))+" — "+o(r.amount.toFixed(2))+"€ ",1)]))),128))]),t("button",{onClick:st(r=>Q(s),["stop"]),class:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"},[l(d(ot),{class:"w-4 h-4"}),e[14]||(e[14]=p(" Modifier le paiement ",-1))],8,ne)])])])):S("",!0)]),_:2},1024)]))),128))]))])]),l(B,{"enter-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition-opacity duration-150","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:V(()=>[m.value?(n(),i("div",re,[t("div",ie,[t("div",le,[e[15]||(e[15]=t("h3",{class:"text-lg font-bold text-gray-900"},"Modifier le mode de paiement",-1)),t("button",{onClick:D,class:"p-2 text-gray-500 hover:bg-gray-100 rounded-lg"},[l(d(nt),{class:"w-5 h-5"})])]),t("div",de,[t("p",ce,[e[16]||(e[16]=p(" Ticket ",-1)),t("span",ue,o(m.value.ticket_number),1),e[17]||(e[17]=p(" — Total ",-1)),t("span",me,o(m.value.total.toFixed(2))+"€",1)]),t("div",null,[e[18]||(e[18]=t("label",{class:"block text-xs font-semibold text-gray-600 uppercase tracking-wider mb-2"},"Nouveau mode de paiement",-1)),t("div",xe,[(n(),i(x,null,g($,s=>t("button",{key:s.id,onClick:r=>f.value=s.id,class:E(["flex flex-col items-center gap-1.5 p-3 rounded-xl border-2 transition-colors",f.value===s.id?"border-gray-900 bg-gray-50 text-gray-900":"border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50"])},[(n(),C(T(s.icon),{class:"w-5 h-5"})),t("span",pe,o(s.label),1)],10,ge)),64))])])]),t("div",ye,[t("button",{onClick:D,class:"flex-1 px-4 py-2.5 border border-gray-300 rounded-xl hover:bg-gray-50 font-medium"}," Annuler "),t("button",{onClick:X,disabled:_.value,class:"flex-1 px-4 py-2.5 bg-gray-900 text-white rounded-xl hover:bg-gray-800 font-medium disabled:opacity-50"},o(_.value?"Enregistrement...":"Enregistrer"),9,fe)])])])):S("",!0)]),_:1})]))}});export{Fe as default};
