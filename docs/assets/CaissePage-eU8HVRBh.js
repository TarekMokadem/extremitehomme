import{c as fe,a as z,r as T,s as R,i as Ae,d as ke,u as Ne,o as pt,b as De,w as Ce,e as c,f as e,t as v,g as s,F as te,h as le,n as O,j as _,E as gt,k as B,l as ue,m as ye,p as yt,q as Fe,v as n,x as Ie,T as Me,y as vt,P as Je,z as be,A as he,B as nt,C as xt,D as bt,H as ht,L as ft}from"./index-CpCraQre.js";import{u as Xe,U as at,M as kt}from"./useLoyalty-BU0xPkDI.js";import{u as _t,P as wt,I as rt,S as $t,f as st,a as He}from"./formatInputs-BVr2tbtG.js";import{P as Ct}from"./printer-LYQX7Vz6.js";import{M as St}from"./mail-BDfT9EY8.js";import{B as Tt,S as Pt,G as it,H as Et}from"./smartphone-BKXJDGyi.js";import{C as ot}from"./credit-card-CS8YNAa3.js";import{M as dt,C as It}from"./minus-DKQkdFgr.js";import{P as et}from"./plus-Dltqr1d0.js";import{T as ct}from"./trash-2-CMpY8X09.js";import{C as Mt}from"./clock-DfJY2ws7.js";import{_ as Nt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{X as jt}from"./x-B3ZKbJQD.js";import{S as qt}from"./shopping-bag-CbXgWhQh.js";import{S as Ve}from"./search-oaPwFdEZ.js";import{S as Rt}from"./shopping-cart-D5oT2v6k.js";const At=fe("barcode",[["path",{d:"M3 5v14",key:"1nt18q"}],["path",{d:"M8 5v14",key:"1ybrkv"}],["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"M17 5v14",key:"ycjyhj"}],["path",{d:"M21 5v14",key:"nzette"}]]);const Ye=fe("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);const ut=fe("rotate-ccw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);const Ft=fe("user-pen",[["path",{d:"M11.5 15H7a4 4 0 0 0-4 4v2",key:"15lzij"}],["path",{d:"M21.378 16.626a1 1 0 0 0-3.004-3.004l-4.01 4.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z",key:"1817ys"}],["circle",{cx:"10",cy:"7",r:"4",key:"e45bow"}]]);const Vt=fe("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);const Dt=fe("wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.106-3.105c.32-.322.863-.22.983.218a6 6 0 0 1-8.259 7.057l-7.91 7.91a1 1 0 0 1-2.999-3l7.91-7.91a6 6 0 0 1 7.057-8.259c.438.12.54.662.219.984z",key:"1ngwbx"}]]);const Lt=fe("zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);async function mt(w){const l=new TextEncoder().encode(w),x=await crypto.subtle.digest("SHA-256",l);return Array.from(new Uint8Array(x)).map(E=>E.toString(16).padStart(2,"0")).join("")}async function zt(w,l,x,q){const E=[w,l,x.toFixed(2),q??""].join("|");return mt(E)}async function lt(w,l,x,q,E){const $=[w,l,x,q??"",E??""].join("|");return mt($)}const se=T([]),Te=T("euro"),pe=T(0),$e=T(null),de=T([]),Ue=T([]),Oe=T(!1),xe=T(null),Bt=.2;function Le(){const w=(t,a,r)=>{if(t.type!=="product")return 1/0;const N=se.value.filter(Y=>Y.product.id===t.id&&Y.lineId!==a&&(Y.stockCategory??"sale")===(r??"sale")).reduce((Y,_e)=>Y+_e.quantity,0),re=r==="technical"?t.stock_technical??0:t.stock??0;return Math.max(0,re-N)},l=(t,a=1,r,N="sale")=>{const re=w(t,void 0,N),Y=t.type==="product"?Math.min(a,re):a;if(Y<=0)return;const we={lineId:`line-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,product:t,quantity:Y,vendor_id:r?.id,vendor:r,stockCategory:N,price_ht:t.price_ht,tva_rate:t.tva_rate||Bt,subtotal_ht:0,tva:0,subtotal_ttc:0};x(we),se.value.push(we)},x=t=>{const a=t.fixedPriceTTC??t.product.price_ttc;t.subtotal_ttc=a*t.quantity;const r=1+t.tva_rate;t.subtotal_ht=t.subtotal_ttc/r,t.tva=t.subtotal_ttc-t.subtotal_ht,t.price_ht=t.subtotal_ht/t.quantity},q=t=>se.value.find(a=>a.lineId===t),E=(t,a)=>{const r=q(t);r&&(a==null||a<0?delete r.fixedPriceTTC:r.fixedPriceTTC=a,x(r))},$=(t,a)=>{const r=q(t);r&&(r.vendor_id=a?.id,r.vendor=a??void 0)},A=(t,a)=>{const r=q(t);if(r)if(a<=0)Q(t);else{const N=r.product.type==="product"?w(r.product,t)+r.quantity:a;r.quantity=Math.min(a,N),x(r)}},Q=t=>{se.value=se.value.filter(a=>a.lineId!==t)},F=()=>{se.value=[],pe.value=0,$e.value=null,de.value=[]},o=z(()=>se.value.reduce((t,a)=>t+a.subtotal_ht,0)),i=z(()=>se.value.reduce((t,a)=>t+a.tva,0)),f=z(()=>o.value+i.value),j=z(()=>{if(pe.value<=0)return 0;if(Te.value==="euro")return Math.min(pe.value,f.value);{const t=Math.min(pe.value,100);return f.value*t/100}}),P=z(()=>$e.value!=null&&$e.value>=0?$e.value:Math.max(0,f.value-j.value)),M=z(()=>se.value.reduce((t,a)=>t+a.quantity,0)),K=z(()=>se.value.length===0),W=(t,a)=>{Te.value=t,pe.value=Math.max(0,a)},J=()=>{Te.value="euro",pe.value=0},b=t=>{$e.value=t},u=(t,a)=>{const r=de.value.find(N=>N.method===t);r?r.amount+=a:de.value.push({method:t,amount:a})},g=(t,a)=>{const r=de.value.find(N=>N.method===t);r?r.amount=a:de.value.push({method:t,amount:a})},C=t=>{de.value=de.value.filter(a=>a.method!==t)},G=()=>{de.value=[]},h=z(()=>de.value.reduce((t,a)=>t+a.amount,0)),D=z(()=>Math.max(0,P.value-h.value)),X=z(()=>Math.max(0,h.value-P.value)),oe=z(()=>h.value>=P.value&&P.value>0),S=()=>{const t=new Date,a=t.toISOString().split("T")[0].replace(/-/g,""),r=t.getTime().toString().slice(-4);return`T-${a}-${r}`};return{cartItems:se,discountType:Te,discountValue:pe,selectedPaymentMethods:de,recentSales:Ue,isProcessing:Oe,error:xe,subtotalHT:o,totalTVA:i,subtotalTTC:f,discountAmount:j,total:P,itemCount:M,isEmpty:K,totalPaid:h,remainingToPay:D,change:X,isPaymentComplete:oe,addToCart:l,updateQuantity:A,removeFromCart:Q,getMaxQuantityForItem:t=>t.product.type!=="product"?1/0:w(t.product,t.lineId,t.stockCategory)+t.quantity,setItemFixedPrice:E,setItemVendor:$,clearCart:F,setDiscount:W,clearDiscount:J,setFixedTotal:b,fixedTotal:$e,addPayment:u,setPayment:g,removePayment:C,clearPayments:G,validateSale:async(t,a)=>{if(K.value)return xe.value="Le panier est vide",null;if(!a)return xe.value="Veuillez sélectionner ou créer un client avant de valider",null;if(!oe.value)return xe.value="Le paiement n'est pas complet",null;if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t))return xe.value="Aucun vendeur sélectionné. Veuillez sélectionner un vendeur.",console.error("vendorId invalide:",t),null;Oe.value=!0,xe.value=null,console.log("Validation vente - vendorId:",t,"clientId:",a);try{if(Ae()){const d=new Map;for(const U of se.value)if(U.product.type==="product"){const ee=U.stockCategory??"sale",ce=`${U.product.id}|${ee}`,Z=d.get(ce);Z?Z.qty+=U.quantity:d.set(ce,{qty:U.quantity,name:U.product.name,stockCat:ee})}for(const[U,{qty:ee,name:ce,stockCat:Z}]of d){const ve=U.split("|")[0],qe=Z==="technical"?"stock_technical":"stock",{data:Se,error:Re}=await R.from("products").select(`${qe}`).eq("id",ve).single();if(Re||!Se)throw new Error(`Produit ${ce} introuvable`);const tt=Se[qe]??0;if(tt<ee)throw new Error(`Stock insuffisant pour "${ce}" (${Z==="technical"?"technique":"vente"}) : ${tt} en stock, ${ee} demandé`)}}let N;if(Ae()){const{data:d}=await R.rpc("generate_ticket_number");N=d||S()}const re=new Date().toISOString();let Y=null;if(Ae()){const{data:d}=await R.from("sales").select("hash").eq("status","completed").order("created_at",{ascending:!1}).limit(1).maybeSingle();Y=d?.hash??null}const _e=await zt(N,re,P.value,Y),we={ticket_number:N,vendor_id:t,client_id:a||null,subtotal_ht:o.value,total_tva:i.value,subtotal_ttc:f.value,discount_type:Te.value,discount_value:pe.value,discount_amount:j.value,total:P.value,status:"completed",hash:_e,previous_hash:Y,created_at:re},ze=se.value.map(d=>({product_id:d.product.id,variant_id:d.variant?.id||null,vendor_id:d.vendor_id||t,product_name:d.product.name,price_ht:d.price_ht,tva_rate:d.tva_rate,quantity:d.quantity,subtotal_ht:d.subtotal_ht,tva:d.tva,subtotal_ttc:d.subtotal_ttc})),Be=de.value.map(d=>({method:d.method,amount:d.amount}));Ae();const{data:me,error:H}=await R.from("sales").insert(we).select().single();if(H)throw H;const m=ze.map(d=>({...d,sale_id:me.id})),{error:k}=await R.from("sale_items").insert(m);if(k)throw k;const L=Be.map(d=>({...d,sale_id:me.id})),{error:I}=await R.from("payments").insert(L);if(I)throw I;for(const d of se.value)if(d.product.type==="product"){const U=d.stockCategory??"sale",ee=U==="technical"?"stock_technical":"stock",{data:ce,error:Z}=await R.from("products").select(`${ee}`).eq("id",d.product.id).single();if(Z||!ce)throw new Error(`Produit ${d.product.name} introuvable`);const ve=ce[ee]??0;if(ve<d.quantity)throw new Error(`Stock insuffisant pour "${d.product.name}" (${U==="technical"?"technique":"vente"}) : ${ve} en stock, ${d.quantity} demandé`);const qe=ve-d.quantity,{error:Se}=await R.from("products").update({[ee]:qe,updated_at:new Date().toISOString()}).eq("id",d.product.id);if(Se)throw Se;const{error:Re}=await R.from("stock_movements").insert({product_id:d.product.id,variant_id:d.variant?.id||null,type:"out",quantity:-d.quantity,reason:U==="technical"?"Utilisation technique":"Vente",reference_id:me.id,vendor_id:t,stock_type:U});if(Re)throw Re}try{const{data:d}=await R.from("settings").select("value").eq("key","grand_total").maybeSingle(),ee=(typeof d?.value=="number"?d.value:0)+P.value;await R.from("settings").upsert({key:"grand_total",value:ee,updated_at:new Date().toISOString()},{onConflict:"key"})}catch(d){console.warn("NF525: erreur mise à jour GT —",d)}try{const{data:d}=await R.from("audit_logs").select("hash").order("created_at",{ascending:!1}).limit(1).maybeSingle(),U=new Date().toISOString(),ee=await lt(U,"sale_created","sales",me.id,d?.hash??null);await R.from("audit_logs").insert({timestamp:U,event_type:"sale_created",table_name:"sales",record_id:me.id,old_data:null,new_data:{ticket_number:N,total:P.value},vendor_id:t,hash:ee,previous_hash:d?.hash??null})}catch(d){console.warn("NF525: erreur audit log —",d)}if(a){const{data:d}=await R.from("clients").select("visit_count, total_spent, loyalty_points").eq("id",a).single();d&&await R.from("clients").update({visit_count:d.visit_count+1,total_spent:d.total_spent+P.value,last_visit_at:new Date().toISOString()}).eq("id",a)}return Ue.value.unshift(me),F(),me}catch(N){return console.error("Erreur validation vente:",N),xe.value=N.message||"Erreur lors de la validation",null}finally{Oe.value=!1}},loadRecentSales:async(t=10)=>{try{const{data:a,error:r}=await R.from("sales").select(`
          *,
          vendor:vendors(*),
          client:clients(*),
          items:sale_items(*),
          payments(*)
        `).order("created_at",{ascending:!1}).limit(t);if(r)throw r;return Ue.value=a||[],a}catch(a){return console.error("Erreur chargement ventes:",a),[]}},getSaleById:async t=>{try{const{data:a,error:r}=await R.from("sales").select(`
          *,
          vendor:vendors(*),
          client:clients(*),
          items:sale_items(*, product:products(*)),
          payments(*)
        `).eq("id",t).single();return r?null:a}catch{return null}},cancelSale:async(t,a)=>{try{const{error:r}=await R.from("sales").update({status:"cancelled",notes:a}).eq("id",t);if(r)throw r;try{const{data:N}=await R.from("audit_logs").select("hash").order("created_at",{ascending:!1}).limit(1).maybeSingle(),re=new Date().toISOString(),Y=await lt(re,"sale_cancelled","sales",t,N?.hash??null);await R.from("audit_logs").insert({timestamp:re,event_type:"sale_cancelled",table_name:"sales",record_id:t,old_data:{status:"completed"},new_data:{status:"cancelled",reason:a},vendor_id:null,hash:Y,previous_hash:N?.hash??null})}catch(N){console.warn("NF525: erreur audit annulation —",N)}return!0}catch(r){return console.error("Erreur annulation vente:",r),!1}}}}const Ht=[{id:"1",first_name:"Jean",last_name:"Dupont",phone:"06 12 34 56 78",phone2:null,email:"jean.dupont@email.com",address:"123 Rue de la Paix",city:"Paris",postal_code:"75001",birth_date:"1985-03-15",notes:"Client fidèle",company:null,loyalty_points:150,total_spent:450,visit_count:15,last_visit_at:"2026-01-15",created_at:"",updated_at:""},{id:"2",first_name:"Marie",last_name:"Martin",phone:"06 98 76 54 32",phone2:"01 23 45 67 89",email:"marie.martin@email.com",address:"456 Avenue des Champs",city:"Lyon",postal_code:"69001",birth_date:"1990-07-22",notes:null,company:null,loyalty_points:75,total_spent:225,visit_count:8,last_visit_at:"2026-01-20",created_at:"",updated_at:""},{id:"3",first_name:"Pierre",last_name:"Bernard",phone:"07 11 22 33 44",phone2:null,email:null,address:null,city:null,postal_code:null,birth_date:null,notes:"Préfère les rendez-vous le samedi",company:null,loyalty_points:30,total_spent:90,visit_count:3,last_visit_at:"2026-01-10",created_at:"",updated_at:""}],Ke=T([]),Ge=T(null),Qe=T(!1),We=T(!1),Pe=T(null);function je(){return{clients:Ke,selectedClient:Ge,invoiceInCompanyName:Qe,isLoading:We,error:Pe,loadClients:async()=>{We.value=!0,Pe.value=null;try{const{data:o,error:i}=await R.from("clients").select("*").order("last_name");if(i)throw i;Ke.value=o||[]}catch(o){console.error("Erreur chargement clients:",o),Pe.value=o.message,Ke.value=Ht}finally{We.value=!1}},searchClients:async o=>{if(!o||o.length<2)return[];try{const{data:i,error:f}=await R.from("clients").select("*").or(`first_name.ilike.%${o}%,last_name.ilike.%${o}%,phone.ilike.%${o}%`).limit(10);if(f)throw f;return i||[]}catch(i){return console.error("Erreur recherche clients:",i),[]}},getClientById:async o=>{try{const{data:i,error:f}=await R.from("clients").select("*").eq("id",o).single();return f?null:i}catch{return null}},createClient:async o=>{console.log("createClient appelé avec:",o);try{console.log("Insertion dans Supabase...");const{data:i,error:f}=await R.from("clients").insert({first_name:o.first_name,last_name:o.last_name,phone:o.phone,phone2:o.phone2||null,email:o.email||null,address:o.address||null,city:o.city||null,postal_code:o.postal_code||null,birth_date:o.birth_date||null,notes:o.notes||null,company:o.company??null}).select().single();if(f)throw console.error("Erreur Supabase:",f),f;return console.log("Client créé avec succès:",i),i}catch(i){return console.error("Erreur création client:",i),Pe.value=i.message,null}},updateClient:async(o,i)=>{console.log("updateClient appelé avec:",o,i);try{const{data:f,error:j}=await R.from("clients").update(i).eq("id",o).select().single();if(j)throw j;return console.log("Client mis à jour:",f),f}catch(f){return console.error("Erreur mise à jour client:",f),Pe.value=f.message,null}},selectClient:o=>{Ge.value=o},setInvoiceInCompanyName:o=>{Qe.value=o},clearSelection:()=>{Ge.value=null,Qe.value=!1},updateClientAfterSale:async(o,i)=>{try{const{data:f}=await R.from("clients").select("visit_count, total_spent").eq("id",o).single();f&&await R.from("clients").update({visit_count:f.visit_count+1,total_spent:f.total_spent+i,last_visit_at:new Date().toISOString()}).eq("id",o)}catch(f){console.error("Erreur mise à jour client après vente:",f)}}}}function Ze(w){return w.toFixed(2).replace(".",",")}function Ut(w){const{header:l,dateTime:x,items:q,total:E,discount:$,footer:A}=w,Q=q.map(o=>`
    <div class="receipt-line">
      <span class="receipt-item">${ge(o.vendorName?`${o.vendorName} `:"")}${ge(o.label)}</span>
      <span class="receipt-price">${Ze(o.amount)}</span>
    </div>`).join(""),F=$!=null&&$>0?`
    <div class="receipt-line receipt-total">
      <span class="receipt-item">Gratuit / Réduction</span>
      <span class="receipt-price">-${Ze($)}</span>
    </div>`:"";return`
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ticket</title>
  <style>
    @page { size: 80mm 297mm; margin: 0; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
      line-height: 1.3;
      width: 80mm;
      max-width: 80mm;
      padding: 4mm;
      color: #000;
      background: #fff;
    }
    .receipt-header { text-align: center; margin-bottom: 6px; }
    .receipt-header .name { font-weight: bold; font-size: 14px; }
    .receipt-header .address, .receipt-header .phone { font-size: 11px; }
    .receipt-date { margin-bottom: 6px; font-size: 11px; }
    .receipt-line {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 2px;
      font-size: 11px;
    }
    .receipt-item { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .receipt-price { flex-shrink: 0; text-align: right; }
    .receipt-total { font-weight: bold; margin-top: 4px; padding-top: 4px; border-top: 1px dashed #000; }
    .receipt-footer { text-align: center; margin-top: 8px; font-size: 11px; }
  </style>
</head>
<body>
  <div class="receipt-header">
    <div class="name">${ge(l.name)}</div>
    ${l.address?`<div class="address">${ge(l.address)}</div>`:""}
    ${l.city?`<div class="address">${ge(l.city)}</div>`:""}
    ${l.phone?`<div class="phone">${ge(l.phone)}</div>`:""}
  </div>
  <div class="receipt-date">${ge(x)}</div>
  ${Q}
  ${F}
  <div class="receipt-line receipt-total">
    <span class="receipt-item">TOTAL</span>
    <span class="receipt-price">${Ze(E)} €</span>
  </div>
  ${A?`<div class="receipt-footer">${ge(A)}</div>`:'<div class="receipt-footer">Merci de votre visite</div>'}
</body>
</html>`}function ge(w){const l=document.createElement("div");return l.textContent=w,l.innerHTML}function Ot(w){const l=Ut(w),x=window.open("","_blank","width=400,height=600");if(!x){alert("Autorisez les pop-ups pour imprimer le ticket.");return}x.document.write(l),x.document.close(),x.focus(),setTimeout(()=>{x.print(),x.close()},250)}const Kt={class:"card h-full flex flex-col overflow-hidden"},Gt={class:"p-4 md:p-5 border-b border-gray-200 bg-gray-50 dark:bg-gray-800 dark:border-gray-700"},Qt={class:"flex items-center justify-between"},Wt={class:"text-xs md:text-sm font-semibold text-gray-900 dark:text-gray-100"},Zt={class:"flex-1 overflow-y-auto p-4 md:p-5 space-y-2 md:space-y-3 min-h-0"},Jt={class:"flex items-start justify-between gap-2 md:gap-3 mb-2 md:mb-3"},Yt={class:"flex-1 min-w-0"},Xt={class:"font-medium text-gray-900 dark:text-gray-100 line-clamp-2 text-xs md:text-sm leading-snug"},ea={class:"flex items-center gap-1.5 mt-0.5 flex-wrap"},ta={key:0,class:"inline-flex px-1.5 py-0.5 rounded text-[9px] font-semibold bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300"},aa={class:"text-[10px] text-gray-500 dark:text-gray-400 flex items-center gap-1"},ra=["value","onChange"],sa=["value"],oa={class:"font-bold text-gray-900 dark:text-gray-100 whitespace-nowrap text-sm md:text-base tabular-nums"},la={class:"flex items-center gap-2 mb-2"},na=["value","onInput"],ia={class:"flex items-center justify-between"},da={class:"flex items-center gap-2"},ca=["onClick"],ua={class:"w-7 md:w-9 text-center text-xs md:text-sm font-semibold tabular-nums text-gray-900 dark:text-gray-100"},ma=["onClick","disabled"],pa=["onClick"],ga={key:1,class:"h-full flex items-center justify-center py-8"},ya={class:"px-4 py-3 md:px-5 md:py-4 border-t border-gray-100 dark:border-gray-700"},va={class:"flex flex-col gap-2 md:gap-3"},xa={class:"flex items-center justify-between gap-2"},ba={class:"inline-flex items-center bg-gray-100 dark:bg-gray-700 rounded-full p-0.5 shadow-inner border border-gray-200 dark:border-gray-600"},ha={class:"flex items-center gap-2"},fa=["value","max"],ka={class:"text-xs md:text-sm font-medium text-gray-500 dark:text-gray-400 min-w-[24px] md:min-w-[32px] text-center"},_a={class:"px-4 py-3 md:px-5 md:py-4 border-t border-gray-100 dark:border-gray-700"},wa={class:"flex flex-col gap-2"},$a={class:"flex items-center gap-2"},Ca=["value"],Sa={class:"px-4 py-3 md:px-5 md:py-4 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800"},Ta={class:"grid grid-cols-3 md:grid-cols-2 gap-1.5 md:gap-2"},Pa=["onClick"],Ea={class:"font-medium truncate"},Ia={class:"p-4 md:p-5 border-t-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"},Ma={class:"space-y-2 md:space-y-2.5 mb-3 md:mb-4"},Na={class:"flex justify-between text-xs md:text-sm"},ja={class:"text-gray-700 dark:text-gray-300 tabular-nums"},qa={class:"flex justify-between text-xs md:text-sm"},Ra={class:"text-gray-700 dark:text-gray-300 tabular-nums"},Aa={class:"flex justify-between text-xs md:text-sm font-medium"},Fa={class:"text-gray-900 dark:text-gray-100 tabular-nums"},Va={key:0,class:"flex justify-between text-xs md:text-sm"},Da={class:"text-gray-600 dark:text-gray-400"},La={class:"text-[10px] md:text-xs"},za={class:"text-red-600 dark:text-red-400 font-medium tabular-nums"},Ba={class:"flex justify-between text-xl md:text-2xl font-bold pt-2 md:pt-3 border-t border-gray-200 dark:border-gray-600"},Ha={class:"text-gray-900 dark:text-gray-100 tabular-nums"},Ua={class:"grid grid-cols-4 gap-1.5 md:gap-2"},Oa=["disabled"],Ka=["disabled"],Ga=["disabled"],Qa={key:0,class:"animate-spin"},Wa=ke({__name:"TicketPanel",setup(w){const{cartItems:l,subtotalHT:x,totalTVA:q,subtotalTTC:E,total:$,discountAmount:A,fixedTotal:Q,setFixedTotal:F,updateQuantity:o,removeFromCart:i,setItemFixedPrice:f,setItemVendor:j,clearCart:P,setDiscount:M,setPayment:K,clearPayments:W,validateSale:J,isProcessing:b,getMaxQuantityForItem:u,error:g}=Le(),{vendor:C,loadVendors:G}=Ne(),{selectedClient:h}=je(),D=T([]);pt(async()=>{D.value=await G()});const{loadProducts:X}=De(),{saveStamps:oe,loadClientStamps:S}=Xe(),{salonInfo:p,ticketHeader:y,ticketFooter:ne}=_t(),ie=T("euro"),ae=T(0),t=T("card"),a=[{id:"cash",label:"Espèces",icon:Tt,color:"bg-green-600 border-green-600 text-white"},{id:"card",label:"CB",icon:ot,color:"bg-blue-600 border-blue-600 text-white"},{id:"contactless",label:"Sans contact",icon:Pt,color:"bg-violet-600 border-violet-600 text-white"},{id:"amex",label:"American Express",icon:ot,color:"bg-red-600 border-red-600 text-white"},{id:"check",label:"Chèque",icon:yt,color:"bg-gray-600 border-gray-600 text-white"},{id:"gift_card",label:"Chèque Cadeau",icon:it,color:"bg-yellow-500 border-yellow-500 text-black"},{id:"free",label:"Gratuit",icon:Et,color:"bg-orange-500 border-orange-500 text-white"}],r=H=>H.toFixed(2),N=H=>{ie.value=H,H==="percent"&&(ae.value=Math.min(ae.value,100)),M(ie.value,ae.value)},re=H=>{const m=H.target,k=Number(m.value);ie.value==="percent"?ae.value=Math.min(k,100):ae.value=Math.min(k,E.value),M(ie.value,ae.value)},Y=H=>{t.value=H,W(),K(H,$.value)};Ce([$,t],()=>{$.value>0&&t.value&&K(t.value,$.value)},{immediate:!0});const _e=async()=>{if(l.value.length===0)return;if(!h.value){alert("Veuillez sélectionner ou créer un client avant de valider la vente.");return}K(t.value,$.value);const H=await J(C.value?.id||"demo",h.value?.id);H?(h.value&&C.value&&(await oe(h.value.id,C.value.id,H.id),await S(h.value.id)),await X(),alert(`✅ Vente validée !
Ticket: ${H.ticket_number}
Total: ${r(H.total)}€`)):g.value&&alert(`❌ Erreur : ${g.value}`)},we=z(()=>new Date().toLocaleDateString("fr-FR")),ze=z(()=>ie.value==="percent"?100:E.value);z(()=>E.value);const Be=()=>{if(l.value.length===0)return;const m=new Date().toLocaleDateString("fr-FR"),k=p.value.name||"Extrémités Homme",L=`Facture ${m} - ${k}`,I=[];I.push(k),I.push("─".repeat(30)),I.push(`Date : ${m}`),I.push(""),I.push("Articles :");for(const Z of l.value){const ve=Z.vendor?` (${Z.vendor.initials||`${Z.vendor.first_name?.[0]??""}${Z.vendor.last_name?.[0]??""}`})`:"";I.push(`  ${Z.product.name}${ve}`),I.push(`    ${Z.quantity} x ${r(Z.subtotal_ttc/Z.quantity)}€ = ${r(Z.subtotal_ttc)}€`)}I.push(""),I.push(`Sous-total HT : ${r(x.value)}€`),I.push(`TVA (20%) : ${r(q.value)}€`),I.push(`Sous-total TTC : ${r(E.value)}€`),A.value>0&&I.push(`Réduction : -${r(A.value)}€`),I.push("─".repeat(30)),I.push(`TOTAL : ${r($.value)}€`),I.push("");const d=a.find(Z=>Z.id===t.value);I.push(`Règlement : ${d?.label||t.value}`),h.value&&(I.push(""),I.push(`Client : ${h.value.first_name} ${h.value.last_name}`)),I.push(""),I.push("Merci de votre visite !");const U=I.join(`
`),ee=h.value?.email||"",ce=`mailto:${encodeURIComponent(ee)}?subject=${encodeURIComponent(L)}&body=${encodeURIComponent(U)}`;window.location.href=ce},me=()=>{if(l.value.length===0)return;const H=new Date,m=H.toISOString().slice(0,10),k=H.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),L=l.value.map(I=>{const d=I.vendor,U=d?`${d.first_name??""} ${d.last_name??""}`.trim():void 0;return{label:I.product.name,vendorName:U||void 0,amount:I.subtotal_ttc}});Ot({header:{name:y.value.line1||p.value.name,address:p.value.address,phone:p.value.phone},dateTime:`${m} ${k}`,items:L,subtotal:E.value,discount:A.value>0?A.value:void 0,total:$.value,footer:ne.value.line1||"Merci de votre visite"})};return(H,m)=>(n(),c("div",Kt,[e("div",Gt,[e("div",Qt,[e("div",null,[m[5]||(m[5]=e("p",{class:"text-[10px] md:text-[11px] text-gray-500 uppercase tracking-wider font-semibold mb-1 dark:text-gray-400"},"Date",-1)),e("p",Wt,v(we.value),1)]),m[6]||(m[6]=e("div",{class:"text-right"},[e("p",{class:"text-[10px] md:text-[11px] text-gray-500 uppercase tracking-wider font-semibold mb-1 dark:text-gray-400"},"Ticket"),e("p",{class:"text-xs md:text-sm font-semibold text-gray-900 dark:text-gray-100"},"#001")],-1))])]),e("div",Zt,[s(l).length>0?(n(!0),c(te,{key:0},le(s(l),k=>(n(),c("div",{key:k.lineId,class:"cart-item"},[e("div",Jt,[e("div",Yt,[e("p",Xt,v(k.product.name),1),e("div",ea,[k.stockCategory==="technical"?(n(),c("span",ta,"TECH")):B("",!0),e("p",aa,[m[8]||(m[8]=e("span",null,"Vendeur:",-1)),e("select",{value:k.vendor_id??"",onChange:L=>{const I=L.target.value;s(j)(k.lineId,I?D.value.find(d=>d.id===I)??null:null)},class:"text-[10px] md:text-xs px-2 py-0.5 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 focus:outline-none focus:ring-1 focus:ring-gray-400 min-w-0 max-w-full"},[m[7]||(m[7]=e("option",{value:""},"—",-1)),(n(!0),c(te,null,le(D.value,L=>(n(),c("option",{key:L.id,value:L.id},v(L.initials||`${L.first_name?.[0]??""}${L.last_name?.[0]??""}`)+" — "+v(L.first_name)+" "+v(L.last_name),9,sa))),128))],40,ra)])])]),e("p",oa,v(r(k.subtotal_ttc))+"€ ",1)]),e("div",la,[m[9]||(m[9]=e("label",{class:"text-[10px] text-gray-500 dark:text-gray-400 shrink-0"},"Prix unit. (€)",-1)),e("input",{type:"number",value:k.fixedPriceTTC??"",onInput:L=>{const I=L.target.value;s(f)(k.lineId,I===""?null:Math.max(0,Number(I)))},min:"0",step:"0.01",placeholder:"Prix libre",class:"flex-1 min-w-0 px-2 py-1.5 text-[11px] bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 tabular-nums"},null,40,na)]),e("div",ia,[e("div",da,[e("button",{onClick:L=>s(o)(k.lineId,k.quantity-1),class:"w-8 h-8 md:w-9 md:h-9 rounded-lg bg-white border border-gray-300 flex items-center justify-center hover:bg-gray-100 hover:border-gray-400 dark:bg-gray-600 dark:border-gray-500 dark:hover:bg-gray-500 dark:text-gray-100 transition-colors","aria-label":"Diminuer la quantité"},[_(s(dt),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})],8,ca),e("span",ua,v(k.quantity),1),e("button",{onClick:L=>s(o)(k.lineId,k.quantity+1),disabled:k.quantity>=s(u)(k),class:"w-8 h-8 md:w-9 md:h-9 rounded-lg bg-white border border-gray-300 flex items-center justify-center hover:bg-gray-100 hover:border-gray-400 dark:bg-gray-600 dark:border-gray-500 dark:hover:bg-gray-500 dark:text-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Augmenter la quantité"},[_(s(et),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})],8,ma)]),e("button",{onClick:L=>s(i)(k.lineId),class:"p-1.5 md:p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:text-red-400 dark:hover:bg-red-900/30 rounded-lg transition-colors","aria-label":"Supprimer l'article"},[_(s(ct),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})],8,pa)])]))),128)):(n(),c("div",ga,[...m[10]||(m[10]=[e("p",{class:"text-gray-400 dark:text-gray-500 text-xs md:text-sm"},"Aucun article",-1)])]))]),e("div",ya,[e("div",va,[e("div",xa,[m[15]||(m[15]=e("label",{class:"text-xs md:text-sm text-gray-600 dark:text-gray-400 font-medium"},"Réduction",-1)),e("div",ba,[e("button",{onClick:m[0]||(m[0]=k=>N("euro")),class:O(["inline-flex items-center gap-0.5 md:gap-1 px-2 md:px-3 py-1 md:py-1.5 text-[10px] md:text-xs font-semibold rounded-full transition-all duration-150",ie.value==="euro"?"bg-white text-gray-900 shadow-sm dark:bg-gray-600 dark:text-gray-100":"text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"])},[_(s(gt),{class:"w-3 h-3 md:w-3.5 md:h-3.5"}),m[11]||(m[11]=e("span",{class:"hidden sm:inline"},"Montant",-1)),m[12]||(m[12]=e("span",{class:"sm:hidden"},"€",-1))],2),e("button",{onClick:m[1]||(m[1]=k=>N("percent")),class:O(["inline-flex items-center gap-0.5 md:gap-1 px-2 md:px-3 py-1 md:py-1.5 text-[10px] md:text-xs font-semibold rounded-full transition-all duration-150",ie.value==="percent"?"bg-white text-gray-900 shadow-sm dark:bg-gray-600 dark:text-gray-100":"text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"])},[_(s(wt),{class:"w-3 h-3 md:w-3.5 md:h-3.5"}),m[13]||(m[13]=e("span",{class:"hidden sm:inline"},"Pourcentage",-1)),m[14]||(m[14]=e("span",{class:"sm:hidden"},"%",-1))],2)])]),e("div",ha,[e("input",{type:"number",value:ae.value,onInput:re,min:"0",max:ze.value,step:"0.01",class:"flex-1 px-3 md:px-4 py-2 md:py-2.5 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 border border-gray-300 rounded-lg text-xs md:text-sm text-right focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all tabular-nums"},null,40,fa),e("span",ka,v(ie.value==="percent"?"%":"€"),1)])])]),e("div",_a,[e("div",wa,[m[16]||(m[16]=e("label",{class:"text-xs md:text-sm text-gray-600 dark:text-gray-400 font-medium"},"Fixer le prix total (€)",-1)),e("div",$a,[e("input",{type:"number",value:s(Q)??"",onInput:m[2]||(m[2]=k=>{const L=k.target.value;s(F)(L===""?null:Math.max(0,Number(L)))}),min:"0",step:"0.01",placeholder:"Prix libre",class:"flex-1 px-3 md:px-4 py-2 md:py-2.5 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-500 border border-gray-300 rounded-lg text-xs md:text-sm text-right focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 tabular-nums"},null,40,Ca),s(Q)!=null?(n(),c("button",{key:0,type:"button",onClick:m[3]||(m[3]=k=>s(F)(null)),class:"px-2 py-2 text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:text-red-400 dark:hover:bg-red-900/30 rounded-lg text-xs font-medium",title:"Annuler le prix fixé"}," Réinit ")):B("",!0)])])]),e("div",Sa,[m[17]||(m[17]=e("p",{class:"text-[10px] md:text-[11px] text-gray-600 dark:text-gray-400 uppercase tracking-wider font-semibold mb-2 md:mb-3"},"Règlement",-1)),e("div",Ta,[(n(),c(te,null,le(a,k=>e("button",{key:k.id,onClick:L=>Y(k.id),class:O(["payment-btn text-[10px] md:text-xs",t.value===k.id&&k.color])},[(n(),ye(Fe(k.icon),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})),e("span",Ea,v(k.label),1)],10,Pa)),64))])]),e("div",Ia,[e("div",Ma,[e("div",Na,[m[18]||(m[18]=e("span",{class:"text-gray-500 dark:text-gray-400"},"Sous-total HT",-1)),e("span",ja,v(r(s(x)))+"€",1)]),e("div",qa,[m[19]||(m[19]=e("span",{class:"text-gray-500 dark:text-gray-400"},"TVA (20%)",-1)),e("span",Ra,v(r(s(q)))+"€",1)]),e("div",Aa,[m[20]||(m[20]=e("span",{class:"text-gray-600 dark:text-gray-400"},"Sous-total TTC",-1)),e("span",Fa,v(r(s(E)))+"€",1)]),ae.value>0?(n(),c("div",Va,[e("span",Da,[m[21]||(m[21]=ue(" Réduction ",-1)),e("span",La,"("+v(ie.value==="percent"?`${ae.value}%`:`${r(ae.value)}€`)+")",1)]),e("span",za,"-"+v(r(s(A)))+"€",1)])):B("",!0),e("div",Ba,[m[22]||(m[22]=e("span",{class:"text-gray-900 dark:text-gray-100"},"Total",-1)),e("span",Ha,v(r(s($)))+"€",1)])]),e("div",Ua,[e("button",{type:"button",onClick:me,disabled:s(l).length===0,class:"btn-icon-sm p-2 md:p-3 disabled:opacity-50 disabled:cursor-not-allowed",title:"Imprimer le ticket","aria-label":"Imprimer le ticket"},[_(s(Ct),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})],8,Oa),e("button",{type:"button",onClick:Be,disabled:s(l).length===0,class:"btn-icon-sm p-2 md:p-3 disabled:opacity-50 disabled:cursor-not-allowed",title:"Email","aria-label":"Envoyer par email"},[_(s(St),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})],8,Ka),e("button",{onClick:m[4]||(m[4]=(...k)=>s(P)&&s(P)(...k)),class:"btn-icon-sm p-2 md:p-3 text-orange-600 hover:bg-orange-50 hover:border-orange-200 dark:text-orange-400 dark:hover:bg-orange-900/30 dark:hover:border-orange-700",title:"Annuler","aria-label":"Annuler la transaction"},[_(s(ut),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})]),e("button",{onClick:_e,disabled:s(l).length===0||s(b),class:O(["btn-icon-sm p-2 md:p-3",s(l).length>0&&!s(b)?"bg-emerald-600 text-white hover:bg-emerald-700 border-emerald-600 dark:bg-emerald-600 dark:border-emerald-600":"bg-gray-100 text-gray-400 cursor-not-allowed border-gray-200 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-500"]),title:"Valider","aria-label":"Valider la transaction"},[s(b)?(n(),c("span",Qa,"⏳")):(n(),ye(s(Ye),{key:1,class:"w-4 h-4 md:w-5 md:h-5"}))],10,Ga)])])]))}}),Za=["aria-label"],Ja={class:"service-header"},Ya={class:"service-header-left"},Xa={class:"service-code"},er=["aria-label"],tr={class:"service-price"},ar={class:"service-body"},rr={class:"service-name"},sr={key:0,class:"service-duration"},or={class:"hidden sm:inline"},lr={class:"sm:hidden"},nr=ke({__name:"ServiceCard",props:{service:{}},setup(w){const l=w,{addToCart:x,cartItems:q}=Le(),{vendor:E}=Ne(),{getCategoryBorderColor:$}=De(),A=z(()=>{const o=q.value.find(i=>i.product.id===l.service.id);return o?o.quantity:0}),Q=z(()=>$(l.service)),F=()=>{x(l.service,1,E.value??void 0)};return(o,i)=>(n(),c("button",{onClick:F,"aria-label":`Ajouter ${w.service.name} au panier`,class:O(["service-card",Q.value,A.value>0&&"active"])},[e("div",Ja,[e("div",Ya,[e("span",Xa,v(w.service.code),1),A.value>0?(n(),c("span",{key:0,class:"quantity-badge","aria-label":`Quantité: ${A.value}`},v(A.value),9,er)):B("",!0)]),e("span",tr,v(w.service.price_ttc?.toFixed(2)||w.service.price_ht?.toFixed(2))+"€ ",1)]),e("div",ar,[e("h3",rr,v(w.service.name),1),w.service.duration?(n(),c("span",sr,[_(s(Mt),{class:"w-3 h-3 md:w-3.5 md:h-3.5"}),e("span",or,v(w.service.duration)+"min",1),e("span",lr,v(w.service.duration)+"'",1)])):B("",!0)])],10,Za))}}),ir=Nt(nr,[["__scopeId","data-v-61cb5609"]]),dr={class:"card p-4"},cr={class:"flex items-center justify-between mb-3"},ur={class:"flex items-center gap-2"},mr={class:"w-8 h-8 rounded-full bg-yellow-100 dark:bg-yellow-900/40 flex items-center justify-center"},pr={class:"text-xs text-gray-500 dark:text-gray-400"},gr={class:"flex items-center gap-2"},yr=["disabled"],vr=["disabled"],xr={key:3,class:"inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-100 text-green-700 dark:bg-emerald-900/40 dark:text-emerald-300 rounded-full text-xs font-semibold"},br={class:"grid grid-cols-6 sm:grid-cols-12 gap-2 w-full"},hr=["onClick"],fr={key:0,class:"absolute bottom-0.5 left-0 right-0 text-xs text-yellow-700 dark:text-amber-300 font-semibold leading-tight"},kr=ke({__name:"LoyaltyCard",setup(w){const{stamps:l,checkedCount:x,isCardComplete:q,stampsCount:E,toggleStamp:$,addPointsManually:A,removePointsManually:Q,resetPointsToZero:F,loadClientStamps:o}=Xe(),{selectedClient:i}=je(),{vendor:f}=Ne(),j=T(!1),P=z(()=>l.value.filter(u=>u.isStamped&&!u.date).length),M=z(()=>l.value.filter(u=>u.markedForRemoval).length),K=async()=>{if(!(!i.value||!f.value||P.value===0)){j.value=!0;try{const u=await A(i.value.id,f.value.id);u?.success?(await o(i.value.id),alert(`${u.count} point(s) fidélité ajouté(s)`)):alert("Erreur lors de l'ajout des points")}catch{alert("Erreur lors de l'ajout des points")}finally{j.value=!1}}},W=async()=>{if(!(!i.value||M.value===0)&&confirm(`Retirer ${M.value} point(s) fidélité ?`)){j.value=!0;try{const u=await Q(i.value.id);u?.success?(await o(i.value.id),alert(`${u.count} point(s) fidélité retiré(s)`)):alert("Erreur lors du retrait des points")}catch{alert("Erreur lors du retrait des points")}finally{j.value=!1}}},J=async()=>{if(!(!i.value||!confirm("Réinitialiser les points fidélité à 0 ?")))try{await F(i.value.id),await o(i.value.id)}catch{alert("Erreur lors de la réinitialisation")}},b=u=>{if(!u)return"";const g=new Date(u),C=String(g.getDate()).padStart(2,"0"),G=String(g.getMonth()+1).padStart(2,"0"),h=g.getFullYear();return`${C}/${G}/${h}`};return(u,g)=>(n(),c("div",dr,[e("div",cr,[e("div",ur,[e("div",mr,[_(s(it),{class:"w-4 h-4 text-yellow-600 dark:text-yellow-400"})]),g[0]||(g[0]=e("span",{class:"text-sm font-semibold text-gray-900 dark:text-gray-100"},"Carte fidélité",-1)),e("span",pr,v(s(x))+"/"+v(s(E)),1)]),e("div",gr,[s(i)&&P.value>0?(n(),c("button",{key:0,type:"button",onClick:K,disabled:j.value,class:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-yellow-700 bg-yellow-100 hover:bg-yellow-200 dark:text-amber-300 dark:bg-amber-900/50 dark:hover:bg-amber-900/70 rounded-lg transition-colors disabled:opacity-50",title:"Enregistrer les points cochés (sans vente)"},[_(s(et),{class:"w-3.5 h-3.5"}),ue(" "+v(j.value?"Enregistrement...":`+${P.value} point(s)`),1)],8,yr)):B("",!0),s(i)&&M.value>0?(n(),c("button",{key:1,type:"button",onClick:W,disabled:j.value,class:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-red-700 bg-red-100 hover:bg-red-200 dark:text-red-300 dark:bg-red-900/50 dark:hover:bg-red-900/70 rounded-lg transition-colors disabled:opacity-50",title:"Retirer les points sélectionnés"},[_(s(dt),{class:"w-3.5 h-3.5"}),ue(" "+v(j.value?"Retrait...":`-${M.value} point(s)`),1)],8,vr)):B("",!0),s(i)?(n(),c("button",{key:2,type:"button",onClick:J,class:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:text-red-400 dark:hover:bg-red-900/30 rounded-lg transition-colors",title:"Réinitialiser les points à 0"},[_(s(ut),{class:"w-3.5 h-3.5"}),g[1]||(g[1]=ue(" Réinit. points ",-1))])):B("",!0),s(q)?(n(),c("span",xr,[_(s(Ye),{class:"w-3.5 h-3.5"}),g[2]||(g[2]=ue(" Complète ",-1))])):B("",!0)])]),e("div",br,[(n(!0),c(te,null,le(s(l),C=>(n(),c("button",{key:C.position,onClick:G=>s($)(C.position),class:O(["relative aspect-square w-full max-w-none rounded-xl border-2 transition-all duration-200 flex flex-col items-center justify-center overflow-hidden",C.markedForRemoval?"border-red-500 bg-red-50 dark:border-red-500 dark:bg-red-900/30 ring-2 ring-red-400":C.isStamped?"border-yellow-500 bg-yellow-50 hover:bg-yellow-100 dark:border-amber-500 dark:bg-amber-900/30 dark:hover:bg-amber-900/50":"border-gray-300 bg-white hover:bg-gray-50 hover:border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:hover:bg-gray-600 dark:hover:border-gray-500"])},[e("span",{class:O(["text-base font-bold",C.markedForRemoval?"text-red-600 dark:text-red-400 line-through":C.isStamped?"text-yellow-600 dark:text-amber-400":"text-gray-400 dark:text-gray-500"])},v(C.position),3),_(Me,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"scale-0 opacity-0","enter-to-class":"scale-100 opacity-100"},{default:Ie(()=>[C.isStamped?(n(),c("div",{key:0,class:O(["absolute inset-0 flex items-center justify-center",C.markedForRemoval?"bg-red-500/20 dark:bg-red-500/30":"bg-yellow-500/20 dark:bg-amber-500/30"])},[_(s(Ye),{class:O(["w-6 h-6 drop-shadow",C.markedForRemoval?"text-red-600 dark:text-red-400":"text-yellow-600 dark:text-amber-400"])},null,8,["class"])],2)):B("",!0)]),_:2},1024),C.isStamped&&C.date?(n(),c("span",fr,v(b(C.date)),1)):B("",!0)],10,hr))),128))])]))}});function _r(w){const l=w.trim();return l.length<6||l.length>20?!1:/^\d+$/.test(l)}const wr={class:"bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl max-h-[85vh] flex flex-col border border-gray-200 dark:border-gray-700 overflow-hidden",role:"dialog","aria-modal":"true","aria-labelledby":"product-picker-title"},$r={class:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 shrink-0"},Cr={id:"product-picker-title",class:"text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2"},Sr={class:"px-4 py-3 border-b border-gray-100 dark:border-gray-700 shrink-0"},Tr={class:"flex rounded-xl border border-gray-200 dark:border-gray-600 overflow-hidden mb-3"},Pr={class:"relative"},Er={class:"flex-1 overflow-y-auto p-4"},Ir={key:0},Mr={class:"text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3 sticky top-0 bg-white dark:bg-gray-800 py-1"},Nr={class:"space-y-4"},jr={class:"p-3 flex items-center justify-between"},qr={class:"min-w-0 flex-1"},Rr={class:"font-medium text-gray-900 dark:text-white truncate"},Ar={class:"text-xs text-gray-500 dark:text-gray-400 mt-0.5"},Fr={class:"px-3 pb-3 flex flex-wrap gap-2"},Vr=["onClick","disabled"],Dr={class:"text-xs opacity-90"},Lr=["onClick","disabled"],zr={class:"text-xs opacity-90"},Br={key:1,class:"flex flex-col items-center justify-center py-16 text-gray-500 dark:text-gray-400"},Hr=ke({__name:"ProductPickerDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(w,{emit:l}){const x=w,q=l,{physicalProducts:E,loadProducts:$,findByBarcode:A}=De(),{addToCart:Q}=Le(),{vendor:F}=Ne(),o=T(""),i=T("sale"),f=z({get:()=>x.modelValue,set:b=>q("update:modelValue",b)});Ce(f,b=>{if(b){$(),o.value="",i.value="sale";const u=g=>{g.key==="Escape"&&J()};return window.addEventListener("keydown",u),()=>window.removeEventListener("keydown",u)}});const j=z(()=>{const b=o.value.trim().toLowerCase();let u=E.value;return b&&(u=u.filter(g=>g.name.toLowerCase().includes(b)||g.brand?.toLowerCase().includes(b)||g.model?.toLowerCase().includes(b)||g.code?.toLowerCase().includes(b)||g.barcode?.toLowerCase().includes(b))),u}),P=b=>i.value==="technical"?b.stock_technical??0:b.stock,M=z(()=>{const b=new Map;for(const g of j.value){const C=g.brand?.trim()||"Sans marque";b.has(C)||b.set(C,[]),b.get(C).push(g)}const u=[];for(const[g,C]of b){const G=new Map;for(const D of C){const X=`${D.name}|${D.model??""}`;G.has(X)||G.set(X,[]),G.get(X).push(D)}const h=[];for(const[,D]of G){const X=D[0].model?`${D[0].name} ${D[0].model}`:D[0].name;h.push({displayName:X,variants:D.map(oe=>({product:oe,size:oe.size??null,stockSale:oe.stock??0,stockTech:oe.stock_technical??0}))})}h.sort((D,X)=>D.displayName.localeCompare(X.displayName)),u.push({brand:g,models:h})}return u.sort((g,C)=>g.brand.localeCompare(C.brand)),u}),K=b=>{P(b)<=0||Q(b,1,F.value??void 0,i.value)},W=async b=>{if(b.key!=="Enter")return;const u=o.value.trim();if(!u||!_r(u))return;b.preventDefault();const g=await A(u);g&&(K(g),o.value="")},J=()=>{f.value=!1};return(b,u)=>(n(),ye(vt,{to:"body"},[_(Me,{"enter-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition-opacity duration-150","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:Ie(()=>[f.value?(n(),c("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:nt(J,["self"])},[e("div",wr,[e("div",$r,[e("h2",Cr,[_(s(Je),{class:"w-5 h-5 text-gray-500 dark:text-gray-400"}),u[3]||(u[3]=ue(" Ajouter un produit ",-1))]),e("button",{onClick:J,class:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 dark:hover:text-gray-400 dark:hover:bg-gray-700 rounded-lg transition-colors","aria-label":"Fermer"},[_(s(jt),{class:"w-5 h-5"})])]),e("div",Sr,[e("div",Tr,[e("button",{onClick:u[0]||(u[0]=g=>i.value="sale"),class:O(["flex-1 px-4 py-2.5 text-sm font-medium transition-colors flex items-center justify-center gap-2",i.value==="sale"?"bg-emerald-600 text-white":"bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600"])},[_(s(qt),{class:"w-4 h-4"}),u[4]||(u[4]=ue(" Produit de vente ",-1))],2),e("button",{onClick:u[1]||(u[1]=g=>i.value="technical"),class:O(["flex-1 px-4 py-2.5 text-sm font-medium transition-colors flex items-center justify-center gap-2",i.value==="technical"?"bg-blue-600 text-white":"bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600"])},[_(s(Dt),{class:"w-4 h-4"}),u[5]||(u[5]=ue(" Utilisation technique ",-1))],2)]),e("div",Pr,[_(s(Ve),{class:"absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 dark:text-gray-500 pointer-events-none"}),be(e("input",{"onUpdate:modelValue":u[2]||(u[2]=g=>o.value=g),type:"text",placeholder:"Rechercher ou scanner le code-barres...",class:"w-full pl-11 pr-4 py-2.5 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-emerald-500 focus:border-transparent",autofocus:"",onKeydown:W},null,544),[[he,o.value]])])]),e("div",Er,[M.value.length>0?(n(),c("div",Ir,[(n(!0),c(te,null,le(M.value,({brand:g,models:C})=>(n(),c("div",{key:g,class:"mb-6 last:mb-0"},[e("h3",Mr,v(g),1),e("div",Nr,[(n(!0),c(te,null,le(C,G=>(n(),c("div",{key:`${g}-${G.variants[0].product.id}`,class:"rounded-xl border border-gray-200 dark:border-gray-600 overflow-hidden bg-gray-50/50 dark:bg-gray-900/30"},[e("div",jr,[e("div",qr,[e("p",Rr,v(G.displayName),1),e("p",Ar,v(G.variants[0].product.price_ttc?.toFixed(2))+"€ ",1)])]),e("div",Fr,[(n(!0),c(te,null,le(G.variants,h=>(n(),c(te,{key:h.product.id},[h.size?(n(),c("button",{key:0,onClick:D=>K(h.product),disabled:(i.value==="sale"?h.stockSale:h.stockTech)<=0,class:O(["inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors",(i.value==="sale"?h.stockSale:h.stockTech)>0?i.value==="sale"?"bg-emerald-600 text-white hover:bg-emerald-700 dark:bg-emerald-500 dark:hover:bg-emerald-600":"bg-blue-600 text-white hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600":"bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 cursor-not-allowed"])},[e("span",null,v(h.size),1),e("span",Dr,"("+v(i.value==="sale"?h.stockSale:h.stockTech)+")",1)],10,Vr)):(n(),c("button",{key:1,onClick:D=>K(h.product),disabled:(i.value==="sale"?h.stockSale:h.stockTech)<=0,class:O(["inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors",(i.value==="sale"?h.stockSale:h.stockTech)>0?i.value==="sale"?"bg-emerald-600 text-white hover:bg-emerald-700 dark:bg-emerald-500 dark:hover:bg-emerald-600":"bg-blue-600 text-white hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600":"bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 cursor-not-allowed"])},[_(s(et),{class:"w-4 h-4"}),u[6]||(u[6]=e("span",null,"Ajouter",-1)),e("span",zr,"("+v(i.value==="sale"?h.stockSale:h.stockTech)+")",1)],10,Lr))],64))),128))])]))),128))])]))),128))])):(n(),c("div",Br,[_(s(Je),{class:"w-12 h-12 mb-4 opacity-40"}),u[7]||(u[7]=e("p",{class:"text-sm font-medium"},"Aucun produit trouvé",-1)),u[8]||(u[8]=e("p",{class:"text-xs mt-1"},"Modifiez votre recherche",-1))]))])])])):B("",!0)]),_:1})]))}}),Ur={class:"card flex flex-col bg-white dark:bg-gray-800 h-full"},Or={class:"p-4 md:p-6 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 space-y-3"},Kr={class:"flex gap-2"},Gr={class:"relative"},Qr={class:"flex items-center gap-3"},Wr={class:"relative flex-1"},Zr={key:0,class:"text-xs text-red-500 dark:text-red-400 mt-1.5"},Jr={class:"space-y-1"},Yr={class:"flex gap-2"},Xr={class:"relative flex-1"},es=["onKeydown"],ts={key:0,class:"flex items-center gap-1.5 text-xs font-medium text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 px-3 py-1.5 rounded-lg"},as={key:0,class:"text-xs text-red-600 dark:text-red-400"},rs={class:"relative"},ss={class:"relative"},os=["value"],ls={key:0,class:"absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-700 rounded-xl shadow-xl border border-gray-200 dark:border-gray-600 py-2 z-50 max-h-60 md:max-h-80 overflow-y-auto"},ns=["onClick"],is={class:"flex-1 min-w-0"},ds={class:"flex items-center gap-1.5"},cs={class:"text-sm font-medium text-gray-900 dark:text-gray-100 truncate"},us={key:0,class:"inline-flex px-1.5 py-0.5 rounded text-[9px] font-semibold bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300 shrink-0"},ms={class:"flex items-center gap-2 mt-0.5"},ps={class:"text-xs text-gray-500 dark:text-gray-400"},gs={class:"flex items-center gap-2 md:gap-3 ml-2 md:ml-3"},ys={class:"text-sm font-bold text-gray-900 dark:text-gray-100 tabular-nums"},vs={key:0,class:"text-xs text-gray-400 dark:text-gray-500 hidden sm:inline"},xs={class:"flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 dark:bg-gray-800 space-y-4"},bs={key:0,class:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-2.5 md:gap-3.5"},hs={key:1,class:"h-full flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 py-12"},fs=ke({__name:"ServiceGrid",setup(w){const{products:l,searchProducts:x,findByBarcode:q}=De(),{addToCart:E}=Le(),{vendor:$}=Ne(),{selectedClient:A}=je(),{loadClientStamps:Q,clearStamps:F}=Xe(),o=T([]);(async()=>{const{data:t}=await R.from("vendors").select("*").eq("is_active",!0);o.value=t||[]})(),Ce(A,t=>{t?Q(t.id):F()});const f=T(!1),j=T(""),P=T(!1),M=T([]),K=T(""),W=T(""),J=T(""),b=T(""),u=T(null),g=T(""),C=z(()=>{const t=j.value.toLowerCase().trim(),a=l.value.filter(r=>r.type==="service"&&r.is_active!==!1).slice().sort((r,N)=>String(r.code??"").localeCompare(String(N.code??""),void 0,{numeric:!0}));return t?a.filter(r=>r.name.toLowerCase().includes(t)||r.code?.toLowerCase().includes(t)):a});Ce(C,t=>{console.log("Services affichés:",t.length)},{immediate:!0});const G=async t=>{const a=t.target;if(j.value=a.value,a.value.trim().length>=2){const r=await x(a.value);M.value=r||[],P.value=M.value.length>0}else M.value=[],P.value=!1},h=()=>{j.value.trim().length>=2&&M.value.length>0&&(P.value=!0)},D=()=>{setTimeout(()=>{P.value=!1},200)},X=t=>{E(t,1,$.value??void 0,"sale"),j.value="",M.value=[],P.value=!1},oe=t=>{if(t.key==="Enter"&&M.value.length>0){t.preventDefault();const a=M.value[0];a&&E(a,1,$.value??void 0,"sale"),j.value="",M.value=[],P.value=!1}},S=async()=>{const t=J.value.trim();if(!t)return;b.value="",g.value="";const a=await q(t);a?(a.type==="product"&&(a.stock??0)<=0?(b.value="Stock de vente vide pour ce produit",setTimeout(()=>{b.value=""},3e3)):(E(a,1,$.value??void 0),g.value=`${a.name} ajouté au panier`,setTimeout(()=>{g.value=""},2500)),J.value=""):(b.value="Produit non trouvé ou sans code-barres",setTimeout(()=>{b.value=""},3e3)),await bt(),u.value?.focus()};Ce(j,t=>{t.trim().length<2&&(M.value=[],P.value=!1)});const p=t=>{const a=t.trim().toUpperCase();if(a.length<2)return null;const r=a.match(/^([A-Z]+)(\d+.*)$/);if(!r)return null;const N=r[1],re=r[2];return!N||!re?null:{vendorInitials:N,productCode:re}},y=t=>o.value.find(a=>a.initials?.toUpperCase()===t.toUpperCase()),ne=t=>l.value.find(a=>a.code?.toUpperCase()===t.toUpperCase()),ie=t=>{t.key==="Enter"&&(t.preventDefault(),ae())},ae=()=>{W.value="";const t=p(K.value);if(!t){W.value="Format invalide (ex: VL1)";return}const a=y(t.vendorInitials);if(!a){W.value=`Vendeur "${t.vendorInitials}" non trouvé`;return}const r=ne(t.productCode);if(!r){W.value=`Service "${t.productCode}" non trouvé`;return}E(r,1,a),K.value="",W.value=""};return(t,a)=>(n(),c("div",Ur,[e("div",Or,[e("div",Kr,[e("button",{onClick:a[0]||(a[0]=r=>f.value=!0),class:"inline-flex items-center gap-2 px-4 py-2.5 bg-gray-900 dark:bg-emerald-600 dark:hover:bg-emerald-500 text-white rounded-xl font-medium hover:bg-gray-800 transition-colors text-sm"},[_(s(Je),{class:"w-4 h-4"}),a[4]||(a[4]=ue(" Produits ",-1))])]),e("div",Gr,[e("div",Qr,[e("div",Wr,[_(s(Lt),{class:"absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-amber-500 dark:text-amber-400 pointer-events-none z-10"}),be(e("input",{"onUpdate:modelValue":a[1]||(a[1]=r=>K.value=r),onKeydown:ie,type:"text",placeholder:"Raccourci (ex: VL1)",class:"w-full pl-11 pr-4 py-2.5 bg-amber-50 dark:bg-gray-700 dark:border-amber-600/50 dark:text-gray-100 border border-amber-300 rounded-xl text-sm font-mono font-semibold uppercase focus:outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-500/20 dark:focus:border-amber-400 dark:focus:ring-amber-400/30 hover:border-amber-400 transition-all placeholder:normal-case placeholder:font-normal dark:placeholder-gray-400",autocomplete:"off"},null,544),[[he,K.value]])]),e("button",{onClick:ae,class:"px-4 py-2.5 bg-amber-500 dark:bg-amber-600 text-white rounded-xl font-medium hover:bg-amber-600 dark:hover:bg-amber-500 transition-colors text-sm"}," OK ")]),W.value?(n(),c("p",Zr,v(W.value),1)):B("",!0)]),e("div",Jr,[a[5]||(a[5]=e("label",{class:"block text-[10px] md:text-xs text-gray-500 dark:text-gray-400 font-semibold uppercase tracking-wider"},"Scan code-barres",-1)),e("div",Yr,[e("div",Xr,[_(s(At),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 dark:text-gray-500 pointer-events-none"}),be(e("input",{ref_key:"barcodeInputRef",ref:u,"onUpdate:modelValue":a[2]||(a[2]=r=>J.value=r),type:"text",placeholder:"Scannez le code-barres du produit...",class:"w-full pl-10 pr-4 py-2.5 md:py-3 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30",autocomplete:"off",onKeydown:xt(nt(S,["prevent"]),["enter"])},null,40,es),[[he,J.value]])]),e("button",{type:"button",onClick:S,class:"px-4 py-2.5 bg-gray-900 dark:bg-emerald-600 dark:hover:bg-emerald-500 text-white rounded-xl text-sm font-medium hover:bg-gray-800"}," Ajouter ")]),_(Me,{"enter-active-class":"transition ease-out duration-200","enter-from-class":"opacity-0 -translate-y-1","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-150","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 -translate-y-1"},{default:Ie(()=>[g.value?(n(),c("p",ts,[_(s(It),{class:"w-3.5 h-3.5 shrink-0"}),ue(" "+v(g.value),1)])):B("",!0)]),_:1}),b.value?(n(),c("p",as,v(b.value),1)):B("",!0)]),e("div",rs,[e("div",ss,[_(s(Ve),{class:"absolute left-4 md:left-5 top-1/2 -translate-y-1/2 w-4 h-4 md:w-5 md:h-5 text-gray-400 dark:text-gray-500 pointer-events-none z-10"}),e("input",{value:j.value,onInput:G,onFocus:h,onBlur:D,onKeydown:oe,type:"text",placeholder:"Rechercher un produit...",class:"w-full pl-11 md:pl-14 pr-4 md:pr-5 py-3 md:py-3.5 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all",autocomplete:"off"},null,40,os)]),_(Me,{"enter-active-class":"transition ease-out duration-100","enter-from-class":"opacity-0 translate-y-1","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-75","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-1"},{default:Ie(()=>[P.value&&M.value.length>0?(n(),c("div",ls,[(n(!0),c(te,null,le(M.value,r=>(n(),c("button",{key:r.id,onClick:N=>X(r),class:"w-full px-4 md:px-5 py-2.5 md:py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors flex items-center justify-between"},[e("div",is,[e("div",ds,[e("p",cs,v(r.name),1),r.type==="product"?(n(),c("span",us,"PRODUIT")):B("",!0)]),e("div",ms,[e("p",ps,v(r.code),1),r.type==="product"?(n(),c("span",{key:0,class:O(["text-[10px] tabular-nums",(r.stock??0)>0?"text-emerald-600 dark:text-emerald-400":"text-red-500 dark:text-red-400"])}," Stock : "+v(r.stock??0),3)):B("",!0)])]),e("div",gs,[e("span",ys,v(r.price_ttc?.toFixed(2))+"€",1),r.duration?(n(),c("span",vs,v(r.duration)+"min",1)):B("",!0)])],8,ns))),128))])):B("",!0)]),_:1})])]),e("div",xs,[C.value.length>0?(n(),c("div",bs,[(n(!0),c(te,null,le(C.value,r=>(n(),ye(ir,{key:r.id,service:r},null,8,["service"]))),128))])):(n(),c("div",hs,[_(s(Ve),{class:"w-10 h-10 md:w-14 md:h-14 mb-4 opacity-40"}),a[6]||(a[6]=e("p",{class:"text-sm md:text-base font-medium text-gray-500 dark:text-gray-400"},"Aucun service trouvé",-1)),a[7]||(a[7]=e("p",{class:"text-xs md:text-sm text-gray-400 dark:text-gray-500 mt-1.5"},"Modifiez votre recherche",-1))])),s(A)?(n(),ye(kr,{key:2})):B("",!0)]),_(Hr,{modelValue:f.value,"onUpdate:modelValue":a[3]||(a[3]=r=>f.value=r)},null,8,["modelValue"])]))}}),V=T({id:"",firstName:"",lastName:"",phone:"",phone2:"",email:"",address:"",city:"",postalCode:"",birthDate:"",notes:"",company:""}),Ee=T(!1);function ks(){const{createClient:w,updateClient:l,selectClient:x}=je(),q=z(()=>!!(V.value.firstName.trim()||V.value.lastName.trim()||V.value.phone.trim())),E=()=>{V.value={id:"",firstName:"",lastName:"",phone:"",phone2:"",email:"",address:"",city:"",postalCode:"",birthDate:"",notes:"",company:""},Ee.value=!1,x(null)};return{currentClient:V,isEditMode:Ee,hasClientInfo:q,clearClient:E,loadClient:F=>{V.value={...F},Ee.value=!0},newClient:()=>{E()},saveClient:async()=>{if(!q.value)return{success:!1,isNew:!1,message:"Veuillez remplir au moins un champ (nom, prénom ou téléphone)"};if(!V.value.phone.trim())return{success:!1,isNew:!1,message:"Le numéro de téléphone est obligatoire"};try{const F={first_name:V.value.firstName,last_name:V.value.lastName,phone:V.value.phone,phone2:V.value.phone2||null,email:V.value.email||null,address:V.value.address||null,city:V.value.city||null,postal_code:V.value.postalCode||null,birth_date:V.value.birthDate||null,notes:V.value.notes||null,company:V.value.company?.trim()||null};if(Ee.value&&V.value.id){console.log("Mise à jour du client:",F);const o=await l(V.value.id,F);return o?(x(o),{success:!0,isNew:!1,message:`Client ${V.value.firstName} ${V.value.lastName} mis à jour`}):{success:!1,isNew:!1,message:"Erreur lors de la mise à jour"}}else{console.log("Création du client:",F);const o=await w(F);return o?(V.value.id=o.id,Ee.value=!0,x(o),{success:!0,isNew:!0,message:`Client ${V.value.firstName} ${V.value.lastName} créé`}):{success:!1,isNew:!1,message:"Erreur lors de la création"}}}catch(F){return console.error("Erreur lors de l'enregistrement du client:",F),{success:!1,isNew:!1,message:"Erreur lors de l'enregistrement"}}}}}const _s={class:"card h-full flex flex-col overflow-hidden"},ws={class:"p-4 md:p-6 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"},$s={class:"flex items-center justify-between mb-3 md:mb-4"},Cs={class:"relative"},Ss={key:0,class:"absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-700 rounded-xl shadow-xl border border-gray-200 dark:border-gray-600 py-2 z-50"},Ts=["onClick"],Ps={class:"text-xs md:text-sm font-medium text-gray-900 dark:text-gray-100"},Es={class:"text-[10px] md:text-xs text-gray-500 dark:text-gray-400 mt-0.5"},Is={class:"flex-1 overflow-y-auto p-4 md:p-6 min-h-0 space-y-4 md:space-y-5 bg-gray-50 dark:bg-gray-800"},Ms={class:"grid grid-cols-2 gap-3 md:gap-4"},Ns={class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider"},js=["value","type","placeholder","maxlength","inputmode","autocomplete","onInput"],qs={class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider"},Rs=["value","type","placeholder","onInput"],As={key:0,class:"col-span-2 flex items-center gap-3 p-3 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl"},Fs=["checked"],Vs={class:"col-span-2 space-y-1.5 md:space-y-2"},Ds={class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider flex items-center gap-1.5 md:gap-2"},Ls={class:"grid grid-cols-2 gap-3 md:gap-4"},zs={class:"space-y-1.5 md:space-y-2"},Bs={class:"space-y-1.5 md:space-y-2"},Hs=["value","maxlength"],Us={class:"space-y-1.5 md:space-y-2"},Os={class:"p-4 md:p-6 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"},Ks={class:"grid grid-cols-3 gap-2 md:gap-3"},Gs=["disabled"],Qs=["disabled"],Ws=["disabled"],Zs={class:"hidden sm:inline"},Js=ke({__name:"ClientPanel",setup(w){const{currentClient:l,isEditMode:x,clearClient:q,loadClient:E,hasClientInfo:$,saveClient:A}=ks(),{searchClients:Q,selectClient:F,clearSelection:o,selectedClient:i,invoiceInCompanyName:f,setInvoiceInCompanyName:j}=je(),P=T(""),M=T([]),K=T(!1);let W=null;Ce(P,S=>{if(W&&clearTimeout(W),S.trim().length<2){M.value=[];return}W=window.setTimeout(async()=>{K.value=!0;try{const p=await Q(S);M.value=p}catch(p){console.error("Erreur recherche clients:",p),M.value=[]}finally{K.value=!1}},300)});const J=z(()=>P.value.trim().length>=2&&M.value.length>0),b=async()=>{const S=await A();S.success,alert(S.message)},u=()=>{q(),P.value="",o()},g=()=>{alert("Historique client à implémenter")},C=S=>{F(S),j(!1);const p={id:S.id,firstName:S.first_name,lastName:S.last_name,phone:He(S.phone||""),phone2:He(S.phone2||""),email:S.email||"",address:S.address||"",city:S.city||"",postalCode:st(S.postal_code||""),birthDate:S.birth_date||"",notes:S.notes||"",company:S.company||""};E(p),P.value=`${p.firstName} ${p.lastName}`,M.value=[]},G=S=>{const p=M.value[0];S.key==="Enter"&&p&&(S.preventDefault(),C(p))},h=[{key:"lastName",label:"Nom",type:"text",placeholder:"Dupont",span:1,format:null},{key:"firstName",label:"Prénom",type:"text",placeholder:"Jean",span:1,format:null},{key:"phone",label:"Tél. 1",type:"tel",placeholder:"06 12 34 56 78",span:1,format:"phone"},{key:"phone2",label:"Tél. 2",type:"tel",placeholder:"01 23 45 67 89",span:1,format:"phone"},{key:"email",label:"Email",type:"email",placeholder:"jean@email.com",span:2,format:null},{key:"birthDate",label:"Anniversaire",type:"date",placeholder:"",span:2,format:null},{key:"company",label:"Entreprise",type:"text",placeholder:"Nom de l'entreprise (optionnel)",span:2,format:null}];function D(S,p,y){const ne=y==="phone"?He(p):p;l.value[S]=ne}function X(S,p){l.value[S]=p}function oe(S){l.value.postalCode=st(S)}return(S,p)=>(n(),c("div",_s,[e("div",ws,[e("div",$s,[p[6]||(p[6]=e("h2",{class:"text-xs md:text-sm font-semibold text-gray-900 dark:text-gray-100 uppercase tracking-wider"},"Client",-1)),s($)?(n(),c("div",{key:0,class:O(["inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] md:text-xs font-semibold transition-colors",s(x)?"bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300":"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300"])},[(n(),ye(Fe(s(x)?s(Ft):s(at)),{class:"w-3 h-3"})),e("span",null,v(s(x)?"Modification":"Nouveau"),1)],2)):B("",!0)]),e("div",Cs,[_(s(Ve),{class:"absolute left-4 md:left-5 top-1/2 -translate-y-1/2 w-4 h-4 md:w-5 md:h-5 text-gray-400 dark:text-gray-500 pointer-events-none z-10"}),be(e("input",{"onUpdate:modelValue":p[0]||(p[0]=y=>P.value=y),onKeydown:G,type:"text",placeholder:"Rechercher un client...",class:"w-full pl-11 md:pl-14 pr-4 md:pr-5 py-3 md:py-3.5 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all",autocomplete:"off"},null,544),[[he,P.value]]),_(Me,{"enter-active-class":"transition ease-out duration-100","enter-from-class":"opacity-0 translate-y-1","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-75","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-1"},{default:Ie(()=>[J.value?(n(),c("div",Ss,[(n(!0),c(te,null,le(M.value,y=>(n(),c("button",{key:y.id,onClick:ne=>C(y),class:"w-full px-4 md:px-5 py-2.5 md:py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors"},[e("p",Ps,v(y.first_name)+" "+v(y.last_name),1),e("p",Es,v(y.phone),1)],8,Ts))),128))])):B("",!0)]),_:1})])]),e("div",Is,[e("div",Ms,[(n(!0),c(te,null,le(h.filter(y=>y.span!==2),y=>(n(),c("div",{key:y.key,class:"space-y-1.5 md:space-y-2"},[e("label",Ns,v(y.label),1),e("input",{value:s(l)[y.key],type:y.type,placeholder:y.placeholder,maxlength:y.format==="phone"?s(rt).phone:void 0,inputmode:y.format==="phone"?"numeric":void 0,autocomplete:y.format==="phone"?"tel":void 0,class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all",onInput:ne=>D(y.key,ne.target.value,y.format)},null,40,js)]))),128)),(n(!0),c(te,null,le(h.filter(y=>y.span===2),y=>(n(),c("div",{key:y.key,class:"col-span-2 space-y-1.5 md:space-y-2"},[e("label",qs,v(y.label),1),e("input",{value:s(l)[y.key],type:y.type,placeholder:y.placeholder,class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all",onInput:ne=>y.format?D(y.key,ne.target.value,y.format):X(y.key,ne.target.value)},null,40,Rs)]))),128))]),s(i)?(n(),c("div",As,[e("input",{id:"cb-invoice-company",type:"checkbox",checked:s(f),onChange:p[1]||(p[1]=y=>s(j)(y.target.checked)),class:"w-4 h-4 rounded border-gray-300 dark:border-gray-500 text-gray-900 dark:bg-gray-600 focus:ring-gray-900 dark:focus:ring-emerald-500"},null,40,Fs),p[7]||(p[7]=e("label",{for:"cb-invoice-company",class:"text-xs md:text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer"}," Facture au nom de l'entreprise ",-1))])):B("",!0),e("div",Vs,[e("label",Ds,[_(s(kt),{class:"w-3 h-3 md:w-3.5 md:h-3.5"}),p[8]||(p[8]=e("span",null,"Adresse",-1))]),be(e("input",{"onUpdate:modelValue":p[2]||(p[2]=y=>s(l).address=y),type:"text",placeholder:"123 Rue de la Paix",class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all"},null,512),[[he,s(l).address]])]),e("div",Ls,[e("div",zs,[p[9]||(p[9]=e("label",{class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider"}," Ville ",-1)),be(e("input",{"onUpdate:modelValue":p[3]||(p[3]=y=>s(l).city=y),type:"text",placeholder:"Paris",class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all"},null,512),[[he,s(l).city]])]),e("div",Bs,[p[10]||(p[10]=e("label",{class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider"}," CP ",-1)),e("input",{value:s(l).postalCode,type:"text",inputmode:"numeric",maxlength:s(rt).postalCode,placeholder:"75001",class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all",onInput:p[4]||(p[4]=y=>oe(y.target.value))},null,40,Hs)])]),e("div",Us,[p[11]||(p[11]=e("label",{class:"block text-[10px] md:text-xs text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider"}," Notes ",-1)),be(e("textarea",{"onUpdate:modelValue":p[5]||(p[5]=y=>s(l).notes=y),placeholder:"Commentaires, préférences...",rows:"2",class:"w-full px-3 md:px-4 py-2.5 md:py-3 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400 border border-gray-300 rounded-xl text-xs md:text-sm font-medium focus:outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 dark:focus:border-emerald-500 dark:focus:ring-emerald-500/30 hover:border-gray-400 transition-all resize-none"},null,512),[[he,s(l).notes]])])]),e("div",Os,[e("div",Ks,[e("button",{onClick:g,disabled:!s(x),class:"btn-secondary text-[10px] md:text-xs px-2 md:px-4 py-2.5 md:py-3"},[_(s(ht),{class:"w-3.5 h-3.5 md:w-4 md:h-4"}),p[12]||(p[12]=e("span",{class:"hidden sm:inline"},"Historique",-1))],8,Gs),e("button",{onClick:u,disabled:!s($),class:O(["inline-flex items-center justify-center gap-1 md:gap-2 px-2 md:px-4 py-2.5 md:py-3 text-[10px] md:text-xs font-medium rounded-xl transition-all duration-200",s($)?"bg-white border border-gray-300 text-red-600 hover:bg-red-50 hover:border-red-200 dark:bg-gray-700 dark:border-gray-600 dark:text-red-400 dark:hover:bg-red-900/30 dark:hover:border-red-800":"bg-gray-100 text-gray-400 cursor-not-allowed border border-gray-200 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-500"])},[_(s(ct),{class:"w-3.5 h-3.5 md:w-4 md:h-4"}),p[13]||(p[13]=e("span",{class:"hidden sm:inline"},"Effacer",-1))],10,Qs),e("button",{onClick:b,disabled:!s($),class:O(["btn-primary text-[10px] md:text-xs px-2 md:px-4 py-2.5 md:py-3",s(x)?"bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-500":"bg-emerald-600 hover:bg-emerald-700 dark:bg-emerald-600 dark:hover:bg-emerald-500"])},[(n(),ye(Fe(s(x)?s($t):s(at)),{class:"w-3.5 h-3.5 md:w-4 md:h-4"})),e("span",Zs,v(s(x)?"Modifier":"Créer"),1)],10,Ws)])])]))}}),Ys={class:"flex-1 flex flex-col lg:flex-row gap-4 p-4 lg:gap-6 lg:p-6 pb-20 lg:pb-6"},Xs={class:"lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg z-50"},eo={class:"flex"},to=["onClick"],ao={class:"text-xs font-medium"},fo=ke({__name:"CaissePage",setup(w){const l=T("services"),x=[{id:"services",label:"Services",icon:ft},{id:"ticket",label:"Ticket",icon:Rt},{id:"client",label:"Client",icon:Vt}];return(q,E)=>(n(),c(te,null,[e("main",Ys,[e("aside",{class:O(["lg:w-80 lg:flex-shrink-0",l.value==="ticket"?"block":"hidden lg:block"])},[_(Wa)],2),e("section",{class:O(["flex-1 min-w-0",l.value==="services"?"block":"hidden lg:block"])},[_(fs)],2),e("aside",{class:O(["lg:w-80 xl:w-96 lg:flex-shrink-0",l.value==="client"?"block":"hidden lg:block"])},[_(Js)],2)]),e("nav",Xs,[e("div",eo,[(n(),c(te,null,le(x,$=>e("button",{key:$.id,onClick:A=>l.value=$.id,class:O(["flex-1 flex flex-col items-center justify-center py-3 transition-colors",l.value===$.id?"text-gray-900 bg-gray-100 dark:text-gray-100 dark:bg-gray-700":"text-gray-500 hover:text-gray-700 hover:bg-gray-50 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:bg-gray-700/70"])},[(n(),ye(Fe($.icon),{class:"w-5 h-5 mb-1"})),e("span",ao,v($.label),1)],10,to)),64))])])],64))}});export{fo as default};
